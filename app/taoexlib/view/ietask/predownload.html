<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<div class="tableform">
    <div class="division">
        <table border="0" cellspacing="0" cellpadding="0" >
            <tbody>
            <tr>
                <td><{$export_agreement}><br></td>
            </tr>
            <tr>
                <td>
                    <input type="checkbox" name="agreement[]" id="agreement" value="1"> 同意
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <div class="division">
        <form method="post" action="index.php?app=taoexlib&ctl=ietask&act=checkDownload" id="frm">
            <table border="0" cellspacing="0" cellpadding="0" >
                <tbody>
                    <tr>
                        <td><label for="verifycode"><{t}>验证码：<{/t}></label><input maxlength="4" autocomplete="off" class="inputstyle-short-out" name="verifycode" id="verifycode" value=""  />
     <img id="shopadminvocde" src="index.php?app=desktop&ctl=passport&act=gen_vcode&<{$smarty.now}>" align="top" class="verifycodeimg"><a href="javascript:changeimg('shopadminvocode')">&nbsp;<{t}>看不清楚?换个图片<{/t}></a></td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
</div>
<{area inject=".mainFoot"}>
<div class="table-action">
    <table width="100%" cellspacing="0" cellpadding="0">
        <tbody>
            <tr>
                <td>
                    <{button type="button" id='submit_btn' label='保存' }>
                    <{button type="button" id='close_btn' label='关闭' }>
                </td>
            </tr>
        </tbody>
    </table>
</div>
<{/area}>
<script type="text/javascript">

    (function(){
        var agree = $('agreement');

        var _form = $('frm');//表单ID 
        var btn   = $('submit_btn');//按钮ID
        var finder = finderGroup['<{$env.get.finder_id}>'];
        $('close_btn').addEvent('click', function(){
            try{
                var _dialogIns = this.getParent('.dialog').retrieve('instance');
            }catch(e){}

            if(_dialogIns){
                setTimeout(finder.refresh(),30000);
                _dialogIns.close();
            }
        });
        _form.store('target',{
            onRequest:function(){
                btn.setAttribute('disabled', 'disabled');
            },
            onComplete:function(){
                btn.removeAttribute('disabled');
            },
            onSuccess:function(response){
                var hash_res_obj = JSON.decode(response);
                if (hash_res_obj.success != undefined && hash_res_obj.success != ""){
                    window.open('<{$durl}>');
                    try{
                        var _dialogIns = btn.getParent('.dialog').retrieve('instance');
                    }catch(e){}

                    if(_dialogIns){
                        setTimeout(finder.refresh(),30000);
                        _dialogIns.close();
                    }
                } else {
                    changeimg('shopadminvocode');
                }
            }
        });

        btn.addEvent('click',function(){
            if (!agree.checked) {
                alert('请勾选同意按钮！');
            }else{
                _form.fireEvent('submit',{stop:$empty});
            }
        });
        changeimg = function(id){
            var timestamp = Date.parse(new Date());
            document.getElementById('shopadminvocde').src='index.php?app=desktop&ctl=passport&act=gen_vcode#'+timestamp;

        }
    })();
</script>