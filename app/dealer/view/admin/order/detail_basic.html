<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<{if $order.process_status neq 'is_retrial'}>
    <{if !in_array($order.ship_status, array('1','3','4')) && $order.pay_status=='1' && $order.process_status != 'cancel'}>
    <{include file="admin/order/order_button.html"}>
    <{/if}>
<{/if}>

<table width="100%" cellspacing="0" cellpadding="0" border="0">
  <tbody>
    <tr>
      <td >
        <div class="tableform">
        <form method='post' action='index.php?app=dealer&ctl=admin_platform_orders&act=dosave&finder_vid=<{$env.get.finder_vid}>&finder_id=<{$env.get.finder_id}>' id="orderItemForm">
        <input type="hidden" value="<{$order.plat_order_id}>" name="order_id"/>
        <input type="hidden" name="is_flag" value="1">
          <table cellspacing="0" cellpadding="0" border="0" class="orderdetails_basic">
            <tbody>
              <tr>
                <td style="vertical-align:top;">
                  <h4>物料价格</h4>
                  <div class="division">
                    <table cellspacing="0" cellpadding="0"  border="0">
                      <tbody>
                        <tr>
                          <th >物料总额：</th>
                          <td><{$order.cost_item|cur}></td>
                        </tr>
                        <tr>
                          <th >配送费用：</th>
                          <td><{$order.cost_freight|cur}></td>
                        </tr>
                        <tr>
                          <th >商品促销优惠：</th>
                          <td><{$order.pmt_goods|cur}></td>
                        </tr>
                        <tr>
                          <th >订单促销优惠：</th>
                          <td><{$order.pmt_order|cur}></td>
                        </tr>
                        <tr>
                          <th >订单总额：</th>
                          <td><span style="font-weight: bold; font-size: 14px;"><{$order.total_amount|cur}></span></td>
                        </tr>
                        <tr>
                          <th >已支付金额：</th>
                          <td><span class="amount"><{$order.payed|cur}></span></td>
                        </tr>
                      </tbody>
                    </table>
                    </div>
                  </td>
                  <td style="vertical-align:top;">
                    <h4>订单其他信息</h4>
                    <div class="division">
                       <table cellspacing="0" cellpadding="0" border="0">
                         <tbody>
                         <tr>
                           <th >支付方式：</th>
                           <td><{$order.payment}></td>
                         </tr>
                         <tr>
                           <th >商品重量：</th>
                           <td><{if $order.weight}><{$order.weight}><{else}>0.00<{/if}> g</td>
                         </tr>
                         <tr>
                           <th >配送方式：</th>
                           <td><{$order.shipping_name}></td>
                         </tr>
                        </tbody>
                     </table>
                 </div>
               </td>
               <td style="vertical-align:top;">
                <h4><{if $member.is_encrypt}><a class="member-sensitive-btn data-hide" href="javascript:void(0);"></a><{/if}>购买人信息</h4>
                <div class="division">
                  <table cellspacing="0" cellpadding="0" border="0" id="memberinfo">
                    <tbody><tr>
                      <th><{if $member.is_encrypt && $order.shop_type == 'pinduoduo'}><a data-type = 'uname' class="member-sensitive-btn-detail data-hide" style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>用户名：</th>
                      <td>
                        <span sensitive-field="uname"><{$member.account.uname|ciphertext:'member','uname',$order.shop_type}></span></td>
                      </tr>
                      <tr>
                        <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'name' class="member-sensitive-btn-detail data-hide"  style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>姓名：</th>
                        <td><span sensitive-field="name"><{$member.contact.name|ciphertext:'member','name',$order.shop_type}></span></td>
                      </tr>
                      <tr>
                        <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'mobile' class="member-sensitive-btn-detail data-hide" style="background-size: 13px 10px;"  href="javascript:void(0);"></a><{/if}>手机：</th>
                        <td><span sensitive-field="mobile"><{$member.contact.phone.mobile|ciphertext:'member','mobile',$order.shop_type}></span></td>
                      </tr>
                      <tr>
                        <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'tel' class="member-sensitive-btn-detail data-hide"  style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>电话：</th>
                        <td><span sensitive-field="tel"><{$member.contact.phone.telephone|ciphertext:'member','tel',$order.shop_type}></span></td>
                      </tr>
                      <tr>
                        <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'address' class="member-sensitive-btn-detail data-hide" style="background-size: 13px 10px;"  href="javascript:void(0);"></a><{/if}>地区：</th>
                        <td><{$member.contact.area|region}></td>
                      </tr>
                  </tbody>
              </table>
            </div>
          </td>
          <td style="vertical-align:top;">
            <h4>
              <span><{if $order.is_encrypt}><a class="order-sensitive-btn data-hide" href="javascript:void(0);"></a><{/if}><{t}>收货人信息<{/t}></span>
            </h4>
              <div class="division">
                <table cellspacing="0" cellpadding="0" border="0" id="consigneeinfo">
                  <tbody>
                  <tr>
                    <th ><{if $member.is_encrypt && $order.shop_type == 'pinduoduo'}><a data-type = 'uname' class="order-sensitive-btn-detail data-hide" style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>姓名：</th>
                    <td><span sensitive-field="ship_name" data-order="2"><{$order.ship_name|ciphertext:'order','ship_name',$order.shop_type}></span></td>
                  </tr>
                  <tr>
                    <th><{if $member.is_encrypt && $order.shop_type == 'pinduoduo'}><a data-type = 'mobile' class="order-sensitive-btn-detail data-hide" style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>手机：</th>
                    <td><span sensitive-field="ship_mobile" data-order="4"><{$order.ship_mobile|ciphertext:'order','ship_mobile',$order.shop_type}></span></td>
                  </tr>
                  <tr>
                    <th><{if $member.is_encrypt && $order.shop_type == 'pinduoduo'}><a data-type = 'tel' class="order-sensitive-btn-detail data-hide" style="background-size: 13px 10px;" href="javascript:void(0);"></a><{/if}>电话：</th>
                    <td><span sensitive-field="ship_tel" data-order="3"><{$order.ship_tel|ciphertext:'order','ship_tel',$order.shop_type}></span></td>
                  </tr>
                  <tr>
                    <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'address' class="order-sensitive-btn-detail data-hide" style="background-size: 13px 10px;"  href="javascript:void(0);"></a><{/if}>地区：</th>
                    <td><{$order.ship_area|region}></td>
                  </tr>
                  <tr>
                    <th><{if $member.is_encrypt  && $order.shop_type == 'pinduoduo'}><a data-type = 'receiver_address' class="order-sensitive-btn-detail data-hide" style="background-size: 13px 10px;"  href="javascript:void(0);"></a><{/if}>地址：</th>
                    <td style="white-space: normal; line-height: 18px;"><span sensitive-field="ship_addr" data-order="1"><{$order.ship_addr|escape:'html'|ciphertext:'order','ship_addr',$order.shop_type}></span></td>
                  </tr>
                  <tr style="display: none;">
                    <th >邮编：</th>
                    <td><{$order.ship_zip|escape:'html'}></td>
                  </tr>
                  <tr style="display: none;">
                    <th >要求到货时间：</th>
                    <td><{$order.ship_time}></td>
                  </tr>
                </tbody></table>
              </div>
            </td>
          </tr>
        </tbody>
        </table>
        
        <{if $order.is_fail == 'true' && $order.status != 'dead'}>
        <{foreach from=$order.order_objects item=obj key=obj_type}>
        <{if $obj.obj_fail == 1 || $obj.obj_item_fail == 1}>
        <div class="division">
            <table width="100%" class="gridlist" border="0" cellspacing="0" cellpadding="0">
                <thead>
                    <tr>
                        <th><{t}>销售物料编码<{/t}></th>
                        <th><{t}>销售物料名称<{/t}></th>
                        <th><{t}>购买量<{/t}></th>
                        <th><{t}>调整货号<{/t}></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <{$obj.bn}>
                            <input type="hidden" name="oldPbn[<{$obj.plat_obj_id}>]" value="<{$obj.bn}>" />
                            <input type="hidden" name="oldName[<{$obj.plat_obj_id}>]" value="<{$obj.name}>" />
                        </td>
                        <td><{$obj.name}></td>
                        <td><{$obj.quantity}></td>
                        <td>
                            <{if $obj.obj_fail == 1}>
                                <input type="text" size="10" name="pbn[<{$obj.plat_obj_id}>]" value="" />
                            <{elseif $obj.obj_item_fail == 1}>
                                <input type="text" size="10" name="pbn[<{$obj.plat_obj_id}>]" value="" />
                            <{/if}>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <{/if}>
        <{/foreach}>
        
        <div class="table-action">
            <{button type="button" id="editsubmit" label="修改提交"}>
            <{button type="button" id="batchsubmit" label="批量按货号修改"}>
            <span style='color:#999999;'>调整完的货号通批量修改，可以更新全部订单包含的此货号</span>
        </div>
        <{/if}>
      </form>
      </div>
    </td>
  </tr>
</tbody>
</table>
<script>
(function(){
    // 敏感数据处理
    if ($defined($E('.order-sensitive-btn')))
        $E('.order-sensitive-btn').addEvent('click',function(e){
            Ex_Loader('security',function(){
                new Security({url:'index.php?app=ome&ctl=admin_order&act=showSensitiveData&p[0]=<{$order.plat_order_id}>',clickElement:$(e.target)}).desHtml($E('#consigneeinfo'));
            });
        });

    // 敏感数据处理
    if ($defined($E('.member-sensitive-btn')))
        $E('.member-sensitive-btn').addEvent('click',function(e){
            Ex_Loader('security',function(){
                new Security({url:'index.php?app=ome&ctl=admin_member&act=showSensitiveData&p[0]=<{$order.plat_order_id}>',clickElement:$(e.target)}).desHtml($E('#memberinfo '));
            });
        });

    //敏感数据处理 拼多多
    if ($defined($E('.order-sensitive-btn-detail')))
      $ES('.order-sensitive-btn-detail').addEvent('click',function(e){
          var type = this.get('data-type');
          console.log('type',type)
          var tr = this.getParent('tr');
          Ex_Loader('security',function(){
              new Security({url:'index.php?app=ome&ctl=admin_order&act=showSensitiveData&p[0]=<{$order.plat_order_id}>&p[1]='+type,clickElement:$(e.target)}).desHtml(tr);
          });
      });

    //敏感数据处理 拼多多
    if ($defined($E('.member-sensitive-btn-detail')))
      $ES('.member-sensitive-btn-detail').addEvent('click',function(e){
          var type = this.get('data-type');
          var tr = this.getParent('tr');
          Ex_Loader('security',function(){
              new Security({url:'index.php?app=ome&ctl=admin_member&act=showSensitiveData&p[0]=<{$order.plat_order_id}>&p[1]='+type,clickElement:$(e.target)}).desHtml(tr);
          });
      });
    
    function valid(){
        var pbns = $$('[name^=pbn[]');
        for(var i=0,l=pbns.length; i<l; i++){
            for (var j=i+1,k=pbns.length; j<k; j++){
                if( pbns[j].value==pbns[i].value ){
                    if(confirm('订单存在相同的商品，是否继续？')) return true;
                    return false;
                }
            }
        }
        
        return true;
    }
    
    var itemForm = $('orderItemForm');
    $('editsubmit').addEvent('click',function(){
        //if(!valid()) return;
        itemForm.action = 'index.php?app=dealer&ctl=admin_platform_orders&act=dosave&finder_vid=<{$env.get.finder_vid}>&finder_id=<{$env.get.finder_id}>';
        itemForm.fireEvent('submit',{stop:function(){}});
    });
    
    $('batchsubmit').addEvent('click',function(){
        //if(!valid()) return;
        itemForm.action = 'index.php?app=dealer&ctl=admin_platform_orders&act=batchsave&finder_vid=<{$env.get.finder_vid}>&finder_id=<{$env.get.finder_id}>';
        itemForm.fireEvent('submit',{stop:function(){}});
    });
})();

$('orderItemForm').store('target',{
    onRequest:function(e){
        $('editsubmit').set('disabled', 'true');
        $('batchsubmit').set('disabled', 'true');
        
        $('editsubmit').getElements('span')[1].set('text','正在处理');
    },
    onComplete:function(jsontext){
       var json = Json.evaluate(jsontext);
       if (typeof(json.error) == 'undefined'){
           $('editsubmit').set('disabled', 'true');
           $('batchsubmit').set('disabled', 'true');
           
           $('editsubmit').getElements('span')[1].set('text','正在处理');
       }else{
           $('editsubmit').set('disabled', '');
           $('batchsubmit').set('disabled', '');
           
           $('editsubmit').getElements('span')[1].set('text','修改提交');
       }
    }
});
</script>
