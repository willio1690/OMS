<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<{capture name="header"}>
<{css app="ome" src="ome.css"}>
<{css app="ome" src="style.css"}>
<{script src="coms/modedialog.js" app="desktop"}>
<{script src="coms/autocompleter.js" app="desktop"}>
<{script src="coms/pager.js" app="desktop"}>
<{/capture}>
<style>
    .notice-inline.error  {background-image:none;margin-left:25px}
    .luckybag_hr {height:12px;margin-top:10px}
    .luckybag_title {height:30px;line-height:30px}
    .luckybag_title_name {float:left}
    .luckybag_title_del {float:left;cursor:pointer;color:blue;margin-left:6px}
    .luckybag_title_material {float:right}
    .luckybag_table {margin:4px 0;}
    .luckybag_table_operation_th {width:50px;}
    .luckybag_rule {height:30px}
    #hand-selected-product {
        padding-left: 20px;
    }
    .object-select {
        width: auto!important;
    }
    #body .workground {
        width: 100%!important;
    }
    .content-main {
        width: 100%!important;
    }
</style>
<link href="../../../../app/desktop/statics/perfect/main.css" rel="stylesheet" type="text/css">
<div class="form-layout">
    <form method="post" id="sales_material_form" action="index.php?app=material&ctl=admin_material_sales&act=toEdit">
        <input type="hidden" name="sm_id" value="<{$material_info.sm_id}>">
        <div class="form-layout-block">
            <h3>编辑销售物料基本信息</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <span class="form-field-label">销售物料名称：</span>
                    <input class="form-input" placeholder="请输入物料名称" type="text" name="sales_material_name" vtype="required" value="<{$material_info.sales_material_name}>" /><span style="color:red;">*</span>
                </div>
                <div class="form-field">
                    <span class="form-field-label">销售物料编码：</span>
                    <{$material_info.sales_material_bn}>
                    <input class="form-input" placeholder="请输入物料编码" type="hidden" name="sales_material_bn" vtype="required" value="<{$material_info.sales_material_bn}>" onkeyup="value=value.replace(/[^A-Za-z0-9_-\/]/ig,'')" /><span style="color:red;">*</span>
                </div>
                <div class="form-field">
                    <span class="form-field-label">物料类型：</span>
                    <{if $readonly.type == true}>
                        <{if $material_info.sales_material_type == 1}>普通
                        <{elseif $material_info.sales_material_type ==2}>组合
                        <{elseif $material_info.sales_material_type ==3}>赠品
                        <{elseif $material_info.sales_material_type ==4}>福袋
                        <{elseif $material_info.sales_material_type ==5}>多选一
                        <{elseif $material_info.sales_material_type ==6}>礼盒
                        <{elseif $material_info.sales_material_type == 7}>福袋组合
                        <{/if}>
                        <input type="hidden" name="sales_material_type" value="<{$material_info.sales_material_type}>">&nbsp;&nbsp;<span style="color:red;">(已有关联订单或店铺冻结不能修改)</span>
                    <{else}>
                        <div class="form-radios">
                            <input id="type1" type="radio" name="sales_material_type" value="1" <{if $material_info.sales_material_type == 1}>checked="checked"<{/if}> />
                            <label for="type1">普通</label>
                            <input id="type2" type="radio" name="sales_material_type" value="2" <{if $material_info.sales_material_type == 2}>checked="checked"<{/if}> />
                            <label for="type2">组合</label>
                            <input id="type3" type="radio" name="sales_material_type" value="3" <{if $material_info.sales_material_type == 3}>checked="checked"<{/if}> />
                            <label for="type3">赠品</label>
                            <!-- <input id="type4" type="radio" name="sales_material_type" value="4" <{if $material_info.sales_material_type == 4}>checked="checked"<{/if}> />-->
                            <!-- <label for="type4">福袋</label>-->
                            <input id="type5" type="radio" name="sales_material_type" value="5" <{if $material_info.sales_material_type == 5}>checked="checked"<{/if}> />
                            <label for="type5">多选一</label>
                            <input id="type6" type="radio" name="sales_material_type" value="6" <{if $material_info.sales_material_type == 6}>checked="checked"<{/if}> />
                            <label for="type6">礼盒</label>
                            <input id="type7" type="radio" name="sales_material_type" value="7" <{if $material_info.sales_material_type == 7}>checked="checked"<{/if}> />
                            <label for="type7">福袋组合</label>
                        </div>
                    <{/if}>
                </div>
                <div class="form-field">
                    <span class="form-field-label">所属店铺：</span>
                    <{if $readonly.shop == true}>
                        <{foreach from=$shops item=shop}><{if $material_info.shop_id == $shop.shop_id }><{$shop.name}><{/if}><{/foreach}>
                        <input type="hidden" name="shop_id" value="<{$material_info.shop_id}>">&nbsp;&nbsp;<span style="color:red;">(已有关联订单不能修改)</span>
                    <{else}>
                        <select class="form-input"  id="shop_id" name="shop_id">
                            <{foreach from=$shops item=shop}>
                            <option value="<{$shop.shop_id}>" <{if $material_info.shop_id == $shop.shop_id }>selected="selected"<{/if}> ><{$shop.name}></option>
                            <{/foreach}>
                        </select>
                        <span id="shop_text" style="display:none;">全部店铺</span>
                    <{/if}>
                </div>
                <div class="form-field"  id="bind_brand" <{if $readonly.bind_item == true && $material_info.sales_material_type == 2}><{else}>style="display:none;"<{/if}> >
                    <span class="form-field-label">品牌：</span>
                    <select class="form-input" id="brand" name="brand_id"> </select>
                    <span id="shop_text" style="display:none;">全部店铺</span>
                </div>
                <div class="form-field" id="bind_category" <{if $readonly.bind_item == true && $material_info.sales_material_type == 2}><{else}>style="display:none;"<{/if}> >
                    <span class="form-field-label">物料分类：</span>
                    <{input class='form-input' value="{$material_info.cat_id}" type="category" name="cat_id" }>
                </div>
                <div class="form-field" id="bind_basic_material" <{if $readonly.bind_item == true && in_array($material_info.sales_material_type, array(2, 4, 5, 7))}>style="display:none"<{/if}>>
                    <span class="form-field-label">关联基础物料：</span>
                    <{input class='form-input' type='material_object' object='basic_material@material' breakpoint='0' name='bm_id' textcol='material_name' value=$bind_bm_id callback='material_object_callback' replacehtml=$replacehtml emptytext='选取基础物料' style='float:left;width:200px;' filter='visibled=1' }>
                </div>
                <div class="form-field" id="bind_basic_giftmaterial" style="display:none">
                    <span class="form-field-label">关联礼盒：</span>
                    <{input class='form-input' type='material_object' object='basic_material@material' breakpoint='0' name='box_id' textcol='material_name' value=$bind_bm_id callback='material_object_callback' replacehtml=$replacehtml emptytext='选取礼盒' style='float:left;width:200px;' filter='visibled=1&type=4' }>
                </div>
                <div class="form-field">
                    <span class="form-field-label">销售状态：</span>
                    <div class="form-radios">
                        <input type="radio" name="visibled" value="1" <{if $material_info.visibled == 1}>checked="checked"<{/if}> />
                        <label for="type1">启售</label>
                        <input type="radio" name="visibled" value="0" <{if $material_info.visibled == 0}>checked="checked"<{/if}> />
                        <label for="type2">停售</label>
                    </div>
                </div>
                <div class="form-layout-fields">
                    <div class="form-field">
                        <span class="form-field-label">客户分类：</span>
                        <select class="form-input" placeholder="请选择" name="class_id">
                            <option value="0">--请选择客户分类--</option>
                            <{foreach from=$classList item=classVal}>
                            <option value="<{$classVal.class_id}>" <{if $classVal.class_id == $material_info.class_id }>selected="selected"<{/if}> ><{$classVal.class_name}></option>
                            <{/foreach}>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-layout-block" id="promotion_items" <{if $readonly.bind_item == true && $material_info.sales_material_type == 2}>style="margin-top:10px;"<{else}>style="margin-top:10px;display:none"<{/if}> >
            <h3>组合关联基础物料</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 2}>
                        &nbsp;<span id="cantdel" style="color:red;">(有关联订单未生成发货单,不能修改关联基础物料)</span>
                    <{else}>
                        <{button label="物料库频道" id="material-find-btn" }>
                    <{/if}>
                </div>
                <table class="gridlist" id="material_table"  style="margin:4px 0;">
                    <thead>
                    <tr>
                                        <th>编码</th>
                <th style="width:240px;">名称</th>
                <th><{$price_label}></th>
                <th>数量</th>
                <th>组合价格贡献占比(1-100数值)</th>
                <th style="width:30px;">删除</th>
                    </tr>
                    </thead>
                    <tbody id="dataNode">
                    <tr>
                        <td colspan="6" style="padding:0;"><div class="note" style="margin:0;"> 暂无物料信息 </div></td>
                    </tr>
                    </tbody>
                </table>
                <div align="right">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 2}>
                    &nbsp;
                    <{else}>
                      <{button type="button" id="material-compute-rate" label="按{$price_label}计算贡献比" }>
                    &nbsp;&nbsp;<{button type="button" id="material-delall-btn" label="全部删除" }>
                    <{/if}>
                </div>
            </div>
        </div>
        <div class="form-layout-block" id="gift_items"
             <{if $readonly.bind_item == true && $material_info.sales_material_type == 3}>style="margin-top:10px;"
             <{else}>style="margin-top:10px;display:none"<{/if}> >
            <h3>赠品关联基础物料</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 3}>
                        &nbsp;
                        <span id="cantdel" style="color:red;">(有关联订单未生成发货单,不能修改关联基础物料)</span>
                    <{else}>
                        <{button label="基础物料列表" id="gift-material-find-btn" }>
                    <{/if}>
                </div>
                <table class="gridlist" style="margin:4px 0;">
                    <thead>
                    <tr>
                        <th>编码</th>
                        <th style="width:240px;">名称</th>
                        <th>零售价</th>
                        <th>数量</th>
                        <th style="width:30px;">删除</th>
                    </tr>
                    </thead>
                    <tbody id="gift_dataNode">
                    <tr>
                        <td colspan="5" style="padding:0;">
                            <div class="note" style="margin:0;"> 暂无物料信息</div>
                        </td>
                    </tr>
                    </tbody>
                </table>
                <div align="right">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 3}>
                        &nbsp;
                    <{else}>
                        &nbsp;&nbsp;<{button type="button" id="gift-material-delall-btn" label="全部删除" }>
                    <{/if}>
                </div>
            </div>
        </div>
        <div class="form-layout-block" id="luckybag_rules" <{if $material_info.sales_material_type == 4}>style="margin-top:10px;"<{else}>style="margin-top:10px;display:none"<{/if}> >
            <h3>福袋商品规则</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="gridlist" style="padding:10px;">
                    <input type="hidden" id="current_part_number" value="<{$lb_rule_current_part_number}>" />
                    <{if $material_info.sales_material_type == 4 && $readonly.bind_item == true}>
                        <input type="hidden" id="can_edit_luckybag_rules" name="can_edit_luckybag_rules" value="no"/>
                    <{else}>
                        <div style="height:30px"><button id="add_luckybag_rule" class="btn" type="button"><span><span>新增组合</span></span></button></div>
                        <div class="luckybag_hr"><hr /></div>
                        <input type="hidden" id="can_edit_luckybag_rules" name="can_edit_luckybag_rules" value="yes"/>
                    <{/if}>
                    <div id="luckybag_rules_content">
                        <{foreach from=$luckybag_rules_list item=lb_rule}>
                        <div class="luckybag_rules_content_div" luckybag_key="<{$lb_rule.load_part_number}>">
                            <input type="hidden" name="lbr[<{$lb_rule.load_part_number}>][edit_lbr_id]" value="<{$lb_rule.lbr_id}>" />
                            <div class="luckybag_title">
                                <{if $material_info.sales_material_type == 4 && $readonly.bind_item == true}>
                                <div class="luckybag_title_name"><b>组合名称</b> <{$lb_rule.lbr_name}></div>
                                <{else}>
                                <div class="luckybag_title_name"><b>组合名称</b> <input name="lbr[<{$lb_rule.load_part_number}>][name]" value="<{$lb_rule.lbr_name}>" type="text" class="x-input"></div><div class="luckybag_title_del" delete_lbr_id="<{$lb_rule.lbr_id}>" onclick="delete_luckybag_div(this);">删除本组</div>
                                <div class="luckybag_title_material">
                                    <span id="lbba_bn_<{$lb_rule.load_part_number}>"><label>基础物料编码：</label><input name="bn_<{$lb_rule.load_part_number}>" type="text" class="x-input"/></span>
                                    <span id="lbba_name_<{$lb_rule.load_part_number}>"><label>基础物料名称：</label><input name="name_<{$lb_rule.load_part_number}>" type="text" class="x-input"/></span>
                                </div>
                                <{/if}>
                            </div>
                            <table class="gridlist luckybag_table">
                                <thead><tr><th>基础物料编码</th><th>基础物料名称</th><th>成本价</th><th class="luckybag_table_operation_th">操作</th></tr></thead>
                                <tbody id="dataNode_luckybag_<{$lb_rule.load_part_number}>">
                                <{foreach from=$lb_rule.bm_list item=bm_l}>
                                <tr id="tr_luckybag_<{$bm_l.bm_id}>" oid="<{$bm_l.bm_id}>">
                                    <td><{$bm_l.material_bn}><input type="hidden" name="lbr[<{$lb_rule.load_part_number}>][bm_ids][]" value="<{$bm_l.bm_id}>" /></td>
                                    <td><{$bm_l.material_name}></td>
                                    <td><{$bm_l.cost}></td>
                                    <td>
                                        <{if $material_info.sales_material_type == 4 && $readonly.bind_item == true}>
                                        -
                                        <{else}>
                                        <{img src="bundle/delecate.gif" class="pointer" app="desktop" key="state" onclick="delete_luckybag_tr(this);"}>
                                        <{/if}>
                                    </td>
                                </tr>
                                <{/foreach}>
                                </tbody>
                            </table>
                            <div class="luckybag_rule">
                                <{if $material_info.sales_material_type == 4 && $readonly.bind_item == true}>
                                组合规则：随机选 <{$lb_rule.sku_num}> 个sku，
                                分别送 <{$lb_rule.send_num}> 件，
                                单品售价 <{$lb_rule.price}> 元
                                <{else}>
                                组合规则：随机选 <input class="x-input" id="lkb_retail_price_sku<{$lb_rule.load_part_number}>" onchange="get_auto_lkb_retail_price(<{$lb_rule.load_part_number}>);" type="text" size="5" name="lbr[<{$lb_rule.load_part_number}>][sku_num]" value="<{$lb_rule.sku_num}>"> 个sku，
                                分别送 <input class="x-input" id="lkb_retail_price_sendnum<{$lb_rule.load_part_number}>" onchange="get_auto_lkb_retail_price(<{$lb_rule.load_part_number}>);" type="text" size="5" name="lbr[<{$lb_rule.load_part_number}>][send_num]" value="<{$lb_rule.send_num}>"> 件，
                                单品售价 <input class="x-input" id="lkb_retail_price_price<{$lb_rule.load_part_number}>" onchange="get_auto_lkb_retail_price(<{$lb_rule.load_part_number}>);" type="text" size="5" name="lbr[<{$lb_rule.load_part_number}>][single_price]" value="<{$lb_rule.price}>"> 元
                                <input class="lkb_retail_price" type="hidden" id="lkb_current_retail_price<{$lb_rule.load_part_number}>" value="<{$lb_rule.current_retail_price}>">
                                <{/if}>
                            </div>
                            <div class="luckybag_hr"><hr /></div>
                        </div>
                        <{/foreach}>
                    </div>
                </div>
            </div>
        </div>
        <div class="form-layout-block" id="pickone_items" <{if $readonly.bind_item == true && $material_info.sales_material_type == 5}>style="margin-top:10px;"<{else}>style="margin-top:10px;display:none"<{/if}> >
            <h3>多选一关联基础物料</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <span class="form-field-label">选择方式：</span>
                    <div class="form-radios">
                        <input id="pickone_select_type1" type="radio"  name="pickone_select_type" value="1" <{if $pickone_select_type == 1}> checked="checked" <{/if}> />
                        <label for="pickone_select_type1">随机</label>
                        <input id="pickone_select_type2" type="radio" name="pickone_select_type" value="2"  <{if $pickone_select_type == 2}> checked="checked" <{/if}> />
                        <label for="pickone_select_type2">排序</label>
                    </div>
                    <span class="form-remark">正序排序数值从小到大（不包括0）表格中排序值不填默认为0且优先级最低 如排序值相同则这部分做随机处理</span>
                </div>
                <div class="form-field">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 5}>
                    &nbsp;  <span id="cantdel_pickone" style="color:red;">(有关联订单未生成发货单,不能修改关联基础物料)</span>
                    <{else}>
                        <{button label="基础物料列表" id="basic_material_find_btn" }>
                    <{/if}>
                    <table class="gridlist" style="margin:4px 0;">
                        <thead>
                        <tr><th style="width:30%">编码</th><th style="width:35%">名称</th><th style="width:20%"><span class="sort_column" <{if $pickone_select_type == 1}> style="display:none" <{/if}> >排序值</span></th><th style="width:15%">删除</th></tr>
                        </thead>
                        <tbody id="pickone_dataNode">
                        <tr><td colspan="4" style="padding:0;"><div class="note" style="margin:0;"> 暂无基础物料信息 </div></td></tr>
                        </tbody>
                    </table>
                    <div align="right">
                        <{if $readonly.bind_item == true && $material_info.sales_material_type == 5}>
                        &nbsp;
                        <{else}>
                        <{button type="button" id="basic_material_delall_btn" label="全部删除" }>
                        <{/if}>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-layout-block" id="fukubukuro_items" <{if $readonly.bind_item == true && $material_info.sales_material_type == 7}>style="margin-top:10px;"<{else}>style="margin-top:10px;display:none"<{/if}> >
            <h3>福袋组合规则</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 7}>
                    &nbsp;<span id="cantdel" style="color:red;">(有关联订单未生成发货单,不能修改关联基础物料)</span>
                    <{else}>
                    <{button label="选择福袋组合" id="fukubukuro-find-btn" }>
                    <{/if}>
                </div>
                <table class="gridlist" id="fukubukuro_table"  style="margin:4px 0;">
                    <thead>
                        <tr>
                            <th>福袋组合编码</th>
                            <th style="width:240px;">福袋组合名称</th>
                            <th>福袋区间价</th>
                            <th>组合贡献价</th>
                            <th>组合价格贡献占比(%)</th>
                            <th style="width:30px;">删除</th>
                        </tr>
                    </thead>
                    <tbody id="fudaiDataNode">
                    <tr>
                        <td colspan="6" style="padding:0;"><div class="note" style="margin:0;"> 暂无福袋组合信息 </div></td>
                    </tr>
                    </tbody>
                </table>
                <div align="right">
                    <{button type="button" id="fukubukuro-compute-rate" label="按零售价计算贡献占比" }>
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 7}>
                    <{else}>
                    &nbsp;&nbsp;<{button type="button" id="fukubukuro-delall-btn" label="全部删除" }>
                    <{/if}>
                </div>

                <div class="form-field">
                    <span style="color:red;">*选中比例默认随机，可填数字，不允许负数、空白。比例相加不可大于100，如有数字和随机同时出现，则随机与数字之和也不大于100。</span>
                </div>
            </div>
        </div>

        <div class="form-layout-block">
            <h3>发票信息</h3>
            <div class="form-layout-fields">
                <div class="form-field">
                    <span class="form-field-label">开票税率：</span>
                    <input class="form-input" placeholder="请输入开票税率%" type="text" vtype='unsigned'  name='tax_rate' value="<{$material_info.tax_rate}>" />
                </div>
                <div class="form-field">
                    <span class="form-field-label">开票名称：</span>
                    <input class="form-input" placeholder="请输入开票名称" type="text" name="tax_name" value="<{$material_info.tax_name}>" />
                </div>
                <div class="form-field">
                    <span class="form-field-label">发票分类编码：</span>
                    <input class="form-input" placeholder="请输入发票分类编码" type="text" name="tax_code" value="<{$material_info.tax_code}>" />
                    <span style = "color:red;">&nbsp;&nbsp;(建议设置，开电子发票时，必要参数)</span>
                </div>
            </div>
        </div>
        <div class="form-layout-block">
            <h3>扩展信息</h3>
            <div class="form-layout-fields form-layout-fields-column">
                <div class="form-field">
                    <span class="form-field-label">零售价：</span>
                    <{if $readonly.bind_item == true && $material_info.sales_material_type == 4}>
                        <{$material_info.retail_price}>
                        <input class="form-input" type="hidden" placeholder="请输入零售价" id="retail_price" name="retail_price" value="<{$material_info.retail_price}>" />
                    <{else}>
                                                  <input class="form-input" type="text" placeholder="请输入零售价" id="retail_price" name="retail_price" value="<{$material_info.retail_price}>" />
                    <{/if}>
                </div>
                <div class="form-field">
                    <span class="form-field-label">最低售价：</span>
                    <input class="form-input" placeholder="请输入最低售价" id="lowest_price" name="lowest_price" value="<{$material_info.lowest_price}>" />
                </div>
                <div class="form-field">
                    <span class="form-field-label">包装单位：</span>
                    <input class="form-input" placeholder="请输入包装单位" name="unit" value="<{$material_info.unit}>" />
                    <span class="form-remark"> 建议填写此单位 开电子发票必要参数</span>
                </div>
            </div>
            <div id="cc" class="form-actions">
                <button class="btn-primary" id="material-save-btn">保存</button>
                <{button type="button" class="btn-secondary" id="return-btn" label="返 回" onclick="location.href=window.frameElement.src;"}>
            </div>
        </div>
    </form>
</div>
<script>

// 价格配置变量
var priceRate = '<{$price_rate|default:"retail_price"}>';
var priceField = '<{$price_field|default:"retail_price"}>';
var priceLabel = '<{$price_label|default:"零售价"}>';

var sm_id = "<{$material_info.sm_id}>";
(function() {
    window.addEvent('domready', function() {
        if($ES("input[name='sales_material_type']:checked").length) {
            var chose_type = $ES("input[name='sales_material_type']:checked").get('value');
        } else {
            var chose_type = $ES("input[name='sales_material_type']").get('value');
        }
        // 普通
        if(chose_type == 1){
            $('promotion_items').setStyle('display','none');
            $('bind_brand').setStyle('display','none');
            $('bind_category').setStyle('display','none');

            if($('bind_basic_material')){
                $('bind_basic_material').setStyle('display','flex');
            }
            $('bind_basic_giftmaterial').setStyle('display','none');

            if ($('shop_id')) {
                $('shop_id').setStyle('display', 'block');
                $('shop_text').setStyle('display', 'none');
            }
            $('retail_price').set('readonly', false);
            
        }else if(chose_type == 3){
            // 组合明细屏蔽
            $('promotion_items').setStyle('display', 'none');
            // 品牌屏蔽
            $('bind_brand').setStyle('display', 'none');
            // 分类屏蔽
            $('bind_category').setStyle('display', 'none');
            // 礼盒屏蔽
            $('bind_basic_giftmaterial').setStyle('display', 'none');
            // 绑定基础物料屏蔽
            $('bind_basic_material').setStyle('display', 'none');
            // $('retail_price').set('readonly',true);
            // 赠品明细显示
            $('gift_items').setStyle('display', 'block');
            // 零售价只读 默认为0
            $('retail_price').set('readonly', true);
            $('retail_price').set('value', '0.00');
        }else if(chose_type == 6){

          $('bind_basic_giftmaterial').setStyle('display','table-row');
          if($('bind_basic_material')){
                $('bind_basic_material').setStyle('display','none');
          }
        }else if(chose_type == 2){
            $('promotion_items').setStyle('display','block');
            $('bind_brand').setStyle('display','table-row');
            $('bind_category').setStyle('display','flex');

            if($('bind_basic_material')){
                $('bind_basic_material').setStyle('display','none');
            }
            $('bind_basic_giftmaterial').setStyle('display','none');
            if($('shop_id')){
                $('shop_id').setStyle('display','block');
                $('shop_text').setStyle('display','none');
            }
            $('retail_price').set('readonly',false);
        }else if(chose_type == 5){
            $('pickone_items').setStyle('display','block');
            if($('bind_basic_material')){

                $('bind_basic_material').setStyle('display','none');
            }
            $('bind_basic_giftmaterial').setStyle('display','none');
        }else if(chose_type == 7){
            //福袋组合
            if($('bind_basic_material')){
                $('bind_basic_material').setStyle('display','none');
            }

            $('fukubukuro_items').setStyle('display','block');
        }

        $ES('input[name="sales_material_type"]').each(function(item){
            item.addEvent('click',function(e){
                $('luckybag_rules').setStyle('display','none');
                $('promotion_items').setStyle('display','none');
                $('gift_items').setStyle('display','none');
                $('bind_brand').setStyle('display','none');
                $('bind_category').setStyle('display','none');

                $('pickone_items').setStyle('display','none');
                $('fukubukuro_items').setStyle('display','none');

                if (this.value == '1' || this.value == '6') { //普通 礼盒
                    $('bind_basic_material').setStyle('display', 'table-row');
                    if (this.value == '6'){
                        $('bind_basic_giftmaterial').setStyle('display','table-row');
                        $('bind_basic_material').setStyle('display','none');
                    }else{
                        $('bind_basic_giftmaterial').setStyle('display','none');
                    }
                    $('shop_id').setStyle('display','block');
                    $('retail_price').set('readonly',false);
                    $('shop_text').setStyle('display','none');
                }else{
                    $('retail_price').set('readonly', false);
                    if(this.value == '4'){
                        $('luckybag_rules').setStyle('display','block');
                    }else if(this.value == '5'){ //多选一
                        $('pickone_items').setStyle('display','block');
                    } else if (this.value == '3') { //赠品
                        // 赠品关联基础物料div打开
                        $('gift_items').setStyle('display', 'block');
                        // 零售价只读 默认为0
                        $('retail_price').set('readonly', true);
                        $('retail_price').set('value', '0.00');
                    } else if (this.value == '7') {
                        //福袋组合
                        $('fukubukuro_items').setStyle('display','block');
                    }else{
                        $('promotion_items').setStyle('display','block');
                        $('bind_brand').setStyle('display','table-row');
                        $('bind_category').setStyle('display','table-row');
                    }

                    if($('bind_basic_material')){
                        $('bind_basic_material').setStyle('display','none');
                    }
                    if($('bind_basic_giftmaterial')){
                        $('bind_basic_giftmaterial').setStyle('display','none');
                    }
                    $('shop_id').setStyle('display','block');
                    $('shop_text').setStyle('display','none');
                }
            });

        });

        //页面加载商品
        if(chose_type != 7) {
            new Request({url:'index.php?app=material&ctl=admin_material_sales&act=getEditMaterial&p[0]='+ sm_id,
            onComplete:function(rs){
                rs=JSON.decode(rs);
                var original = rs.original; //普通、赠品、组合
                var pickone = rs.pickone; //多选一
                if(original){
                    store.combine(original);

                    // 不同的销售物料类型保存store数据至类型变量
                    <{if $material_info.sales_material_type == 3}>
                        giftStore = store;
                    <{else}>
                        bmStore = store;
                    <{/if}>
                    var brandHtml = '';
                    var brand_id = '<{$material_info.brand_id}>';
                    var cat_id = parseInt('<{$material_info.cat_id}>');

                     store.each(function(item) {
                        if(item.brand_name) {
                          brandHtml += '<option value="'+item.brand_id+'">'+item.brand_name+'</option>';
                        }

                        //选择分类
                        if(item.cat_id) {
                            document.getElementsByName("cat_id")[0].value = item.cat_id;
                        }
                     });
                     if(brandHtml) {
                       $('brand').setHTML(brandHtml);
                       if(brand_id) {
                        $('brand').value = brand_id;
                       }
                     }

                     //选择分类
                     if(cat_id) {
                         document.getElementsByName("cat_id")[0].value = cat_id;
                     }

                     // 赠品
                    <{if $material_info.sales_material_type == 3}>
                    createGiftProduct(store);
                    <{else}>
                    createProduct(store);
                    <{/if}>

                }
                if(pickone){
                    store.combine(pickone);
                    createProduct_pickone(store);
                    $ES('input[name="pickone_select_type"]').each(function(item){
                        if(item.value == store[0].select_type){
                            item.set('checked',true);
                        }
                    });
                }
            }}).send();
        }

        if($('cantdel')){
            var tpl='<tr key="{bm_id}" id="bm_{bm_id}" title="点击选取/反选此条记录">'
                +'  <td>{material_bn}</td><td class="material-name">{material_name}</td><td>{' + (priceField || 'retail_price') + '}</td>'
                +'  <td><input type="text" value="{number}" key="number" vtype="number&amp;&amp;required" tname="at[_PRIMARY_]" size="6" readonly></td>'
                +'  <td><input type="text" vtype="number&amp;&amp;required"  tname="pr[_PRIMARY_]" key="rate" value="{rate}" id="rate_{bm_id}" size="5"></td>'
                +'  <td style="text-align:center;">-<{img src="bundle/delecate.gif" style="display:none;" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                +'</tr>';
            var gift_tpl = '<tr key="{bm_id}" id="bm_{bm_id}" title="点击选取/反选此条记录">' + 
                '<td>{material_bn}</td>' +
                '<td class="material-name">{material_name}</td>' +
                '<td>{' + (priceField || 'retail_price') + '}</td>' +
                '<td><input type="text" value="{number}" key="number" vtype="number&amp;&amp;required" tname="at[_PRIMARY_]" size="6" readonly></td>' +
                '<td style="text-align:center;">-<{img src="bundle/delecate.gif" style="display:none;" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                + '</tr>';
        }else{
            var tpl='<tr key="{bm_id}" id="bm_{bm_id}" title="点击选取/反选此条记录">'
                +'  <td>{material_bn}</td><td class="material-name">{material_name}</td><td>{' + (priceField || 'retail_price') + '}</td>'
                +'  <td><input type="text" value="{number}" key="number" vtype="number&amp;&amp;required" tname="at[_PRIMARY_]" size="6"></td>'
                +'  <td><input type="text" vtype="number&amp;&amp;required"  tname="pr[_PRIMARY_]" key="rate" value="{rate}" id="rate_{bm_id}" size="5"></td>'
                +'  <td><{img src="bundle/delecate.gif" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                +'</tr>';
            var gift_tpl = '<tr key="{bm_id}" id="bm_{bm_id}" title="点击选取/反选此条记录">' + 
                '<td>{material_bn}</td>' +
                '<td class="material-name">{material_name}</td>' +
                '<td>{' + (priceField || 'retail_price') + '}</td>' +
                '<td><input type="text" value="{number}" key="number" vtype="number&amp;&amp;required" tname="at[_PRIMARY_]" size="6"></td>' +
                '<td><{img src="bundle/delecate.gif" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                + '</tr>';
        }

        var callurl='index.php?app=material&ctl=admin_material_basic&act=getMaterial',store=[], bmStore = [], giftStore = [];
        var url='index.php?app=desktop&act=alertpages&goto='+encodeURIComponent('index.php?app=material&ctl=admin_material_basic&act=findMaterial');
        if($('material-find-btn')){
            $('material-find-btn').addEvent('click',function(e){
                new finderDialog(url,{params:{url:callurl,name:'bm_id[]'},width:1000,height:660,
                    onCallback:function(rs){
                        if(!rs)return;
                        rs=JSON.decode(rs);
                        init(rs);
                    }
                });
            });
        }

        // 赠品
        if ($('gift-material-find-btn')) {
            $('gift-material-find-btn').addEvent('click', function (e) {
                new finderDialog(url, {
                    params: {url: callurl, name: 'bm_id[]'}, width: 1000, height: 660,
                    onCallback: function (rs) {
                        if (!rs) return;
                        rs = JSON.decode(rs);
                        init(rs, 'gift');
                    }
                });
            });
        }

      //多选一
        if($('basic_material_find_btn')){
            $('basic_material_find_btn').addEvent('click',function(e){
                new finderDialog(url,{params:{url:callurl,name:'bm_id[]'},width:1000,height:660,
                    onCallback:function(rs){
                        if(!rs)return;
                        rs = JSON.decode(rs);
                        tmparr = findProduct(rs,'bm_id');
                        store.unshift.apply(store,tmparr.reverse());
                        createProduct_pickone(store);
                    }
                });
            });
        }

          function createProduct_pickone(data){
              var show_style = 'style="display:none"'; //默认随机
              var pickone_select_type = $E("input[name=pickone_select_type]:checked").value;
              if(pickone_select_type == "2"){ //排序
                  show_style = 'style="display:block"';
              }
              if($('cantdel_pickone')){
                  var tpl_pickone ='<tr key="{bm_id}">'
                      +'  <td>{material_bn}</td><td class="material-name">{material_name}</td>'
                      +'  <td><input type="text" class="sort_column" '+ show_style +' vtype="number" value="{sort}" key="sort" name="sort[{bm_id}]" size="6"></td>'
                      +'  <td style="text-align:center;">-<{img src="bundle/delecate.gif" style="display:none;" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                      +'</tr>'; //多选一createProduct_pickone方法用
              }else{
                  var tpl_pickone ='<tr key="{bm_id}">'
                     +'  <td>{material_bn}</td><td class="material-name">{material_name}</td>'
                     +'  <td><input type="text" class="sort_column" '+ show_style +' vtype="number" value="{sort}" key="sort" name="sort[{bm_id}]" size="6"></td>'
                     +'  <td><{img src="bundle/delecate.gif" app="desktop" key="state" class="pointer btn-delete-item"}></td>'
                     +'</tr>'; //多选一createProduct_pickone方法用
              }
              pag=new PageData(tpl_pickone,data,{'updateMain':$('pickone_dataNode'),'pageNum':10,PRIMARY_ID:'bm_id',
                  'onShow':function(){
                       var _this=this;
                       $$('#pickone_dataNode input[type]').addEvent('change',function(e){
                           var pid=this.getParent('tr').get('key'),value=this.value;
                          _this.editData(pid,[this.get('key'),value]);
                      });
                      rows=$ES('#pickone_dataNode tr');
                      rows.each(function(item,i){
                          item.getElement('.btn-delete-item').addEvent('click',function(e){
                              if(_this.selectData(item.get('key')) && confirm('确定要删除 '+ _this.selectData(item.get('key'))['material_name'] +' 吗？')) _this.delData(item.get('key'));
                              if(!$E('#pickone_dataNode tr')){
                                  pickone_emptyData();
                              }
                          });
                      });
                  }});
          }
          function pickone_emptyData(){
              var noData='<tr><td colspan="4" style="padding:0;"><div class="note" style="margin:0;"> 暂无基础物料信息 </div></td></tr>';
              $('pickone_dataNode').set('html',noData);
          }
          if($('basic_material_delall_btn')){
              $('basic_material_delall_btn').addEvent('click',function(e){
                  if(!pag||!pag.data)return;
                  var delarr=[];
                  pag.data.each(function(d){
                      delarr.push(d['bm_id']);
                  });
                  if(confirm('确认删除全部基础物料吗？')){
                      delProduct(pag,delarr);
                      pickone_emptyData();
                  }
              });
          }
          $ES("input[name=pickone_select_type]").addEvent("change",function(e){
              if(this.value == "2"){ //排序
                  $$(".sort_column").setStyle('display','block');
              }else{ //随机
                  $$(".sort_column").setStyle('display','none');
              }
          });

        var pag,rows,giftPag;
        function emptyData(){
            var noData='<tr>'
                +'<td colspan="7" style="padding:0;"><div class="note" style="margin:0;"> 暂无物料信息 </div></td>'
                +'</tr>';
            $('dataNode').set('html',noData);
        }

        // 赠品关联物料清空时显示
        function emptyGiftData() {
            var noData = '<tr>'
                + '<td colspan="7" style="padding:0;"><div class="note" style="margin:0;"> 暂无物料信息 </div></td>'
                + '</tr>';
            $('gift_dataNode').set('html', noData);
        }

        function createProduct(data){
            pag=new PageData(tpl,data,{'updateMain':$('dataNode'),'pageNum':10,PRIMARY_ID:'bm_id',
            'onShow':function(){
                 var _this=this;
                 $$('#dataNode input[type]').addEvent('change',function(e){
                     var pid=this.getParent('tr').get('key'),value=this.value;

                    _this.editData(pid,[this.get('key'),value]);
                });

                rows=$ES('#dataNode tr');
                rows.each(function(item,i){
                    item.addEvent('click',function(e){
                        this.toggleClass('selected');
                    });
                    item.getElement('.btn-delete-item').addEvent('click',function(e){
                        if(_this.selectData(item.get('key')) && confirm('确定要删除 '+ _this.selectData(item.get('key'))['material_name'] +' 吗？')) _this.delData(item.get('key'));
                        if(!$E('#dataNode tr')) emptyData();
                    });
                    item.getElement('input[key^=number]').addEvent('keypress',function(e){
                        if(e.code==13) $E('#pfba input').focus();
                    });
                });

                if(this.data.length) rows[0].getElement('input[key^=number]').focus();

               $ES('.material-name').removeEvent('mouseover').addEvent('mouseover',function(e){
                if (this.get('visibility')=='false')
                {
                 var e  = new Event(e), el = e.target;
                 visiTips.attach(el);
                 el.addEvent('mouseleave',function(){
                  this.removeClass('active');
                 });
                 el.fireEvent('mouseenter',e);
                }
                });
            }
            });
        }

        function createGiftProduct(data) {
            giftPag = new PageData(gift_tpl, data, {
                'updateMain': $('gift_dataNode'), 'pageNum': 10, PRIMARY_ID: 'bm_id',
                'onShow': function () {
                    var _this = this;
                    
                    $$('#gift_dataNode input[type]').addEvent('change', function (e) {
                        var pid = this.getParent('tr').get('key'), value = this.value;

                        _this.editData(pid, [this.get('key'), value]);
                    });

                    rows = $ES('#gift_dataNode tr');
                    rows.each(function (item, i) {
                        item.addEvent('click', function (e) {
                            this.toggleClass('selected');
                        });
                        item.getElement('.btn-delete-item').addEvent('click', function (e) {
                            if (_this.selectData(item.get('key')) && confirm('确定要删除 ' + _this.selectData(item.get('key'))['material_name'] + ' 吗？')) _this.delData(item.get('key'));
                            if (!$E('#dataNode tr')) emptyData();
                            compute(item);
                        });

                        item.getElement('input[key^=number]').addEvent('keypress', function (e) {
                            if (e.code == 13) $E('#pfba input').focus();
                        });
                    });

                    if (this.data.length) rows[0].getElement('input[key^=number]').focus();

                    $ES('.material-name').removeEvent('mouseover').addEvent('mouseover', function (e) {
                        if (this.get('visibility') == 'false') {
                            var e = new Event(e), el = e.target;
                            visiTips.attach(el);
                            el.addEvent('mouseleave', function () {
                                this.removeClass('active');
                            });
                            el.fireEvent('mouseenter', e);
                        }
                    });
                }
            });
        }
        function init(rs, sm_type = 'pkg'){
            // 根据销售物料类型,对全局变量store的内容做调整
            if (sm_type == 'gift') {
                store = giftStore;
            } else {
                store = bmStore;
            }
            // 同已有bm对比,进行去重
            var tmparr=findProduct(rs,'bm_id');
            // 新明细列表颠倒顺序,合并至旧数组
             store.unshift.apply(store,tmparr.reverse());

            // 不同的销售物料类型调用不同的函数,并保存store数据至类型变量
            if (sm_type == 'gift') {
                createGiftProduct(store);
                giftStore = store;
            }else{
                createProduct(store);
                bmStore = store;
            }
        }

        function findProduct(arr,PRIMARY){
            if(!store.length)return arr;
            store.each(function(a){
                arr.each(function(b){
                    if(a[PRIMARY]==b[PRIMARY])arr.erase(b);
                });
            });
            return arr;
        }

        function delProduct(obj,arr){
            arr.each(function(d){obj.delData(d);});
        }

        if($('material-delall-btn')){
            $('material-delall-btn').addEvent('click',function(e){
                if(!pag||!pag.data)return;
                var delarr=[];
                pag.data.each(function(d){
                     delarr.push(d['bm_id']);
                });
                if(confirm('确认删除全部物料吗？')){
                    delProduct(pag,delarr);
                    emptyData();
                }
            });
        }

        if ($('gift-material-delall-btn')) {
            $('gift-material-delall-btn').addEvent('click', function (e) {
                if (!giftPag || !giftPag.data) return;
                var delarr = [];
                giftPag.data.each(function (d) {
                    delarr.push(d['bm_id']);
                });
                if (confirm('确认删除全部物料吗？')) {
                    delProduct(giftPag, delarr);
                    emptyGiftData();
                }
            });
        }

        if($('material-compute-rate')){
            $('material-compute-rate').addEvent('click',function(e){
                if(!pag||!pag.data)return;

                var item_count = 0;
                var num = 0;
                var is_error = false;
                var price_total = 0;

                pag.data.each(function(d){
                    num = parseInt(d['number']);
                    if(num <= 0 || isNaN(num)){
                        is_error = true;
                    }else{
                        price_total += Number(d[priceField || 'retail_price']) * num;
                    }

                    if(d[priceField || 'retail_price'] > 0) {
                        item_count++;
                    }
                });

                if(is_error){
                    alert("请正确填写数量!");
                    return false;
                }

                if(price_total <= 0){
                    alert("都是0元货品,请手工输入贡献占比!");
                    return false;
                }

                var sum_rate = 0;
                var item_rate = 0;
                var item_price = 0;
                var line_i = 0;
                pag.data.each(function(d){
                    if(d[priceField || 'retail_price'] <= 0) {
                        return;
                    }
                    bm_id = d['bm_id'];
                    num = parseInt(d['number']);
                    item_price = Number(d[priceField || 'retail_price']) * num;

                    line_i++;

                    if(line_i == item_count){
                        item_rate = 100 - sum_rate;
                    }else{
                        item_rate = Math.floor(item_price / price_total * 100 * 100) / 100;

                        sum_rate += item_rate;

                        //兼容
                        if(sum_rate > 100){
                            sum_rate -= item_rate;

                            item_rate = 100 - sum_rate;
                            sum_rate += item_rate;
                        }
                    }

                    //兼容
                    if(item_rate < 0){
                        item_rate = 0;
                    }

                    if($("rate_" + bm_id)){
                        $("rate_" + bm_id).set('value', item_rate.toFixed(2));
                    }

                    rows=$ES('#dataNode tr');
                    rows.each(function(item,i)
                    {
                        if(bm_id == item.get('key')){
                            var pid = item.get('key');
                            pag.editData(pid, ['rate', item_rate]);
                        }
                    });

                });
            });
        }

        $('material-save-btn').addEvent('click',function(e){
            var _this=this;
            var form=this.getParent('form');

            // 明细绑定页面dom的ID
            let dataNodeDomName = 'dataNode';
            // 关联基础物料列表数组
            let dataItemList;

            let readonlyType = "<{$readonly.type}>";
            let salesMaterialType;
            if (readonlyType == true ){
                salesMaterialType = $E("input[name=sales_material_type]").value;
            }else{
                salesMaterialType = $E("input[name=sales_material_type]:checked").value;
            }
            
            // 根据销售类型切换判断变量
            if (salesMaterialType == '3') {
                // 赠品切换明细dom节点
                dataNodeDomName = 'gift_dataNode';
                // 关联基础物料列表数组确定
                dataItemList = giftPag;
            } else {
                // 关联基础物料列表数组确定
                dataItemList = pag;
            }

            // 存在关联多物料明细的情况
            if (dataItemList) {
                var data= dataItemList.toHideInput($(dataNodeDomName).getElement('tr'));
                form.store('target',{extraData:data,
                    onRequest:function(){
                        _this.disabled=true;
                    },
                    onComplete:function(jsontext){
                        try{
                            var json = JSON.decode(jsontext);
                            if (typeof(json.error)!='undefined'){
                                _this.disabled=false;
                            }else{
                                _this.disabled=true;
                                if(opener.finderGroup['<{$env.get.finder_id}>']) opener.finderGroup['<{$env.get.finder_id}>'].refresh.delay(100,opener.finderGroup['<{$env.get.finder_id}>']).chain(function(){
                                    window.close()
                                });
                            }
                        }catch(e){}
                    }
                });
            }else{
                form.store('target',{
                    onRequest:function(){
                        _this.disabled=true;
                    },
                    onComplete:function(jsontext){
                        try{
                            var json = JSON.decode(jsontext);
                            if (typeof(json.error)!='undefined'){
                                _this.disabled=false;
                            }else{
                                _this.disabled=true;
                                if(opener.finderGroup['<{$env.get.finder_id}>']) opener.finderGroup['<{$env.get.finder_id}>'].refresh.delay(100,opener.finderGroup['<{$env.get.finder_id}>']).chain(function(){
                                    window.close()
                                });
                            }
                        }catch(e){}
                    }
                });
            }
            form.fireEvent('submit',e);
        });

        if($('cantdel')){
            $ES(".btn-delete-item").each(function(item){
                this.setStyle('display','none');
            })
        }

        //福袋组合规则
        var fudai_url='index.php?app=desktop&act=alertpages&goto='+encodeURIComponent('index.php?app=material&ctl=admin_fukubukuro_combine&act=findFukubukuro');
        var fudai_callurl='index.php?app=material&ctl=admin_fukubukuro_combine&act=getFukubukuro', fudai_store=[];
        $('fukubukuro-find-btn').addEvent('click', function(e)
        {
            new finderDialog(fudai_url, {params:{url:fudai_callurl, name:'combine_id[]'}, width:1000,height:660,
                onCallback:function(rs)
                {
                    if(!rs)return;

                    rs = JSON.decode(rs);

                    //同已有fudai_store对比,进行去重
                    tmparr = findFukubukuroList(rs, 'combine_id');

                    //新明细列表颠倒顺序,合并至旧数组
                    fudai_store.unshift.apply(fudai_store, tmparr.reverse());

                    createFukubukuroProduct(fudai_store);
                }
            });
        });

        //异步加载福袋组合
        if(chose_type == 7) {
            new Request({url:'index.php?app=material&ctl=admin_material_sales&act=getEditFukubukuro&p[0]='+ sm_id,
                onComplete:function(rs){
                    if(!rs)return;

                    rs = JSON.decode(rs);

                    tmparr = findFukubukuroList(rs, 'combine_id');
                    fudai_store.unshift.apply(fudai_store, tmparr.reverse());

                    createFukubukuroProduct(fudai_store);
                }
            }).send();
        }

        //去除已经选择的福袋组合
        function findFukubukuroList(arr, PRIMARY)
        {
            if(!fudai_store.length)return arr;

            fudai_store.each(function(a)
            {
                arr.each(function(b){
                    if(a[PRIMARY]==b[PRIMARY])arr.erase(b);
                });
            });

            return arr;
        }

        var fudai_tpl='<tr key="{combine_id}" id="combineIds_{combine_id}" title="点击选取/反选此条记录">'
            +'  <td>{combine_bn}</td><td class="combine-name">{combine_name}</td>'
            +'  <td>{combine_price}</td>'
            +'  <td><input type="text" key="rate_price" id="rate_price_{combine_id}" name="rate_price[{combine_id}]" value="{rate_price}" size="8" onkeyup="value=value.replace(/[^\\d\\.]/ig,\'\')" ></td>'
            +'  <td><input type="text" vtype="number&amp;&amp;required" tname="pr[_PRIMARY_]" key="rate" id="rate_{combine_id}" name="fudai_rate[{combine_id}]" value="{rate}" size="5"></td>'
            +'  <td><{img src="bundle/delecate.gif" app="desktop" key="state" class="pointer fudai-btn-delete"}></td>'
            +'</tr>';

        function createFukubukuroProduct(data)
        {
            pag = new PageData(fudai_tpl, data, {'updateMain':$('fudaiDataNode'), 'pageNum':100, PRIMARY_ID:'combine_id',
                'onShow':function(){
                    var _this = this;
                    $$('#fudaiDataNode input[key=rate]').addEvent('change', function(e){
                        var pid = this.getParent('tr').get('key'),value=this.value;

                        if(value == "0"){
                            alert("组合价格贡献占比,不能填写数字：0");
                            return false;
                        }

                        _this.editData(pid,[this.get('key'),value]);
                    });

                    //rate_price click
                    $$('#fudaiDataNode input[key=rate_price]').addEvent('change', function(e){
                        var value = this.value;

                        //check
                        if(value == ''){
                            alert("请填写组合贡献价");
                            return false;
                        }

                        value = Number(value);
                        if(value < 0){
                            alert("请正确填写组合贡献价");
                            return false;
                        }

                        $('fukubukuro-compute-rate').fireEvent('click', {stop:$empty});
                    });

                    rows = $ES('#fudaiDataNode tr');
                    rows.each(function(item,i){
                        item.addEvent('click',function(e){
                            this.toggleClass('selected');
                        });

                        //delete button
                        item.getElement('.fudai-btn-delete').addEvent('click',function(e){
                            if(_this.selectData(item.get('key')) && confirm('确定要删除 '+ _this.selectData(item.get('key'))['combine_name'] +' 吗？')) _this.delData(item.get('key'));
                            if(!$E('#fudaiDataNode tr')) emptyData();
                        });
                    });

                    //delete
                    $ES('.combine-name').removeEvent('mouseover').addEvent('mouseover', function(e)
                    {
                        if (this.get('visibility')=='false'){
                            var e  = new Event(e), el = e.target;

                            visiTips.attach(el);

                            el.addEvent('mouseleave', function(){
                                this.removeClass('active');
                            });

                            el.fireEvent('mouseenter',e);
                        }
                    });
                }
            });
        }

        //按销售价计算贡献占比
        if($('fukubukuro-compute-rate')){
            $('fukubukuro-compute-rate').addEvent('click',function(e)
            {
                if(!pag||!pag.data)return;

                //rate_price
                var item_count = 0;
                var selling_price_total = 0;
                rows = $ES('#fudaiDataNode tr');
                rows.each(function(item, i){
                    combine_id = item.get('key');
                    rate_price = $("rate_price_"+combine_id).getValue();
                    rate_price = Number(rate_price);

                    //check
                    if(rate_price < 0){
                        alert("福袋组合贡献价不能小于0元");
                        return false;
                    }

                    if(rate_price > 0){
                        item_count++;
                    }

                    selling_price_total += rate_price;
                });

                if(selling_price_total <= 0){
                    alert("福袋组合贡献价都是0元,请手工输入贡献占比!");
                    return false;
                }

                var sum_rate = 0;
                var item_rate = 0;
                var item_price = 0;
                var line_i = 0;
                pag.data.each(function(d){
                    if(d['lowest_price'] <= 0) {
                        return;
                    }

                    combine_id = d['combine_id'];

                    //get rate_price
                    rate_price = $("rate_price_"+combine_id).getValue();
                    item_price = Number(rate_price);

                    //check
                    if(item_price <= 0) {
                        //支持小数
                        $("rate_" + combine_id).set('value', 0);

                        return;
                    }

                    line_i++;

                    if(line_i == item_count){
                        item_rate = 100 - sum_rate;
                    }else{
                        item_rate = Math.round(item_price / selling_price_total * 100 * 100) / 100;

                        //格式为正整数
                        //item_rate = Math.ceil(item_rate);

                        sum_rate += item_rate;

                        //兼容
                        if(sum_rate > 100){
                            sum_rate -= item_rate;

                            item_rate = 100 - sum_rate;
                            sum_rate += item_rate;
                        }
                    }

                    //兼容
                    if(item_rate < 0){
                        item_rate = 0;
                    }

                    if($("rate_" + combine_id)){
                        //正整数
                        //$("rate_" + combine_id).set('value', item_rate);

                        //支持小数
                        $("rate_" + combine_id).set('value', item_rate.toFixed(2));
                    }

                    rows = $ES('#fudaiDataNode tr');
                    rows.each(function(item,i)
                    {
                        if(combine_id == item.get('key')){
                            var pid = item.get('key');
                            pag.editData(pid, ['rate', item_rate]);
                        }
                    });
                });
            });
        }

        //删除全部福袋组合
        if($('fukubukuro-delall-btn')){
            $('fukubukuro-delall-btn').addEvent('click',function(e){
                if(!pag||!pag.data)return;

                var delarr=[];
                pag.data.each(function(d){
                    delarr.push(d['combine_id']);
                });

                if(confirm('确认删除全部福袋组合吗？')){
                    delProduct(pag, delarr);
                    emptyData();
                }
            });
        }

    });


    var readonly_bind_item = "<{$readonly.bind_item}>";
    var current_sales_material_type = "<{$material_info.sales_material_type}>";
    if(current_sales_material_type == 4){
        if(readonly_bind_item){
        }else{
            $ES(".luckybag_rules_content_div").each(function(item_div){
                load_auto_luckybag_tr(item_div.get("luckybag_key"));
            });
        }
    }else{
        var load_part_number = $("current_part_number").getValue();
        load_luckybag_div(load_part_number);
        load_auto_luckybag_tr(load_part_number);
    }

    $('add_luckybag_rule').addEvent('click',function(e){
        var load_part_number = $("current_part_number").getValue();
        load_luckybag_div(load_part_number);
        $ES(".luckybag_rules_content_div").each(function(item_div){
            load_auto_luckybag_tr(item_div.get("luckybag_key"));
        });
    });

})();

        function material_object_callback(rs,handle){
            var p_node = handle.getParent('div');
            var html = '已选择了1个物料,'+"<a href='javascript:void(0);' onclick='material_selected_show();'>查看关联的物料</a>";
            if ($defined($('hand-selected-product')))
            {
                $('hand-selected-product').setHTML(html);
            } else {
                var div = new Element('div',{'html':html,'id':'hand-selected-product'});
                div.injectAfter(p_node);
            }
        }

        function material_selected_show(){
            new Dialog('index.php?app=material&ctl=admin_material_sales&act=showMaterials',{
                ajaxoptions:{data:$('hand-selected-product').getPrevious('div'),method:'post'}
            });
        }

        function load_luckybag_div(load_part_number){
            var current_div_html = '<div class="luckybag_title">'
                +'<div class="luckybag_title_name"><b>组合名称</b> <input name="lbr['+load_part_number+'][name]" type="text" class="x-input"></div><div class="luckybag_title_del" onclick="delete_luckybag_div(this);">删除本组</div>'
                +'<div class="luckybag_title_material">'
                +'<span id="lbba_bn_'+load_part_number+'"><label>基础物料编码：</label><input name="bn_'+load_part_number+'" type="text" class="x-input"/></span> '
                +'<span id="lbba_name_'+load_part_number+'"><label>基础物料名称：</label><input name="name_'+load_part_number+'" type="text" class="x-input"/></span>'
                +'</div>'
                +'</div>'
                +'<table class="gridlist luckybag_table">'
                +'<thead>'
                +'<tr>'
                +'<th>基础物料编码</th>'
                +'<th>基础物料名称</th>'
                +'<th>成本价</th>'
                +'<th class="luckybag_table_operation_th">操作</th>'
                +'</tr>'
                +'</thead>'
                +'<tbody id="dataNode_luckybag_'+load_part_number+'">'
                +'</tbody>'
                +'</table>'
                +'<div class="luckybag_rule">组合规则：随机选 <input class="x-input" id="lkb_retail_price_sku'+load_part_number+'" onchange="get_auto_lkb_retail_price('+load_part_number+');" type="text" size="5" name="lbr['+load_part_number+'][sku_num]"> 个sku，'
                +'分别送 <input class="x-input" id="lkb_retail_price_sendnum'+load_part_number+'" onchange="get_auto_lkb_retail_price('+load_part_number+');" type="text" size="5" name="lbr['+load_part_number+'][send_num]"> 件，'
                +'单品售价 <input class="x-input" id="lkb_retail_price_price'+load_part_number+'" onchange="get_auto_lkb_retail_price('+load_part_number+');" type="text" size="5" name="lbr['+load_part_number+'][single_price]"> 元</div>'
                +'<input class="lkb_retail_price" type="hidden" id="lkb_current_retail_price'+load_part_number+'" value="0">'
                +'<div class="luckybag_hr"><hr /></div>';
            ;
            new Element('div', {class:'luckybag_rules_content_div',luckybag_key:load_part_number,html:current_div_html}).inject($E('#luckybag_rules_content'));
            $("current_part_number").value = parseInt(load_part_number) + 1;
        }

        function load_auto_luckybag_tr(part_num){
            var callurl_luckybag = 'index.php?app=console&ctl=admin_purchase&act=getProducts';
            var options={
                'getVar':'bn',
                'fxOptions':false,
                callJSON:function(){return window.autocompleter_json;},
                injectChoice:function(json){
                    var choice = new Element('li', {'html': this.markQueryValue(json[this.options.getVar])});
                    choice.store('_data',json);
                    choice.inputValue = json[this.options.getVar];
                    this.addChoiceEvents(choice).inject(this.choices);
                },
                onHide:function(){
                    if(!this.selected)return;
                    var json=this.selected.retrieve('_data');
                    json=$splat(json);
                    json.each(function(i){
                        var could_add = true;
                        var bm_id = i.product_id;
                        /*
                        if($ES("#dataNode_luckybag_"+part_num+" tr")){
                            $ES("#dataNode_luckybag_"+part_num+" tr").each(function(c_i){
                                if(bm_id == c_i.get('oid')){
                                    alert("这组已有此货品："+i.name);
                                    could_add = false;
                                }
                            });
                        }
                        */
                        if($ES("#luckybag_rules_content table tbody tr")){
                            $ES("#luckybag_rules_content table tbody tr").each(function(c_i){
                                if(bm_id == c_i.get('oid')){
                                    alert("组合中已有此货品："+i.name);
                                    could_add = false;
                                }
                            });
                        }
                        if(could_add){
                            var current_html = '<td>'+i.bn+'<input type="hidden" name="lbr['+part_num+'][bm_ids][]" value="'+bm_id+'"></td>'
                            +'  <td>'+i.name+'</td>'
                            +'  <td>'+i.cost+'</td>'
                            +'  <td><{img src="bundle/delecate.gif" class="pointer" app="desktop" key="state" onclick="delete_luckybag_tr(this);"}></td>';
                            new Element('tr', {id:'tr_luckybag_'+bm_id,oid:bm_id,html:current_html}).inject($E('#dataNode_luckybag_'+part_num));
                            MessageBox.success('加载商品成功!!');
                        }
                    });
                },
                onFocus:function(ipt){
                    ipt.value='';
                }
            };
            new Autocompleter.script($E('#lbba_bn_'+part_num+' input'),callurl_luckybag,options);
            new Autocompleter.script($E('#lbba_name_'+part_num+' input'),callurl_luckybag,$merge(options,{'getVar':'name'}));
        }

        function delete_luckybag_tr(obj){
            obj.getParent('tr').remove();
        }

        function delete_luckybag_div(obj){
            obj.getParent('.luckybag_rules_content_div').remove();
            get_lkb_retail_price();
        }

        function get_auto_lkb_retail_price(load_part_number){
            var lkb_load_part_number_sku = parseFloat($("lkb_retail_price_sku"+load_part_number).getValue());
            var lkb_load_part_number_sendnum = parseFloat($("lkb_retail_price_sendnum"+load_part_number).getValue());
            var lkb_load_part_number_price = parseFloat($("lkb_retail_price_price"+load_part_number).getValue());
            var current_lkb_retail_price = 0;
            if(lkb_load_part_number_sku > 0 && lkb_load_part_number_sendnum > 0 && lkb_load_part_number_price >= 0){
                current_lkb_retail_price = lkb_load_part_number_sku * lkb_load_part_number_sendnum * lkb_load_part_number_price;
            }else{
                return;
            }
            $('lkb_current_retail_price'+load_part_number).value = current_lkb_retail_price;
            get_lkb_retail_price();
        }

        function get_lkb_retail_price(){
            var retail_price = 0;
            $$(".lkb_retail_price").each(function(item,i){
                retail_price = parseFloat(retail_price) + parseFloat(item.getValue());
            });
            $('retail_price').value = retail_price;
        }

</script>
