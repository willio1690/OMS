<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="renderer" content="webkit">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta name="author" content="tyler chao">
  <meta name="keywords" content="keywords">
  <meta name="description" content="description">
  <title>门店换货</title>
  <link rel="stylesheet" href="<{$env.app.res_url}>/css/mobile.min.css">
  <link rel="stylesheet" href="<{$env.app.res_url}>/css/main.min.css">
</head>
<body>
	<{if $show_header}>
	<header class="fixed">
		<div class="top-bar" data-topbar>
			<div class="pos-left">
				<a href="javascript:history.back();" class="icon-arrow-back"></a>
			</div>
			<h1>门店换货</h1>
			<div class="pos-right">
				<a href="" class="icon-refresh"></a>
			</div>
		</div>
	</header>
	<{/if}>

	<main id="main" class="container no-margin">
		<div class="top-bar reverse">
			<form action="<{$link_url}>" method="post" class="row blank scan-form">
				<div class="grid-2 columns">
					<select name="sel_type" id="sel_type">
						<option <{if $sel_type == "order_bn"}>selected="selected"<{/if}> value="order_bn">订单号</option>
                        <option <{if $sel_type == "original_reship_bn"}>selected="selected"<{/if}> value="original_reship_bn">退货单号</option>
						<option <{if $sel_type == "ship_mobile"}>selected="selected"<{/if}> value="ship_mobile">收货人手机号</option>
						<option <{if $sel_type == "aftersale_bn"}>selected="selected"<{/if}> value="aftersale_bn">售后申请单号</option>
					</select>
				</div>
				<div class="grid-10 columns">
					<input type="search" name="sel_keywords" id="sel_keywords" value="<{$sel_keywords}>" placeholder="请输入关键词搜索">
				</div>
			</form>
		</div>
		<ul class="bar-tabs">
			<{foreach from=$sub_menu item=rs}>
			<li class="controller <{if $rs.curr_view}>active<{/if}>"><a href="<{$rs.href}>"><{$rs.label}></a></li> <{/foreach}>
		</ul>

		<div class="tabs-content">
			<{if $dataList}>
				<div class="content active" id="content11">
					<div class="container blank order-item"><{include file="aftersale/change_product_more.html"}></div>
					<{if $pageSize > 1}>
						<div class="text-center">
							<a href="<{$link_url}>" class="act-loadmore" rel="1"><i class="icon-refresh"></i> 点击查看更多</a>
						</div>
					<{/if}>
				</div>
			<{else}>
			<div class="no_content" style="text-align: center;">暂时没有业务需要处理哦，亲...</div>
			<{/if}>
		</div>
	</main>
	
	<div id="reject_modal" class="modal center" data-modal>
        <a href="javascript:void(0);" class="close-modal">&times;</a>
        <header>换货单拒绝</header>
        <article>
            <form action="" method="post" class="form-vertical collapse" id="reject_form">
                <input type="hidden" name="return_id" id="refuse_return_id" value="">
                <div class="form-row">
                    <div class="grid-12">
                        <label for="for_reason"> *请填写拒绝理由： 
                            <textarea id="refuse_reason_text"  cols="50" rows="5" vtype="required"></textarea>
                        </label>
                    </div>
                </div>
                <div class="form-row">
                    <div class="grid-6 columns">
                        <button type="button" id="refuse_button" class="primary expand" onClick="ajax_refuse_confirm()">确认拒绝</button>
                    </div>
                    <div class="grid-6 columns">
                        <a href="" class="btn close-modal expand">取消</a>
                    </div>
                </div>
            </form>
        </article>
    </div>
    
    <div id="reject_modal_confirm" class="modal center" data-modal>
	    <a href="" class="close-modal">&times;</a>
	    <header>确认换货吗？</header>
	    <input type="hidden" id="confirm_return_id" value="">
	    <div class="form-row">
	      <div class="grid-12"><label for="for_reason">请确认退入商品的内容、数量以及状态是否完好无损，钱款是否已经结清。</label></div>
	    </div>
	    <div class="form-row">
	      <div class="grid-6 columns"><button type="button" class="primary expand" onClick="ajax_confirm()">确认换货</button></div>
	      <div class="grid-6 columns"><a href="" class="btn close-modal expand">取消</a></div>
	    </div>
	</div>
    
    <{include file="store/footer.html"}>
    
    <{include file="submit_loading_div.html"}>
	<script>
		//拒绝显示form 带入return_id
	    function refuse_confirm(return_id){
	        $('#reject_form').find('input[name=return_id]').val(return_id);
	    }
	    //拒绝操作
	    function ajax_refuse_confirm(){
		    var return_id = $("#refuse_return_id").val();
		    var ajax_url = "<{$delivery_link.doRefuse}>";
		    var refuse_reason_text = $("#refuse_reason_text").val().trim();
		    if(!return_id || !ajax_url){
		        alert("无效操作!");
		        return false;
		    }
		    if(!refuse_reason_text){
		        alert("请填写拒绝理由!");
		        return false;
		    }
		    clean_popup_return_id();
		    $('#maskModal').mobile('modal', 'open');
		    $.post(ajax_url, {'return_id': return_id, 'refuse_reason_text': refuse_reason_text}, function(rs){
		        if(rs){
		            json = JSON.parse(rs);
		            if(json.res == 'succ'){
		                $("#return_operate_" + return_id).html('<span style="color: red; font-weight: bold">门店换货已拒绝!&nbsp;</span>');
		                $(document).mobile('tips', 'show', [json.msg, 'msg']);
		            }else{
		                $(document).mobile('tips', 'show', [json.msg, 'msg']);
		            }
		        }else{
		            $(document).mobile('tips', 'show', ['操作失败', 'msg']);
		        }
		        $('#maskModal').mobile('modal', 'close');
		    });
		}
	
	    //确认换货显示form 带入return_id
        function change_confirm(return_id){
        	$("#confirm_return_id").val(return_id);
        }
        //确认换货操作
        function ajax_confirm(){
            var ajax_url = "<{$delivery_link.doConfirm}>";
            var return_id = $("#confirm_return_id").val();
            if(return_id == ""){
                alert("无效操作!");
                return false;
            }
            clean_popup_return_id();
            $('#maskModal').mobile('modal', 'open');
            $.post(ajax_url, {'return_id': return_id}, function(rs) {
                if (rs) {
                    json = JSON.parse(rs);
                    if(json.res == 'succ'){
                        $("#return_operate_" + return_id).html('<span style="color: red; font-weight: bold">门店换货已确认!&nbsp;</span>');
                        $(document).mobile('tips', 'show', [json.msg, 'msg']);
                    }else{
                        $(document).mobile('tips', 'show', [json.msg, 'msg']);
                    }
                }else {
                    $(document).mobile('tips', 'show', ['操作失败', 'msg']);
                }
                $('#maskModal').mobile('modal', 'close');
            });
        }
        
        //统一清除拒绝、确认换货弹出确认框的return_id
        function clean_popup_return_id(){
            $('#reject_form').find('input[name=return_id]').val(''); //拒绝
            $('#confirm_return_id').val(''); //确认换货
        }
        
        //拒绝、确认换货弹出框统一关闭入口
        $('.close-modal').on('click', function(e) {
            e.preventDefault();
            clean_popup_return_id();
        });
        
        //加载更多
        $('.act-loadmore').on('click', function(e) {
            e.preventDefault();
            var $target = $(e.target);
            var pageSize = parseInt("<{$pageSize}>");
            var page = parseInt($target.attr('rel')) + 1;
            var sel_type = "<{$sel_type}>";
            var sel_keywords = "<{$sel_keywords}>";
            $.post($target.attr('href'), {'flag': 'ajax', 'page': $target.attr('rel'), 'sel_type': sel_type, 'sel_keywords': sel_keywords}, function(rs) {
              if (rs) {
                  $target.parent().prev('div').append(rs);
                  $target.html($target.data('text')).attr('rel', +$target.attr('rel') + 1);
                  if(pageSize <= page){
                      $target.parent().html('<span class="text-reverse">没有更多数据了...</span>');
                  }
              }else {
                  $target.parent().html('<span class="text-reverse">没有更多数据了</span>');
              }
            });
        });
        
        //baidu地图 查询路线
        function show_map(return_id){
            var $this = $("#show_map_id_"+ return_id);
            var store_addr = $this.attr("alt");
            var position_url = '<{$delivery_link.mapLink}>';
            window.open(position_url+"?store_addr="+store_addr);
        }
        
	</script>
</body>
</html>