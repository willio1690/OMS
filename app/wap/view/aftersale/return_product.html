<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>退货退款</title>
	<link rel="stylesheet" type="text/css" href="<{$env.app.res_url}>/css/common.css" />
	<link rel="stylesheet" type="text/css" href="<{$env.app.res_url}>/css/index.css" />
	<link rel="stylesheet" type="text/css" href="<{$env.app.res_url}>/css/change.css" />
	<script src="<{$env.app.res_url}>/js/axios.min.js"></script>
	<script src="<{$env.app.res_url}>/js/flexible.js"></script>
</head>

<body>
<div class="page flex-col">
	<!-- heder -->
	<div class="section_1 flex-col">
		<div class="text-wrapper_1 flex-row align-center justify-between">
			<img src="<{$env.app.res_url}>/img/icon-back.png" class="icon-back">
			<span class="text_1"><{$title}></span>
			<img src="<{$env.app.res_url}>/img/icon-refresh.png" class="icon-refresh">
		</div>
	</div>
	<!-- tab -->
	<div class="section_2 flex-col">
		<div class="group_1 flex-col tab-scroll-container">
			<div class="group_2 flex-row">
				<{foreach from=$sub_menu item=rs key=rsk}>
				<div class="group_3 flex-col">
					<a class="text_5 <{if $rs.curr_view}>tab-active<{/if}>" style="text-decoration:none;" href="<{$rs.href}>"><{$rs.label}></a>
					<{if in_array($rsk, array('pending')) && $rs.count>0}>
					<div class="text-wrapper_3 flex-col">
						<span class="text_6"><{$rs.count}></span>
					</div>
					<{/if}>
				</div>
				<{/foreach}>
				<input type="hidden" class="menu-type" name="menu_type" value="<{$menu_type}>">
			</div>

		</div>
		<div class="group_6 flex-col justify-between">
			<!-- 日期选择 -->
			<div class="date-select-box flex-row">
				<button class="date-select-item <{if $dateType == 'today'}>active<{/if}>" data-type="today">今天</button>
				<button class="date-select-item <{if $dateType == 'yesterday'}>active<{/if}>" data-type="yesterday">昨天</button>
				<button class="date-select-item <{if $dateType == 'month'}>active<{/if}>" data-type="month">本月</button>
				<button class="date-select-item <{if $dateType == 'custom'}>active<{/if}>" data-type="custom" onclick="showTimeModal()">自定义</button>
			</div>
			<div class="flex-row justify-between">
				<div class="box_1 flex-row justify-between" id="customSelect">
					<span class="text_9 current-type" data-value="order_no">订单号</span>
					<img class="thumbnail_1" referrerpolicy="no-referrer" src="<{$env.app.res_url}>/img/icon-arrow-down.png" />
		</div>
				<div class="select-options" id="selectOptions">
					<div class="option-item" data-value="order_no">订单号</div>
					<div class="option-item" data-value="channel">渠道</div>
					
					<div class="option-item" data-value="receiver_mobile">收货人手机号</div>
					
				</div>

				<div class="text-wrapper_4 flex-col">
					<input class="text_10 search-input" type="text" placeholder="请输入订单号" style="display:block">
					<div class="custom-channel-select" data-name="channel" style="display:none">
						<div class="custom-channel-select-trigger">
							<span class="custom-channel-select-value"></span>
							<img class="custom-channel-select-arrow" src="<{$env.app.res_url}>/img/icon-arrow-down.png" />
						</div>
						<div class="custom-channel-select-options">
							<{foreach from=$channel_list item=citem key=ckey}>
							<div class="custom-channel-select-option" data-value="<{$ckey}>"><{$citem}></div>
							<{/foreach}>
						</div>
					</div>
					<div class="custom-store-select" data-name="store" style="display:none">
						<div class="custom-store-select-trigger">
							<span class="custom-store-select-value"></span>
							<img class="custom-store-select-arrow" src="<{$env.app.res_url}>/img/icon-arrow-down.png" />
				</div>
						<div class="custom-store-select-options">
							<{foreach from=$store_list item=citem key=ckey}>
							<div class="custom-store-select-option" data-value="<{$ckey}>"><{$citem}></div>
							<{/foreach}>
						</div>
					</div>
				</div>
			</div>

		</div>
                    </div>
	<!-- list -->
	<div class="section_4 flex-col" id="returnList">
		<{include file="return/return_product_more.html"}>
                    </div>
                </div>
<div class="mask" id="mask"></div>
<div class="toast" id="toast"></div>
<!-- 弹窗组件 -->
<!-- 弹窗组件模板 -->
<div class="modal" id="commonModal" style="display: none;">
	<div class="modal-mask"></div>
	<div class="modal-container">
		<div class="modal-header">
			<h3 class="modal-title"></h3>
			<span class="modal-close">×</span>
    </div>
		<div class="modal-content">
			<!-- 动态内容区域 -->
        </div>
		<div class="modal-footer justify-between">
			<button class="modal-btn modal-cancle">取消</button>
			<button class="modal-btn modal-confirm">确定</button>
    </div>
	</div>
</div>
<!-- loading -->
<div class="loading-container" style="display: none;">
	<div class="loading-spinner"></div>
	<span class="loading-text">加载中...</span>
	</div>

    <{include file="store/footer.html"}>
    
<!-- 引入共用的js -->
<script src="<{$env.app.res_url}>/js/common.js"></script>

	<script>
	// 请求配置和方法封装
	const request_m = axios.create({
		baseURL: '/index.php/wap/aftersale_returnproduct', // 设置基础URL
		timeout: 10000,  // 设置超时时间
		headers: {
			'Content-Type': 'application/json'
		}
	});

	// 请求拦截器
	request_m.interceptors.request.use(
			config => {
				// 可以在这里添加loading状态
				// 添加token等通用headers
				return config;
			},
			error => {
				return Promise.reject(error);
			}
	);

	// 响应拦截器
	request_m.interceptors.response.use(
			response => {
				// 可以统一处理响应数据
				return Promise.resolve(response.data);
			},
			error => {
				// 处理网络错误
				Toast.error('网络请求失败，请稍后重试');
				return Promise.reject(error);
			}
	);

	// API 方法封装
	const api = {
		// 获取售后申请列表
		getReturns(params) {
			return request_m.post('/index', params);
		},
		// 售后申请审核
		confirmReturn(params) {
			return request_m.post('/doConfirm', params);
		},
		refuseReturn(params) {
			return request_m.post('/doRefuse', params);
		},
		refundReship(params){
			return request_m.post('/doReship', params);
		}
	};

	// 通用功能模块
	const commonFeatures = {
		// 复制功能
		initCopyFeature(container = document) {
			const copyButtons = container.querySelectorAll('.copy-btn');
			copyButtons.forEach(button => {
				button.addEventListener('click', async () => {
					const textToCopy = button.getAttribute('data-copy');
					try {
						await navigator.clipboard.writeText(textToCopy);
						showToast('复制成功');
					} catch (err) {
						this.fallbackCopy(textToCopy);
					}
				});
			});
		},

		// 降级复制方法
		fallbackCopy(text) {
			const textarea = document.createElement('textarea');
			textarea.value = text;
			textarea.style.position = 'fixed';
			textarea.style.opacity = '0';
			document.body.appendChild(textarea);

			textarea.select();
			try {
				document.execCommand('copy');
				showToast('复制成功');
			} catch (err) {
				console.error('复制失败:', err);
			}
			document.body.removeChild(textarea);
		},

		// 敏感信息切换功能
		initToggleVisibility(container = document) {
			const toggleBtns = container.querySelectorAll('.toggle-visibility');
			toggleBtns.forEach(toggleBtn => {
				const listItem = toggleBtn.closest('.list-item');
				const eyeIcon = toggleBtn.querySelector('.eye-icon');
				const sensitiveTexts = listItem.querySelectorAll('.sensitive-text');
				let isVisible = false;

				toggleBtn.addEventListener('click', function () {
					isVisible = !isVisible;

					var isdecrypt = sensitiveTexts[0].getAttribute('data-decryptAddress');
					if (isVisible && isdecrypt == 'false') {
						var ajax_url = "decryptAddress";
						var order_id = sensitiveTexts[0].getAttribute('data-orderid');
						var action = isVisible ? 'show' : 'hide';
						$.post(ajax_url, {'order_id': order_id, 'action': action }, function (rs) {
							if (rs) {
	                json = JSON.parse(rs);
								if (json.rsp == 'succ') {
									var shipMobile = json.data.ship_name + " (" + json.data.ship_mobile + ")";
									sensitiveTexts[0].setAttribute('data-decryptAddress', "true");
									sensitiveTexts[0].setAttribute('data-raw', shipMobile);
									sensitiveTexts[1].setAttribute('data-raw', json.data.ship_addr);

									sensitiveTexts.forEach(text => {
										text.textContent = isVisible ?
												text.getAttribute('data-raw') :
												text.getAttribute('data-masked');

										// 同时更新复制按钮的data-copy属性
										const copyBtn = text.nextElementSibling;
										if (copyBtn && copyBtn.classList.contains('copy-btn')) {
											copyBtn.setAttribute('data-copy', isVisible ?
													text.getAttribute('data-raw') :
													text.getAttribute('data-masked'));
										}
									});
								} else {
									showToast(json.msg);
									isVisible = !isVisible;
									eyeIcon.classList.toggle('hidden');
									eyeIcon.classList.toggle('visible');
								}
							} else {
								showToast('解密失败，请检查是否有解密额度');
								eyeIcon.classList.toggle('hidden');
								eyeIcon.classList.toggle('visible');
							}
						});
					}

					eyeIcon.classList.toggle('hidden');
					eyeIcon.classList.toggle('visible');
					sensitiveTexts.forEach(text => {
						text.textContent = isVisible ?
								text.getAttribute('data-raw') :
								text.getAttribute('data-masked');

						// 同时更新复制按钮的data-copy属性
						const copyBtn = text.nextElementSibling;
						if (copyBtn && copyBtn.classList.contains('copy-btn')) {
							copyBtn.setAttribute('data-copy', isVisible ?
									text.getAttribute('data-raw') :
									text.getAttribute('data-masked'));
						}
					});
				});

				// 添加触摸反馈
				toggleBtn.addEventListener('touchstart', function () {
					this.style.opacity = '0.7';
				});

				toggleBtn.addEventListener('touchend', function () {
					this.style.opacity = '1';
				});
			});
		},

		// 倒计时功能
		initCountdown(container = document) {
			const countdownElements = container.querySelectorAll('.countdown');

			function formatCountdown(milliseconds) {
				if (milliseconds <= 0) return '已超时';

				const seconds = Math.floor(milliseconds / 1000);
				const h = Math.floor(seconds / 3600);
				const m = Math.floor((seconds % 3600) / 60);
				const s = seconds % 60;

				return `即将超时${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
			}

			countdownElements.forEach(element => {
				const deadline = parseInt(element.getAttribute('data-deadline'));
				const timer = setInterval(() => {
					const now = Date.now();
					const remaining = deadline - now;

					if (remaining <= 0) {
						clearInterval(timer);
						element.textContent = '已超时';
						return;
					}

					element.textContent = formatCountdown(remaining);
				}, 1000);
			});
		},

		// 初始化所有功能
		initAll(container = document) {
			this.initCopyFeature(container);
			this.initToggleVisibility(container);
			this.initCountdown(container);
			toggleRemark();
		}
	};

	// 日期选择功能实现, 模拟请求

	const dateButtons = document.querySelectorAll('.date-select-item');

	dateButtons.forEach(button => {
		button.addEventListener('click', async function () {
			// 移除其他按钮的活跃状态
			dateButtons.forEach(btn => btn.classList.remove('active'));
			// 添加当前按钮的活跃状态
			this.classList.add('active');

			const dateType = this.getAttribute('data-type');
			await fetchOrdersByDate(dateType);
		});
	});

	// 获取订单数据
	async function fetchOrdersByDate(dateType) {
		try {
			const menu_type = document.querySelector('.menu-type').value;
			pageState.dateType = dateType;
			const params = {
				dateType: dateType,
				flag: 'ajax',
				// 可以添加其他参数
				page: 0,
				pageSize: 10,
				menu_type: menu_type
			};

			if (dateType != 'custom') {
				const data = await api.getReturns(params);
				// 处理返回的数据，更新页面
				$('#returnList').empty();
				$('#returnList').append(data);
				console.log('售后申请单数据:', data);
			}
		} catch (error) {
			console.log('获取售后申请单失败:', error);
		}
	}

	// 拉下框实现

	const selectBox = document.getElementById('customSelect');
	const options = document.getElementById('selectOptions');
	const currentType = selectBox.querySelector('.current-type');
	const searchInput = document.querySelector('.search-input');
	const mask = document.querySelector('.mask');
	let isOpen = false;

	function openSelect() {
		if (!isOpen) {
			options.style.display = 'block';
			mask.style.display = 'block';
			selectBox.classList.add('active');
			isOpen = true;
		}
	}

	function closeSelect() {
		if (isOpen) {
			options.style.display = 'none';
			mask.style.display = 'none';
			selectBox.classList.remove('active');
			isOpen = false;
		}
	}

	// 点击选择框
	selectBox.addEventListener('click', function (e) {
		e.stopPropagation();
		if (!isOpen) {
			openSelect();
		} else {
			closeSelect();
		}
	});

	// 点击选项
	document.querySelectorAll('.option-item').forEach(item => {
		item.addEventListener('click', function (e) {
			e.stopPropagation();
			const value = this.getAttribute('data-value');
			const text = this.textContent;

			currentType.textContent = text;
			currentType.setAttribute('data-value', value);

			const placeholders = {
				'order_no': '请输入订单号',
				'order_date': '请选择订单日期',
				'channel': '请选择渠道',
				'store_id': '请选择门店',
				'buyer_mobile': '请输入买家手机号',
				'receiver_mobile': '请输入收货人手机号',
				'express_no': '请输入快递单号',
				'return_express_no': '请输入退货物流单号'
			};
			searchInput.placeholder = placeholders[value] || '请输入搜索内容';
			if (value === 'channel') {
				showChannelSelect()
			} else {
				hideChannelSelect()
			}
			if (value === 'store_id') {
				showStoreSelect()
			} else {
				if(value !== 'channel'){
					hideStoreSelect()
				}
			}

			closeSelect();
		});
	});

	// 点击遮罩层关闭
	mask.addEventListener('click', closeSelect);

	// 点击页面其他区域关闭
	document.addEventListener('click', closeSelect);

	/* 显示门店选择 */
	function showStoreSelect() {
		const storeSelect = document.querySelector('.custom-store-select');
		storeSelect.style.display = 'block';
		const channelInput = document.querySelector('.search-input');
		channelInput.style.display = 'none';
		const channelSelect = document.querySelector('.custom-channel-select');
		channelSelect.style.display = 'none';

		// 初始化自定义门店选择组件
		initCustomStoreSelect();
	}

	/*隐藏门店选择*/
	function hideStoreSelect() {
		const storeSelect = document.querySelector('.custom-store-select');
		storeSelect.style.display = 'none';
		const channelInput = document.querySelector('.search-input');
		channelInput.style.display = 'block';
	}

	// 初始化自定义渠道选择组件
	function initCustomChannelSelect() {
		const channelSelect = document.querySelector('.custom-channel-select');
		if (!channelSelect || channelSelect.hasAttribute('data-events-bound')) {
			return;
		}

		const trigger = channelSelect.querySelector('.custom-channel-select-trigger');
		const options = channelSelect.querySelector('.custom-channel-select-options');
		const valueSpan = channelSelect.querySelector('.custom-channel-select-value');

		// 确保初始状态下拉选项是隐藏的
		channelSelect.classList.remove('active');

		// 标记为已绑定事件
		channelSelect.setAttribute('data-events-bound', 'true');

		// 默认选中第一个选项
		const firstOption = channelSelect.querySelector('.custom-channel-select-option');
		if (firstOption) {
			firstOption.classList.add('selected');
			valueSpan.textContent = firstOption.textContent;
			// 自动触发搜索
			const value = firstOption.getAttribute('data-value');
			if (value) {
				handleSearch(value);
			}
		}

		// 点击触发器切换下拉菜单
		trigger.addEventListener('click', function(e) {
			e.stopPropagation();
			channelSelect.classList.toggle('active');
		});

		// 点击选项
		const optionElements = channelSelect.querySelectorAll('.custom-channel-select-option');
		optionElements.forEach(option => {
			option.addEventListener('click', function(e) {
				e.stopPropagation();

				// 移除其他选项的选中状态
				optionElements.forEach(opt => opt.classList.remove('selected'));

				// 设置当前选项为选中状态
				option.classList.add('selected');

				// 更新显示值
				valueSpan.textContent = option.textContent;

				// 关闭下拉菜单
				channelSelect.classList.remove('active');

				// 处理搜索
				const value = option.getAttribute('data-value');
				handleSearch(value);
			});
		});

		// 点击页面其他地方关闭下拉菜单
		document.addEventListener('click', function() {
			channelSelect.classList.remove('active');
		});
	}

	// 初始化自定义门店选择组件
	function initCustomStoreSelect() {
		const storeSelect = document.querySelector('.custom-store-select');
		if (!storeSelect || storeSelect.hasAttribute('data-events-bound')) {
			return;
		}

		const trigger = storeSelect.querySelector('.custom-store-select-trigger');
		const options = storeSelect.querySelector('.custom-store-select-options');
		const valueSpan = storeSelect.querySelector('.custom-store-select-value');

		// 确保初始状态下拉选项是隐藏的
		storeSelect.classList.remove('active');

		// 标记为已绑定事件
		storeSelect.setAttribute('data-events-bound', 'true');

		// 默认选中第一个选项
		const firstOption = storeSelect.querySelector('.custom-store-select-option');
		if (firstOption) {
			firstOption.classList.add('selected');
			valueSpan.textContent = firstOption.textContent;
			// 自动触发搜索
			const value = firstOption.getAttribute('data-value');
			if (value) {
				handleSearch(value);
			}
		}

		// 点击触发器切换下拉菜单
		trigger.addEventListener('click', function(e) {
			e.stopPropagation();
			storeSelect.classList.toggle('active');
		});

		// 点击选项
		const optionElements = storeSelect.querySelectorAll('.custom-store-select-option');
		optionElements.forEach(option => {
			option.addEventListener('click', function(e) {
				e.stopPropagation();

				// 移除其他选项的选中状态
				optionElements.forEach(opt => opt.classList.remove('selected'));

				// 设置当前选项为选中状态
				option.classList.add('selected');

				// 更新显示值
				valueSpan.textContent = option.textContent;

				// 关闭下拉菜单
				storeSelect.classList.remove('active');

				// 处理搜索
				const value = option.getAttribute('data-value');
				handleSearch(value);
            });
        });
		
		// 点击页面其他地方关闭下拉菜单
		document.addEventListener('click', function() {
			storeSelect.classList.remove('active');
		});
	}

	/* 显示渠道选择 */
	function showChannelSelect() {
		const channelSelect = document.querySelector('.custom-channel-select');
		channelSelect.style.display = 'block';
		const channelInput = document.querySelector('.search-input');
		channelInput.style.display = 'none';
		const storeSelect = document.querySelector('.custom-store-select');
		storeSelect.style.display = 'none';

		// 初始化自定义渠道选择组件
		initCustomChannelSelect();
	}

	/*隐藏渠道选择*/
	function hideChannelSelect() {
		const channelSelect = document.querySelector('.custom-channel-select');
		channelSelect.style.display = 'none';
		const channelInput = document.querySelector('.search-input');
		channelInput.style.display = 'block';
	}

	// 添加滚动到激活tab的功能

	const container = document.querySelector('.tab-scroll-container');
	const activeTab = document.querySelector('.tab-active');

	if (container && activeTab) {
		// 获取容器的左边距
		const containerLeft = container.getBoundingClientRect().left;
		// 获取激活tab的左边距
		const activeTabLeft = activeTab.getBoundingClientRect().left;
		// 计算需要滚动的距离
		const scrollLeft = activeTabLeft - containerLeft - (container.offsetWidth / 2) + (activeTab.offsetWidth / 2);

		// 使用平滑滚动效果
		container.scrollTo({
			left: scrollLeft,
			behavior: 'smooth'
		});
	}

	// 初始化弹窗实例
	const modal = new Modal();

	
	// 分页相关的状态管理
	const pageState = {
		page: 1,
		pageSize: 10,
		loading: false,
		hasMore: true,
		keyword: '',
		searchType: '',
		dateType: '',
		start_time: '',
		end_time: ''
	};

	// 页面加载时初始化所有功能

	commonFeatures.initAll();

	const customSelect = document.getElementById('customSelect');
	const listContainer = document.querySelector('.section_4');

	// 初始化加载第一页数据，
	// loadOrders(); // 如果第一页还是用smarty页面数据，这个注释掉

	// 加载订单数据
	async function loadOrders(isLoadMore = false) {
		if (pageState.loading || !pageState.hasMore) return;

		try {
			pageState.loading = true;
			loading.show(isLoadMore); // 显示 loading

			// 构建请求参数
			const menu_type = document.querySelector('.menu-type').value;
			const params = {
				page: pageState.page,
				pageSize: pageState.pageSize,
				flag: 'ajax',
				menu_type: menu_type
			};

			if (pageState.keyword) {
				params.sel_type = pageState.searchType;
				params.sel_keywords = pageState.keyword;
			}
			console.log(pageState)
			if (pageState.dateType) {
				params.dateType = pageState.dateType;
				if (pageState.dateType == 'custom') {
					params.start_time = pageState.start_time;
					params.end_time = pageState.end_time;
				}
			}

			const resultHtml = await api.getReturns(params);
			console.log(resultHtml)
			// console.log(123, result.data)
			if(resultHtml.trim()===''){
				// 替换数据并滚动到顶部
				if(!isLoadMore){
					listContainer.innerHTML = resultHtml;
					window.scrollTo({
						top: 0,
						// behavior: 'smooth' // 平滑滚动效果
					});
				}

				// 如果是加载更多且没有更多数据，显示提示
				const noMore = document.createElement('div');
				noMore.className = 'loading-more';
				noMore.innerHTML = '没有更多数据了';
				document.querySelector('.section_4').appendChild(noMore);
				pageState.hasMore = false;
				return;
			}
			if (resultHtml) {
				if (isLoadMore) {
					// 追加数据
					listContainer.insertAdjacentHTML('beforeend', resultHtml);
				} else {
					// 替换数据并滚动到顶部
					listContainer.innerHTML = resultHtml;
					window.scrollTo({
						top: 0,
						// behavior: 'smooth' // 平滑滚动效果
					});
				}
				if (pageState.hasMore) {
					pageState.page++;
				} else if (isLoadMore) {
					// 如果是加载更多且没有更多数据，显示提示
					const noMore = document.createElement('div');
					noMore.className = 'loading-more';
					noMore.innerHTML = '没有更多数据了';
					document.querySelector('.section_4').appendChild(noMore);
				}

				commonFeatures.initAll(listContainer);
			}
		} catch (error) {
			console.error('加载失败:', error);
			showToast('加载失败，请重试');
		} finally {
			pageState.loading = false;
			loading.hide(); // 隐藏 loading
		}
	}

	// 处理搜索
	async function handleSearch(value) {
		// if (!value.trim()) return;

		try {
			loading.show(); // 显示 loading

			// 重置分页状态
			pageState.page = 0;
			pageState.hasMore = true;
			pageState.keyword = value;
			pageState.searchType = customSelect.querySelector('.current-type').getAttribute("data-value");

			await loadOrders();
		} catch (error) {
			console.error('搜索失败:', error);
			showToast('搜索失败，请重试');
		} finally {
			loading.hide(); // 隐藏 loading
		}
	}

	// 添加滚动监听
	function initScrollLoad() {
		let lastScrollTime = 0;
		const throttleDelay = 50; // 节流延迟时间
		let scrollTimer = null; // 新增：用于debounce的timer

		window.addEventListener('scroll', () => {
			const now = Date.now();

			// 如果正在加载或没有更多数据，直接返回
			if (pageState.loading || !pageState.hasMore) return;

			// 节流控制
			// if (now - lastScrollTime < throttleDelay) return;
			// lastScrollTime = now;

			// 清除之前的定时器
			if (scrollTimer) clearTimeout(scrollTimer);

			// 使用setTimeout进行debounce
			scrollTimer = setTimeout(() => {
				const scrollHeight = document.documentElement.scrollHeight;
				const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
				const clientHeight = document.documentElement.clientHeight;

				// 距离底部100px时开始加载
				if (scrollHeight - scrollTop - clientHeight < 100) {
					console.log('加载更多');
					loadOrders(true);
				}
			}, 100); // 100ms的防抖延迟
		});
	}

	// 初始化滚动加载
	initScrollLoad();

	// 搜索相关事件监听
	searchInput.addEventListener('keydown', function (e) {
		if (e.key === 'Enter') {
			e.preventDefault();
			handleSearch(this.value);
		}
	});

	searchInput.addEventListener('compositionend', function () {
		handleSearch(this.value);
	});

	// 下拉刷新功能
	let startY = 0;
	let distance = 0;
	const threshold = 100; // 下拉阈值

	document.addEventListener('touchstart', (e) => {
		console.log('下拉刷新');
		const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
		if (scrollTop === 0) {
			startY = e.touches[0].pageY;
		}
	});

	document.addEventListener('touchmove', (e) => {
		if (startY > 0) {
			distance = e.touches[0].pageY - startY;
			if (distance > 0 && distance < threshold) {
				// 可以添加一些视觉反馈
			}
		}
	});

	document.addEventListener('touchend', () => {
		if (distance >= threshold) {
			// 重置分页状态并重新加载
			pageState.page = 0;
			pageState.hasMore = true;
			loadOrders();
		}
		startY = 0;
		distance = 0;
	});

	// 日期选择
	function showTimeModal() {
		modal.show({
			title: '选择日期',
			fields: [
				{
					type: 'date',
					label: '开始日期',
					name: 'beginDate',
					required: true,
					placeholder: '请选择开始日期'
				},
				{
					type: 'date',
					label: '结束日期',
					name: 'endDate',
					required: true,
					placeholder: '请选择结束日期'
				}
			],
			onConfirm: async (formData) => {

				try {
					const menu_type = document.querySelector('.menu-type').value;
					pageState.dateType = 'custom';
					pageState.start_time = formData.beginDate;
					pageState.end_time = formData.endDate;
					var params = {
						"dateType": "custom",
						"flag": "ajax",
						"start_time" : formData.beginDate,
						"end_time" : formData.endDate,
						"page" : 0,
						"pageSize" : 10,
						"menu_type" : menu_type,
					};
					const data = await api.getReturns(params);
					// 处理返回的数据，更新页面
					$('#returnList').empty();
					$('#returnList').append(data);

					// 发请求
					// await api.***({
					//   ...formData
					// });
					modal.hide();

				} catch (error) {
					console.error('日期选择失败:', error);
				}
			}
		});
		// diyDatePicker.init('#datePicker');
	}
	// 添加 loading 控制函数
	const loading = {
		show(isBottom = false) {
			if (isBottom) {
				// 如果是底部加载更多，显示在列表底部
				const loadingMore = document.createElement('div');
				loadingMore.className = 'loading-more';
				loadingMore.innerHTML = '加载中...';
				document.querySelector('.section_4').appendChild(loadingMore);
			} else {
				// 居中显示的 loading
				document.querySelector('.loading-container').style.display = 'flex';
			}
		},
		hide() {
			document.querySelector('.loading-container').style.display = 'none';
			const loadingMore = document.querySelector('.loading-more');
			if (loadingMore) {
				loadingMore.remove();
			}
		}
	};

		function look_modal_logistics(return_id){


			var ajax_url = "<{$delivery_link.looklogistics}>";
			if(return_id == ""){
				alert("无效操作!");
				return false;
			}

			$.post(ajax_url, {'return_id': return_id}, function(rs) {
				if (rs) {
					json = JSON.parse(rs);
					if(json.res == 'succ'){
					modal.show({
						title: '物流轨迹',
						fields: [
							{
								type: 'html',
								html: json.html
							},
						],
						onConfirm: async (formData) => {
							try {
								modal.hide();
							} catch (error) {
								console.error( error);
							}
						}
					});

					}else{
						alert("没有找到对应物流信息");
					}
				}else {
					$(document).mobile('tips', 'show', ['没有找到对应物流信息！', 'msg']);
				}
				// $('#maskModal').mobile('modal', 'close');
			});
		}

	</script>
</body>

</html>