<!--
  Copyright Â© ShopeX ï¼ˆhttp://www.shopex.cnï¼‰. All rights reserved.
  See LICENSE file for license details.
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="./common.css" />
  <link rel="stylesheet" type="text/css" href="./delivery.css" />
  <script src="./axios.min.js"></script>
  <script src="./flexible.js"></script>
</head>

<body>
  <div class="page flex-col">
    <!-- heder -->
    <div class="section_1">
      <div class="text-wrapper_1 flex-row align-center justify-between">
        <img src="./icon-back.png" class="icon-back">
        <span class="text_1">éªŒè´§é€€æ¬¾</span>
        <img src="./icon-refresh.png" class="icon-refresh">
      </div>
    </div>
    <div class="main">
      <div class="group_2 flex-col">
        <div class="group_4 flex-row justify-between">
          <span class="text_3">ç‰©æµå…¬å¸</span>
          <div class="custom-select" data-name="express_company">
            <div class="custom-select-trigger">
              <span class="custom-select-value">åœ†é€šå¿«é€’</span>
              <img class="custom-select-arrow" referrerpolicy="no-referrer" src="./icon-arrow-down.png" />
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option" data-value="é¡ºä¸°å¿«é€’">é¡ºä¸°å¿«é€’</div>
              <div class="custom-select-option selected" data-value="åœ†é€šå¿«é€’">åœ†é€šå¿«é€’</div>
              <div class="custom-select-option" data-value="ä¸­é€šå¿«é€’">ä¸­é€šå¿«é€’</div>
            </div>
          </div>
        </div>
        <div class="group_4 flex-row justify-between">
          <span class="text_3">æœåŠ¡ç±»å‹</span>
          <div class="custom-select" data-name="express_type">
            <div class="custom-select-trigger">
              <span class="custom-select-value">æ ‡å‡†å¿«é€’2</span>
              <img class="custom-select-arrow" referrerpolicy="no-referrer" src="./icon-arrow-down.png" />
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option" data-value="æ ‡å‡†å¿«é€’1">æ ‡å‡†å¿«é€’1</div>
              <div class="custom-select-option selected" data-value="æ ‡å‡†å¿«é€’2">æ ‡å‡†å¿«é€’2</div>
              <div class="custom-select-option" data-value="æ ‡å‡†å¿«é€’3">æ ‡å‡†å¿«é€’3</div>
            </div>
          </div>
        </div>
        <div class="group_4 flex-row justify-between">
          <span class="text_3">æœˆç»“è´¦å·</span>
          <div class="custom-select" data-name="express_account">
            <div class="custom-select-trigger">
              <span class="custom-select-value">465347547658</span>
              <img class="custom-select-arrow" referrerpolicy="no-referrer" src="./icon-arrow-down.png" />
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option selected" data-value="465347547658">465347547658</div>
              <div class="custom-select-option" data-value="1">1</div>
              <div class="custom-select-option" data-value="2">2</div>
            </div>
          </div>
        </div>
        <div class="group_4 flex-row justify-between">
          <span class="text_3">å–ä»¶æ—¶é—´</span>
          <div class="custom-select" data-name="express_time" id="express_time">
            <div class="custom-select-trigger">
              <span class="custom-select-value">ç«‹å³å–ä»¶</span>
              <img class="custom-select-arrow" referrerpolicy="no-referrer" src="./icon-arrow-down.png" />
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option selected" data-value="now">ç«‹å³å–ä»¶</div>
            </div>
          </div>
        </div>
        <div class="group_4 flex-row justify-between">
          <span class="text_3">æ˜¯å¦æ‰“å°</span>
          <div class="custom-select" data-name="express_print">
            <div class="custom-select-trigger">
              <span class="custom-select-value">æ˜¯</span>
              <img class="custom-select-arrow" referrerpolicy="no-referrer" src="./icon-arrow-down.png" />
            </div>
            <div class="custom-select-options">
              <div class="custom-select-option selected" data-value="1">æ˜¯</div>
              <div class="custom-select-option" data-value="0">å¦</div>
            </div>
          </div>
        </div>
      </div>
      <!-- goodsInfo -->
      <div class="section_4 flex-col">
        <div class="list-item">
          <div class="section_6 flex-row">
            <img class="image_2" referrerpolicy="no-referrer"
              src="https://lanhu-oss.lanhuapp.com/SketchPng347d1d203f86e105cbef42b744b03da47241ba9d50ca664284da54791756c794" />
            <div class="text-group_1 flex-col">
              <div class="status-info"> <span class="text_28 flex-shrink-1">MAX&nbsp;MARAå¥³å£«è–„æ¬¾å…¨ç¾Šæ¯›LOGOå›´å·¾&nbsp;ç»¿è‰²</span>
                <!-- <span class="status-returned">å·²é€€è´§</span> -->
              </div>
              <span class="text_29">å•†å“è´§å·ï¼š787876756454</span>
              <span class="text_30">1ä»¶ï¼›é¢œè‰²ï¼šç»¿è‰²ï¼›å°ºå¯¸ï¼šM</span>
              <span class="text_31">ï¿¥1800.00</span>
            </div>

          </div>
          <div class="section_6 flex-row">
            <img class="image_2" referrerpolicy="no-referrer"
              src="https://lanhu-oss.lanhuapp.com/SketchPng347d1d203f86e105cbef42b744b03da47241ba9d50ca664284da54791756c794" />
            <div class="text-group_1 flex-col">
              <div class="status-info"> <span class="text_28 flex-shrink-1">MAX&nbsp;MARAå¥³å£«è–„æ¬¾å…¨ç¾Šæ¯›LOGOå›´å·¾&nbsp;ç»¿è‰²</span>
              </div>
              <span class="text_29">å•†å“è´§å·ï¼š787876756454</span>
              <span class="text_30">1ä»¶ï¼›é¢œè‰²ï¼šç»¿è‰²ï¼›å°ºå¯¸ï¼šM</span>
              <span class="text_31">ï¿¥1800.00</span>
            </div>
          </div>
          <div class="section_6 flex-row">
            <img class="image_2" referrerpolicy="no-referrer"
              src="https://lanhu-oss.lanhuapp.com/SketchPng347d1d203f86e105cbef42b744b03da47241ba9d50ca664284da54791756c794" />
            <div class="text-group_1 flex-col">
              <div class="status-info"> <span class="text_28 flex-shrink-1">MAX&nbsp;MARAå¥³å£«è–„æ¬¾å…¨ç¾Šæ¯›LOGOå›´å·¾&nbsp;ç»¿è‰²</span>
              </div>
              <span class="text_29">å•†å“è´§å·ï¼š787876756454</span>
              <span class="text_30">1ä»¶ï¼›é¢œè‰²ï¼šç»¿è‰²ï¼›å°ºå¯¸ï¼šM</span>
              <span class="text_31">ï¿¥1800.00</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="delivery-footer justify-between">
      <button class="delivery-footer-btn modal-confirm" onclick="submitDelivery()">å‘è´§</button>
    </div>
  </div>
  <div class="mask" id="mask"></div>
  <div class="toast" id="toast"></div>
  <!-- å¼¹çª—ç»„ä»¶ -->
  <!-- å¼¹çª—ç»„ä»¶æ¨¡æ¿ -->
  <div class="modal" id="commonModal" style="display: none;">
    <div class="modal-mask"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title"></h3>
        <span class="modal-close">Ã—</span>
      </div>
      <div class="modal-content">
        <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
      </div>
      <div class="modal-footer justify-between">
        <button class="modal-btn modal-cancle">å–æ¶ˆ</button>
        <button class="modal-btn modal-confirm">ç¡®å®š</button>
      </div>
    </div>
  </div>
  <!-- å¼•å…¥å…±ç”¨çš„js -->
  <script src="./common.js"></script>
  <script>
    // åˆå§‹åŒ–å¼¹çª—å®ä¾‹
    const modal = new Modal();
    // API æ–¹æ³•å°è£…
    const api = {
      // å‘è´§
      delivery(params) {
        return request.post('/delivery', params);
      },
      // æ‰“å°
      print(params) {
        return request.post('/print', params);
      }
    };
    // ç”Ÿæˆå–ä»¶æ—¶é—´é€‰é¡¹
    document.addEventListener('DOMContentLoaded', function () {
      const selectBox = document.getElementById('express_time');
      const optionsContainer = selectBox.querySelector('.custom-select-options');
      const now = new Date();
      const startHours = 9;
      const endHours = 21;

      for (let h = 0; h <= endHours; h++) {
        const h_str = h.toString().padStart(2, '0');
        // åˆ¤æ–­æ˜¯å¦éœ€è¦ç¦ç”¨
        const disabled_0 = h < startHours;
        const disabled_30 = (h < startHours || h === endHours);

        if (!disabled_0) {
          const option = document.createElement('div');
          option.className = 'custom-select-option';
          option.setAttribute('data-value', `${h_str}:00`);
          option.textContent = `${h_str}:00`;
          optionsContainer.appendChild(option);
        }
        if (!disabled_30) {
          const option = document.createElement('div');
          option.className = 'custom-select-option';
          option.setAttribute('data-value', `${h_str}:30`);
          option.textContent = `${h_str}:30`;
          optionsContainer.appendChild(option);
        }
      }

      // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰ç»„ä»¶
      initCustomSelects();
    })

    // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰ç»„ä»¶åŠŸèƒ½
    function initCustomSelects() {
      const customSelects = document.querySelectorAll('.custom-select');

      customSelects.forEach(select => {
        const trigger = select.querySelector('.custom-select-trigger');
        const options = select.querySelector('.custom-select-options');
        const valueSpan = select.querySelector('.custom-select-value');
        const arrow = select.querySelector('.custom-select-arrow');

        // ç‚¹å‡»è§¦å‘å™¨åˆ‡æ¢ä¸‹æ‹‰èœå•
        trigger.addEventListener('click', function(e) {
          e.stopPropagation();

          // å…³é—­å…¶ä»–å·²æ‰“å¼€çš„ä¸‹æ‹‰èœå•
          customSelects.forEach(otherSelect => {
            if (otherSelect !== select) {
              otherSelect.classList.remove('active');
            }
          });

          // åˆ‡æ¢å½“å‰ä¸‹æ‹‰èœå•
          select.classList.toggle('active');
        });

        // ç‚¹å‡»é€‰é¡¹
        const optionElements = select.querySelectorAll('.custom-select-option');
        optionElements.forEach(option => {
          option.addEventListener('click', function(e) {
            e.stopPropagation();

            // ç§»é™¤å…¶ä»–é€‰é¡¹çš„é€‰ä¸­çŠ¶æ€
            optionElements.forEach(opt => opt.classList.remove('selected'));

            // è®¾ç½®å½“å‰é€‰é¡¹ä¸ºé€‰ä¸­çŠ¶æ€
            option.classList.add('selected');

            // æ›´æ–°æ˜¾ç¤ºå€¼
            valueSpan.textContent = option.textContent;

            // å…³é—­ä¸‹æ‹‰èœå•
            select.classList.remove('active');
          });
        });
      });

      // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰ä¸‹æ‹‰èœå•
      document.addEventListener('click', function() {
        customSelects.forEach(select => {
          select.classList.remove('active');
        });
      });
    }

    // å‘è´§
    async function submitDelivery() {
      const formData = {};
      const form = document.querySelector('.group_2');
      const inputs = form.querySelectorAll('input');
      const customSelects = form.querySelectorAll('.custom-select');

      let isValid = true;

      // éå†æ‰€æœ‰è¾“å…¥æ¡†
      inputs.forEach(input => {
        const value = input.value.trim();
        const name = input.getAttribute('name');

        // éªŒè¯å¿…å¡«é¡¹
        if (!value) {
          showToast(`è¯·å¡«å†™${input.getAttribute('placeholder') || 'å¿…å¡«é¡¹'}`);
          isValid = false;
          return;
        }

        formData[name] = value;
      });

      // éå†æ‰€æœ‰è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
      customSelects.forEach(select => {
        const name = select.getAttribute('data-name');
        const selectedOption = select.querySelector('.custom-select-option.selected');

        if (!selectedOption) {
          showToast(`è¯·é€‰æ‹©${name}`);
          isValid = false;
          return;
        }

        formData[name] = selectedOption.getAttribute('data-value');
      });
      console.log("ğŸš€ğŸš€ğŸš€ ~ file: new_delivery.html:567 ~ submitDelivery ~ formData:", formData)

      if (!isValid) {
        return;
      }

      if (formData.express_print === '1') {
        // å‘é€æ‰“å°è¯·æ±‚
        try {
          const printRes = await api.print(formData);
        } catch (error) {
          console.error('æ‰“å°å¤±è´¥:', error);
          showToast('æ‰“å°å¤±è´¥');
          return;
        }
        showLoading('æ­£åœ¨æ‰“å°ä¸­...');
        // è½®è¯¢æ£€æŸ¥æ‰“å°çŠ¶æ€
        let printSuccess = false;
        let retryCount = 0;
        const maxRetries = 3; // æœ€å¤šè½®è¯¢30æ¬¡

        while (!printSuccess && retryCount < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
          try {
            const checkRes = await api.print({ ...formData, check: true });
            if (checkRes.status === 'success') {
              printSuccess = true;
              showToast('æ‰“å°æˆåŠŸ');
              break;
            }
          } catch (err) {
            console.error('æ£€æŸ¥æ‰“å°çŠ¶æ€å¤±è´¥:', err);
          }
          retryCount++;
        }

        if (!printSuccess) {
          showToast('æ‰“å°è¶…æ—¶,è¯·é‡è¯•');
          // throw new Error('æ‰“å°è¶…æ—¶,è¯·é‡è¯•'); // å¦‚æœæ‰“å°ä¸æˆåŠŸï¼Œä¸èƒ½å‘è´§ï¼Œéœ€è¦æ”¾å¼€è¿™ä¸ª
        }
        hideLoading()
      }

      // æ— è®ºæ˜¯å¦æ‰“å°æˆåŠŸï¼Œéƒ½è°ƒç”¨å‘è´§æ¥å£
      try {
        // è°ƒç”¨å‘è´§API
        await api.delivery(formData);
        showToast('å‘è´§æˆåŠŸ');
        // å…³é—­å¼¹çª—
        modal.hide();
      } catch (error) {
        console.error('å‘è´§å¤±è´¥:', error);
        showToast('å‘è´§å¤±è´¥');
      }
    }
  </script>
</body>

</html>