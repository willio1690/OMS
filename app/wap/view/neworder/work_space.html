<!--
  Copyright Â© ShopeX ï¼ˆhttp://www.shopex.cnï¼‰. All rights reserved.
  See LICENSE file for license details.
-->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
  <link rel="stylesheet" type="text/css" href="./common.css" />
  <link rel="stylesheet" type="text/css" href="./work_space.css" />
  <script src="./axios.min.js"></script>
  <script src="./flexible.js"></script>
</head>

<body>
  <div class="page flex-col">
    <!-- heder -->
    <div class="section_1">
      <div class="text-wrapper_1 flex-row align-center justify-between">
        <img src="./icon-back.png" class="icon-back">
        <span class="text_1">å·¥ä½œå°</span>
        <span></span>
        <!-- <img src="./icon-refresh.png" class="icon-refresh"> -->
      </div>
    </div>
    <div class="main">
      <!-- goodsInfo -->
      <div class="section_4 flex-col">
        <div class="list-item">
          <div class="list-item wspace-info">
            <div class="text-wrapper_5 flex-row justify-between">
              <span class="text_11">è®¢å•å·ï¼š</span>
              <span class="text_12">6942287127788887</span>
            </div>
             <div class="text-wrapper_5 flex-row justify-between">
              <span class="text_11">é—¨åº—ï¼š</span>
              <span class="text_12">ä¸Šæµ·DESCEMTE</span>
            </div>
             <div class="text-wrapper_5 flex-row justify-between">
              <span class="text_11">æ¸ é“ï¼š</span>
              <span class="text_12">æŠ–éŸ³</span>
            </div>
             <div class="text-wrapper_5 flex-row justify-between">
              <span class="text_11">å‘ç¥¨å•å·ï¼š</span>
              <span class="text_12">2542287127788887</span>
            </div>
             <div class="text-wrapper_5 flex-row justify-between">
              <span class="text_11">ä¸‹å•æ—¶é—´ï¼š</span>
              <span class="text_12">2025-05-07 18:22:22</span>
            </div>
          </div>
          <div class="section_6 flex-row">
            <img class="image_2" referrerpolicy="no-referrer"
              src="https://lanhu-oss.lanhuapp.com/SketchPng347d1d203f86e105cbef42b744b03da47241ba9d50ca664284da54791756c794" />
            <div class="text-group_1 flex-col">
              <div class="status-info"> <span class="text_28 flex-shrink-1">MAX&nbsp;MARAå¥³å£«è–„æ¬¾å…¨ç¾Šæ¯›LOGOå›´å·¾&nbsp;ç»¿è‰²</span>
                <!-- <span class="status-returned">å·²é€€è´§</span> -->
              </div>
              <span class="text_29">å•†æˆ·è´§å·ï¼š787876756454</span>
              <span class="text_30">å­è®¢å•å·ï¼š787876756454</span>
              <span class="text_30">1ä»¶ï¼›é¢œè‰²ï¼šç»¿è‰²ï¼›å°ºå¯¸ï¼šM</span>
            </div>
          </div>
          <div class="section_6 justify-between flex-wrap">
            <div class="mrg-side-4">
              <span class="text_36">ä¹°å®¶</span
              ><span class="text_37">ï¿¥1000.23</span>
            </div>
            <div class="mrg-side-4">
              <span class="text_36">ä¼˜æƒ </span
              ><span class="text_37">ï¿¥1000.23</span>
            </div>
            <div class="mrg-side-4">
              <span class="text_36">å•†å®¶</span
              ><span class="text_37">ï¿¥1000.23</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="wspace-footer justify-between">
      <button class="modal-btn modal-cancle">è¿”å›</button>
      <button class="modal-btn modal-confirm" onclick="submitDelivery()">ç¡®è®¤æ ¸é”€</button>
    </div>
  </div>
  <div class="mask" id="mask"></div>
  <div class="toast" id="toast"></div>
  <!-- å¼¹çª—ç»„ä»¶ -->
  <!-- å¼¹çª—ç»„ä»¶æ¨¡æ¿ -->
  <div class="modal" id="commonModal" style="display: none;">
    <div class="modal-mask"></div>
    <div class="modal-container">
      <div class="modal-header">
        <h3 class="modal-title"></h3>
        <span class="modal-close">Ã—</span>
      </div>
      <div class="modal-content">
        <!-- åŠ¨æ€å†…å®¹åŒºåŸŸ -->
      </div>
      <div class="modal-footer justify-between">
        <button class="modal-btn modal-cancle">å–æ¶ˆ</button>
        <button class="modal-btn modal-confirm">ç¡®å®š</button>
      </div>
    </div>
  </div>
  <!-- å¼•å…¥å…±ç”¨çš„js -->
  <script src="./common.js"></script>
  <script>
    // åˆå§‹åŒ–å¼¹çª—å®ä¾‹
    const modal = new Modal();
    // API æ–¹æ³•å°è£…
    const api = {
      // å‘è´§
      delivery(params) {
        return request.post('/delivery', params);
      },
      // æ‰“å°
      print(params) {
        return request.post('/print', params);
      }
    };
    // ç”Ÿæˆå–ä»¶æ—¶é—´é€‰é¡¹
    document.addEventListener('DOMContentLoaded', function () {
      const selectBox = document.getElementById('express_time');
      const now = new Date();
      const startHours = 9;
      const endHours = 21;

      for (let h = 0; h <= endHours; h++) {
        const h_str = h.toString().padStart(2, '0');
        // åˆ¤æ–­æ˜¯å¦éœ€è¦ç¦ç”¨
        const disabled_0 = h < startHours  ? 'disabled' : '';
        const disabled_30 = (h < startHours || h === endHours) ? 'disabled' : '';
        if (!disabled_0) {
          selectBox.innerHTML += `<option value="${h_str}:00" ${disabled_0}>${h_str}:00</option>`;
        }
        if (!disabled_30) {
          selectBox.innerHTML += `<option value="${h_str}:30" ${disabled_30}>${h_str}:30</option>`;
        }
      }
    })

    // å‘è´§
    async function submitDelivery() {
      const formData = {};
      const form = document.querySelector('.group_2');
      const inputs = form.querySelectorAll('input, select');

      let isValid = true;

      // éå†æ‰€æœ‰è¾“å…¥æ¡†å’Œä¸‹æ‹‰æ¡†
      inputs.forEach(input => {
        const value = input.value.trim();
        const name = input.getAttribute('name');

        // éªŒè¯å¿…å¡«é¡¹
        if (!value) {
          showToast(`è¯·å¡«å†™${input.getAttribute('placeholder') || 'å¿…å¡«é¡¹'}`);
          isValid = false;
          return;
        }

        formData[name] = value;
      });
      console.log("ğŸš€ğŸš€ğŸš€ ~ file: new_delivery.html:567 ~ submitDelivery ~ formData:", formData)

      if (!isValid) {
        return;
      }

      if (formData.express_print === '1') {
        // å‘é€æ‰“å°è¯·æ±‚
        try {
          const printRes = await api.print(formData);
        } catch (error) {
          console.error('æ‰“å°å¤±è´¥:', error);
          showToast('æ‰“å°å¤±è´¥');
          return;
        }
        showLoading('æ­£åœ¨æ‰“å°ä¸­...');
        // è½®è¯¢æ£€æŸ¥æ‰“å°çŠ¶æ€
        let printSuccess = false;
        let retryCount = 0;
        const maxRetries = 3; // æœ€å¤šè½®è¯¢30æ¬¡

        while (!printSuccess && retryCount < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
          try {
            const checkRes = await api.print({ ...formData, check: true });
            if (checkRes.status === 'success') {
              printSuccess = true;
              showToast('æ‰“å°æˆåŠŸ');
              break;
            }
          } catch (err) {
            console.error('æ£€æŸ¥æ‰“å°çŠ¶æ€å¤±è´¥:', err);
          }
          retryCount++;
        }

        if (!printSuccess) {
          showToast('æ‰“å°è¶…æ—¶,è¯·é‡è¯•');
          // throw new Error('æ‰“å°è¶…æ—¶,è¯·é‡è¯•'); // å¦‚æœæ‰“å°ä¸æˆåŠŸï¼Œä¸èƒ½å‘è´§ï¼Œéœ€è¦æ”¾å¼€è¿™ä¸ª
        }
        hideLoading()
      }

      // æ— è®ºæ˜¯å¦æ‰“å°æˆåŠŸï¼Œéƒ½è°ƒç”¨å‘è´§æ¥å£
      try {
        // è°ƒç”¨å‘è´§API
        await api.delivery(formData);
        showToast('å‘è´§æˆåŠŸ');
        // å…³é—­å¼¹çª—
        modal.hide();
      } catch (error) {
        console.error('å‘è´§å¤±è´¥:', error);
        showToast('å‘è´§å¤±è´¥');
      }
    }
  </script>
</body>

</html>