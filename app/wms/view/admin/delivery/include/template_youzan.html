<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

﻿<textarea id="template_select" name="template_select" style="display:none">
<{$printTmpl.template_select}>
</textarea>
<textarea id="template_data" name="template_data" style="display:none">
<{if $printTmpl.template_data}>
<{$printTmpl.template_data}>
<{/if}>
</textarea>
<input type="hidden" value="<{$printTmpl.custom_area_url}>" />
<textarea id="jsondata_newdata" style="display:none">
<{$jsondata}>
</textarea>
<script type="text/javascript">
window.addEvent('domready', function(){

        Ex_Loader('security','<{$env.BASE_URL}>/app/logisticsmanager/statics/js/printer.js?v=20210412',function(){
            var printerOpt = {};
            var waitPrintTime = 10;
            var isPrintWaybill = false;
            var waitPreviewGenerate = '预览生成中.......';
            var options = {
                data:JSON.decode($('jsondata_newdata').get('value')),
                template:$('template_data').get('value').replace('url:', ''),
                custom_template_url: "<{$printTmpl.custom_area_url}>",
                custom_data:JSON.decode('<{$printTmpl.template_select}>'),
                onDecryptStart:function(p){
                    this.decryptDialog = new Dialog(new Element("div.tableform",{html:'<div class="division"><div><h4 id="iTitle">正在数据解密，请稍等......</h4><div style="margin-left: 5px;">需处理 <span id="total">0</span> 条,已处理 <span id="iTotal" style="color:#083E96">0</span> 条。<span id="iMsg" style="color:red"></span> </div></div><div id="processBarBg" class="processBarBg"><div class="processBar" id="processBar">&nbsp;</div></div></div>'}),
                    {
                        title:'数据解密',
                        width:600,
                        height:130,
                        resizeable:false,
                    });

                    $E('#total', this.decryptDialog).setText(p.t);
                },
                onDecryptProcess:function(p){
                    $E('#iTotal', this.decryptDialog).setText(p.s);
                    $('processBar').setStyle('width',p.s/p.t*100+'%');
                },
                onDecryptComplete:function(p){
                    $E('#iTotal', this.decryptDialog).setText(p.s);
                    if (p.rsp == 'fail') {
                        $E('#iTitle', this.decryptDialog).setText('解密失败');
                        return $E('#iMsg', this.decryptDialog).setText(p.errmsg);
                    }
                    $('jsondata_newdata').setText(p.d);
                    this.decryptDialog.close();
                },
                onGetPrinters:function(data){
                    if(!data.printers || data.printers.length == 0) {
                        alert(data.msg ? data.msg : '没有打印机');
                        return null;
                    }
                    var temp = '<select id="printerlist" name="printerlist" class="x-input-select inputstyle" style="width:130px;">';
                    Object.each(data.printers,function(i,index){
                        var selected = '';

                        if (i.name.contains("<{$express_company_no}>")) {
                            selected = ' selected="selected" ';
                        } else if(i.name == data.defaultPrinter){
                            selected = ' selected="selected" ';
                        }

                        temp+='<option value="'+i.name+'" ' + selected + '>'+i.name+'</option>';
                    });
                    temp+='</select>';
                    $('printerSpan').set('html', temp);
                    $('preview_btn').addEvent('click', function() {
                        printerObj.preview.delay(waitPrintTime,printerObj,[{name:$('printerlist').value}]);
                        $('dly_printer_div').setHTML(waitPreviewGenerate);
                    });
                },
                onError:function(data){
                    var msg = (typeof data == 'object' && data.errmsg) ? data.errmsg : '与菜鸟打印组件通信失败，确认是否已安装并打开菜鸟组件,然后刷新页面';
                    $('printPreview_3_msg').setHTML(msg);
                    $('printPreview_3').style.display = 'block';
                },
                onClose:function(){
                    $$('printPreview_3_msg').setHTML('与菜鸟打印组件连接断开，请重启菜鸟打印组件,然后刷新页面');
                },
                onOpen:function(){
                    // 显示打印机
                    printerObj.getPrinters();
                },
                onPreview:function(data) {
                    if(data.status == 'failed') {
                        alert(data.msg);
                    }
                    if(data.previewImage) {
                        if($('dly_printer_div').getHTML() == waitPreviewGenerate) {
                            $('dly_printer_div').setHTML('');
                        }
                        var aTaskId = data.taskID.split('_');
                        data.previewImage.each(function(item, index, all) {
                            var previewDiv = document.createElement('div');
                            previewDiv.style.margin = '5px 10px 5px 10px';
                            previewDiv.style.border = '1px solid';
                            previewDiv.style.float = 'left';
                            previewDiv.className = 'task-' + aTaskId[0];
                            previewDiv.setHTML('<img src="' + item + '" width="400px" height="720px" />');
                            var nextIndex = '.task-'+(parseInt(aTaskId[0])+1);
                            if($E(nextIndex)) {
                                previewDiv.inject($E(nextIndex), 'before');
                            } else {
                                previewDiv.inject($('dly_printer_div'));
                            }
                        });
                    }
                },
                onPrintSuccess:function(data){
                    printFinishShow(data);
                },
                onPrintFailure:function(data){
                    printFinishShow(data);
                }
            };

            function printFinishShow(data) {
                var oHtml = $('dly_printer').getHTML();
                for (var i=0,len = data.printStatus.length; i<len; i++) {
                    var item = data.printStatus[i];
                    var dIDSplit = item.documentID.split('_', 2);
                    var msg = '<br/><span style="margin: 5px;font-weight: bold;">' + (dIDSplit[0] == 1 ? '预览' : '打印') + '</span>物流单号：' + dIDSplit[1] + ' ';
                    if (dIDSplit[0] == 0) {
                        isPrintWaybill = false;
                    }
                    if (item.status == 'success') {
                        oHtml += msg + '成功';
                    } else {
                        oHtml += msg + '失败：' + item.msg;
                    }
                }
                $('dly_printer').setHTML(oHtml);
            }

            var printerObj = initPrinter('youzan',options);

            // 解密
            printerObj.decryptAsync(5);

            if($defined($('onlyprint_btn'))) {
                $('onlyprint_btn').addEvent('click', function () {
                    if(isPrintWaybill) {
                        alert('打印中，请耐心等待');
                        return false;
                    }

                    if (printerObj.destatus != 'succ') {
                        return alert(printerObj.demsg+'，不能打印');
                    }

                    isPrintWaybill = true;
                    printerObj.print.delay(waitPrintTime,printerObj,[{name:$('printerlist').value}]);
                });
            }
            var hasprintlist=[];
            if($defined($('doprint_btn'))) {
                $('doprint_btn').addEvent('click', function(){
                    if(isPrintWaybill) {
                        alert('打印中，请耐心等待');
                        return false;
                    }

                    if (printerObj.destatus != 'succ') {
                        return alert(printerObj.demsg+'，不能打印');
                    }

                    new Dialog(new Element("div.tableform",{html:'<div id="pause" class="division">正在提交...<{img app="desktop" src="loading.gif"}></div><div class="table-action"><{button label="关闭" onclick="re_finder();"}></div>'}),{
                        title:'提示',
                        width:230,
                        height:130,
                        modal:true,
                        resizeable:false}
                    );
                    if ($('printname')) {
                        var printname= $('printname').value;
                    } else {
                        printname= '<{$vid}>';
                    }
                    if (hasprintlist.length>0){
                        for(var i=0;i<hasprintlist.length;i++){
                            if(hasprintlist[i] == printname )
                                if(confirm('您的选择含有已打印快递单，你确定要重复打印吗？')==false) {
                                    window.close();
                                }
                        }
                    }
                    hasprintlist.push(printname);

                    var printpos = '<{$printpos}>';
                    var dataType = '<{$printTmpl.template_type}>';
                    if(dataType!='delivery' && dataType!='stock') {
                        dataType = 'express';
                    }
                    new Request({url:'index.php?<{$appCtl}>&act=setPrintStatus',method:'post',
                        data:{
                            type:(dataType?dataType:'express'),
                            str:printname,
                            printpos:printpos
                        },
                        onSuccess:function(json){
                            isPrintWaybill = true;
                            if (json == '6003' && confirm('您的选择含有已打印快递单，你确定要重复打印吗？') == false) {
                                $('pause').getParent('.dialog').retrieve('instance').close();
                                return window.close();
                            }

                            if (json == '6003' || json == 'true'){

                                $('pause').getParent('.dialog').retrieve('instance').close();
                                printerObj.print.delay(waitPrintTime,printerObj,[{name:$('printerlist').value}]);

                            } else {
                                $('pause').set('text',json);
                            }
                        }
                    }).send();
                });
            }
        });
        $('printPreview_close').addEvent('click', function(){
            window.close();
        });
});
</script>
