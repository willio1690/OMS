<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<style>
    .top-fuzzy-search {
        top: 5px;
        z-index:100;
        overflow: visible;
    }
    /* .top-fuzzy-search .select-label {
        padding-top: 0px;
        padding-bottom: 0px;
    } */
    .top-fuzzy-search .select-label:after {
        top: 9px;
    }
    .top-fuzzy-search .select-dropdown {
        margin-top: 1px;
    }
    .finder-title{
      overflow: visible;
      margin-bottom: 22px;
    }
</style>
<div id='filter-list-<{$finder_id}>' class="filter-list">
    <{foreach from=$columns key=c item=v}>
    <dl k="<{$c}>" <{if $v.filtertype && $v.filterdefault}><{else}>style="display:none;"<{/if}>>
    <dt><{$v.label}><{$v.addon}>：</dt>
    <dd><{$v.inputer}></dd>
    </dl>
    <{/foreach}>
</div>

<div class="table-action" style="height:auto;padding:0;margin:0;line-height:normal">
    <{button class="btn-primary" id="filter-submit-{$finder_id}" label=$___desktop="立即筛选"|t:'desktop'}>

    <{button class="btn-secondary" id="filter-reset-{$finder_id}" label=$___desktop="清除条件"|t:'desktop'}>
</div>
<script>



    void function(){
        /** 清空所有radio的值 **/
        var radio_def = function(){
            $$('#filter-list-<{$finder_id}> input[type=radio]').each(function(item,index){
                $(item).checked = false;
            });
        }

        radio_def();

        var filter_<{$finder_id}> = new Filter('filter-list-<{$finder_id}>','<{$finder_id}>',{
            onChange:function(){



            }
        });


        $('filter-submit-<{$finder_id}>').addEvent('click',function(){

            filter_<{$finder_id}>.update();

        });



        $('filter-reset-<{$finder_id}>').addEvent('click',function(){

            reset($('filter-list-<{$finder_id}>'));
            $('filter-list-<{$finder_id}>').getElements('input.cal').each(function(dpi){
                dpi.makeCalable();
            });
            radio_def();
        });


        function reset(el){
            el.getElements('input[type=text]').each(function(item){ item.value=''; });
            el.getElements('textarea[type=textarea]').each(function(item){item.value = '';});
            el.getElements('select').each(function(item){ if(!item.getElements('option')[0].selected){ item.value = item.getElements('option')[0].value;item.fireEvent('change');}});
            el.getElements('input[type=radio]').each(function(item){ item.checked=false; });
            if(el.getElement('.object-select')){
                el.getElements('.object-select .label').each(function(label){
                    label.set('html',label.get('rel') || '').getNext('input[type=hidden]').set('value','');
                });
            }
        }

    }();



    Ex_Loader("picker",function(){
        $$('#filter-list-<{$finder_id}> input[type=text]').addEvent('keyup',function(e){

            if(e.code==13){
                $('filter-submit-<{$finder_id}>').fireEvent('click');
            }

        });

        $$('#filter-list-<{$finder_id}> input[vtype=date]').setStyles({'display':'block','margin':1});

    });

    /*
    $$('#filter-list-<{$finder_id}> dl').addEvents({
        'mouseenter':function(){this.addClass('over')},
        'mouseleave':function(){this.removeClass('over')}
    });
    */

    $ES('select[search^=1]','#filter-list-<{$finder_id}>').each(function(ipt){
        ipt.addEvent('change',function(e){
            var dl=this.getParent('dl'),field_name=$E('input[type=text]',dl).name;

            if('between'==this.value){
                var obj=dl.getElement('dd');
                this.getParent('dl').store(':dd',obj.innerHTML);
                var to=	new Element('dd',{'html':'<{t}>小于<{/t}>'+obj.innerHTML}).inject(obj,'after');
                var from=new Element('dd',{'html':'<{t}>大于<{/t}>'+obj.innerHTML}).inject(obj,'after');
                replace_name(from,'_from');
                replace_name(to,'_to');
                new Element('input',{'type':'hidden','class':'ipt','name':field_name,'value':'1'}).inject(obj,'after');
                obj.destroy();
            }else{
                if(dl.getElements('dd').length>1){
                    dl.getElements('dd').each(function(el){
                        el.empty().destroy();
                    });
                    if(dl.getElement('.ipt'))dl.getElement('.ipt').destroy();

                    new Element('dd',{'html':dl.retrieve(':dd')}).inject(dl);
                }
            }

            $(dl).getElements('input.cal').each(function(dpi){
                dpi.makeCalable();
            });

        });
    });

    var replace_name=function(box,nice){
        var n=$E('input[type=text]',box).name;
        $$(box.getElements('input'),box.getElements('select')).each(function(el){
            el.name=el.name.replace(n,n+nice);
        });
    }

    var fuzzySearch = $('filter-list-<{$finder_id}>').getElements('select[data-search="fuzzy-search"]');

    if (fuzzySearch.length > 0) {
        fuzzySearch.each(function (v) {
            var option = $(v).getElement('option');
            if (option.value == '') {
                $(option).set({
                    text: '全部',
                    value: '',
                });
            }
        });
        //fuzzySearch.setAttribute('name','shop_id[]');
        tail.select('select[data-search="fuzzy-search"]', {
            search: true,
            // width: 150,
            height: 200,
            searchMinLength: 0,
            classNames: 'top-fuzzy-search',
        });
    }
</script>