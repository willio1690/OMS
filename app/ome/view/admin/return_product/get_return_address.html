<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<style>
.processBarBg {
	border: 1px solid #999999;
	width: 98%;
	margin: 5px;
	height: 25px;
	line-height: 25px;
	padding: 1px;
	background: #EEEEEE;
}
.processBar {
	background: #3366cc;
	width: 0px;
	padding-bottom: 1px;
	overflow: hidden;
}
</style>
<div class="division">
    <table class="tableform">
        <tbody>
        <tr>
            <th>选择店铺:</th>
            <td>
                <select name="shop_id" id="shop_id">
                    <option value="">请选择</option>
                    <{foreach from=$shop item=item}>
                    <option value="<{$item.shop_id}>" <{if $item.shop_id==$select_shop_id}>selected<{/if}> ><{$item.name}></option>
                    <{/foreach}>
                </select>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<div class="division">
    <h4 style="display:none;">当前共 <span id="mtotal"></span> 个退货地址</h4>
    <div class="division" style="display:none;" id="information">
        已经拉取 <span id="iTotal" style="color:#083E96"></span> 个退货地址，其中 <span id="iFail" style="color:#083E96"></span> 个地址添加失败。<br/>
    </div>
    <div id="processBarBg" class="processBarBg">
        <div id="processBar" class="processBar">
            &nbsp;
        </div>
    </div>
    <div class="table-action">
        <{button label="开始" class="btn-primary" name="Start" id="btn-run"}>
        <{button label="关闭" class="btn-secondary" isCloseDialogBtn="true" }>
    </div>
    <div id="showError"></div>
</div>

<{if $notice}><div class="notice"><{$notice}></div><{/if}>

<script>
var finder_id = "<{$env.get.finder_id}>";

(function(){
	$('btn-run').addEvent('click', function(){
		doRun();
	});
	
	var doTotal, doFail, total, shopId;
	function doRun()
	{
		//禁用开始按钮
		doTotal = total = doFail = addForeignError = addForeignSucc = 0;
		
		//显示信息进度
		displayProcessInfo();
		
		$('information').style.display ='';
		$('btn-run').disabled = true;
		$('btn-run').set('html', '<span><span>数据处理中，请稍候！</span></span>');
		shopId = $('shop_id').value;
		
		doAjaxProcess('');
	}

	/**
	 * 执行一次AJAX调用
	 */
	function doAjaxProcess(nextPage)
	{
		new Request({url:'index.php?app=ome&ctl=admin_return_address&act=ajaxGetAddress',
			method:'post',
			data: {
				nextPage: nextPage,
				shopId: shopId,
			},
			onComplete:function(result){
				if(!result) {
					$('showError').setHTML('可能超时了，请重试');
					return;
				}
				
				var ret = JSON.decode(result);
				if(ret['err_msg']) {
					$('showError').setHTML(ret['err_msg']);
				}
				
				var nextPage = ret['next_page'];
				
				total = ret['total'];
				doTotal += ret['itotal'];
				doFail += ret['ifail'];
				
				//显示信息进度
				displayProcessInfo();
				
				if(nextPage > 0) {
					$('processBar').setStyle('width', (doTotal*100/(total)) + '%');
					
					doAjaxProcess(nextPage);
					
				} else {
					$('processBar').setStyle('width', '100%');
					
					// 判断是否弹框
					var dailogEl = $('btn-run').getParent('.dialog')
					if ($defined(dailogEl)) {
						var dailog = dailogEl.retrieve('instance');
						
						dailog.close.delay(5000,dailog);
						
						if(finder_id){
							finderGroup['<{$env.get.finder_id}>'].refresh.delay(3000,finderGroup['<{$env.get.finder_id}>']);
						}
					}
				}
			}
		}).send();
	}

	/**
	 * 显示信息进度
	 */
	function displayProcessInfo()
	{
		$('iTotal').set('html', doTotal);
		$('iFail').set('html', doFail);
		$('mtotal').set('html', total);
	}
}());
</script>