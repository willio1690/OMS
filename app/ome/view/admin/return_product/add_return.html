<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<script>
/* 销售订单快速搜索之补全搜索*/
  var options={
    'getVar':'bn',
    'fxOptions':false,
    callJSON:function(){return window.autocompleter_json;},
    injectChoice:function(json){
      var choice = new Element('li', {'html': this.markQueryValue(json[this.options.getVar])});
      choice.store('_data',json);
      choice.inputValue = json[this.options.getVar];
      this.addChoiceEvents(choice).inject(this.choices);
    },
    onHide:function(){
      if(!this.selected)return;
      var json=this.selected.retrieve('_data');
      json=$splat(json);
      init(json);
      MessageBox.success('加载订单信息成功!!');
        },
        onFocus:function(ipt){
      ipt.value='';
    }
    };
    new Autocompleter.script($E('#auto_supp input[type=text]'),"index.php?app=ome&ctl=admin_return_rchange&act=getOrderinfo&source=<{$source}>", $merge(options,{
    'getVar':'order_bn',
    selectFirst:false,
    injectChoice:function(json){

      //var order_id=json["order_id"]?"("+json["order_id"]+")":"";
      var order_id = "";

      var choice = new Element('li', {'html': this.markQueryValue(json[this.options.getVar]+order_id)});
      choice.store('_data',json);
      choice.inputValue = json[this.options.getVar];
      this.addChoiceEvents(choice).inject(this.choices);
        },
        onHide:function(){
          if(!this.selected)return;
          var json=this.selected.retrieve('_data');
          $('order_id').set("value",json["order_id"]);
          insert_return_apply(json["order_id"]);
        },
        onFocus:$empty
  }));

/* 销售订单快速搜索之通过dialog查找*/
  $E(".btn_find_order").addEvent('click',function(e){
    var url='?app=desktop&act=alertpages&goto='+encodeURIComponent("index.php?app=ome&ctl=admin_return&act=getOrders&source=<{$source}>&singleselect=1&ship_status=1&status=active");
      Ex_Loader('modedialog',function() {
      new finderDialog(url,{params:{url:'index.php?app=ome&ctl=admin_return_rchange&act=getOdersById&fullRefund=1&source=<{$source}>',name:'id',type:'radio'},handle:'supplier',width:1000,height:500,onCallback:function(e){
        insert_return_apply($('order_id').getValue());
      }});
    });
  });

  function insert_return_apply(rs){
  W.page('index.php?app=ome&ctl=admin_return&act=apply&p[0]='+rs+'&source=<{$source}>',{
     method : 'post',
     data : 'finder_id=<{$env.get.finder_id}>',
     update : $('insert_return_apply'),
     clearUpdateMap: false,
  });

  }
  /*
  function insert_return_apply(rs){
    var request = new Request.HTML({
     url : 'index.php?app=ome&ctl=admin_return&act=apply&p[0]='+rs,
     method : 'post',
     data : 'finder_id=<{$env.get.finder_id}>',
     evalScripts : true,
     update : $('insert_return_apply'),
    }).send();
  }*/

</script>

<div class="form-layout">
    <div class="form-layout-block">
        <h3>售后类型/订单</h3>
        <div class="form-layout-fields">
            <div class="form-field" style="width: 100%">
                <span class="form-field-label">查询订单号：</span>
                <div class="input-search" id="auto_supp">
                    <input style="width: 20%" class="form-input x-input" placeholder="请输入已有订单号" type="text"
                           id="supplier" value="" name="supplier" vtype="required"/>
                    <input type="hidden" name="order_id" id="order_id" value=""/>
                    <button class="pointer btn btn_find_order" title="查看订单列表">查找订单</button>
                </div>
            </div>
        </div>
    </div>
    <div class="insert-form" id="insert_return_apply">

    </div>
</div>
<style>
    .content-container {
        background: #EEF5F9;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        border-radius: 2px;
        overflow: auto;
        padding: 0;
        box-shadow: none;
    }
    .insert-form .form-custom {
        background: #eef5f9;
    }
</style>