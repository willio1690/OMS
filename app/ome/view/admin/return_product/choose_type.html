<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<div id='after-apply'>
<form action="index.php?app=ome&ctl=admin_return&act=save&p[0]=<{$status}>&finder_id=<{$finder_id}>" method="post" id="add_link">
  <div class="tableform">
    <div class="division">
      <table width="100%" border="0" cellpadding="0" cellspacing="0" class="girdlist">
        <tr>
          <input type="hidden" name="return_id" value="<{$return_id}>">
          <input type="hidden" name="status" value="3">
          <input type='hidden' name='choose_type_flag' value='1'>
          <th><{t}>请为售后单号:<{$return_bn}>,选择转换类型:<{/t}></th>
          <td>
            <select id='choose_type' name='choose_type' onchange="choosetype(this);">
            <{foreach from=$server_type item=item key=key}>
            <option value="<{$key}>"><{$item}></option>
            <{/foreach}>
            </select> <em><font color='red'>*</font></em><{help}>将改售后单转成相应的单据，以便后续处理。全额退款订单只允许申请退货单。<{/help}>
          </td>
        </tr>
      </table>
      <div class="tableform" id="refundapply" style="display:none;">
        <div id="insert_html">
             <{include file="admin/return_product/refund/detail.html" app="ome"}>
        </div>
      </div>
    </div>
    <{if $addressList}>
    <div class="division" id="address_box">
        <h3>选择退货地址信息</h3><br>
        <div id="address_list">
        <table width="100%" border="0" cellpadding="2" cellspacing="0" class="girdlist">
            <{foreach from=$addressList item=itemVal}>
            <tr>
                <{if $select_address_id}>
                <td><input type="radio" <{if $itemVal['contact_id']==$select_address_id}>checked="checked"<{/if}> name="address_id" value="<{$itemVal.contact_id}>"></td>
                <{else}>
                <td><input type="radio" <{if $itemVal['cancel_def']=='true'}>checked="checked"<{/if}> name="address_id" value="<{$itemVal.contact_id}>"></td>
                <{/if}>
                <td><{$itemVal.contact_name}></td>
                <td><{if $itemVal.mobile_phone}><{$itemVal.mobile_phone}><{else}><{$itemVal.phone}><{/if}></td>
                <td><{$itemVal.province}> <{$itemVal.city}> <{$itemVal.country}></td>
                <td><div style="width:260px; overflow:hidden; text-overflow:ellipsis; white-space: nowrap;"><a title="<{$itemVal.addr}>"><{$itemVal.addr}></a></div></td>
            </tr>
            <{/foreach}>
        </table>
        </div>
    </div>
    <{/if}>
  </div>

<div class="table-action" id="table-action">
  <{button label="确定" class="btn-primary" onclick="sub_form(event);"}> &nbsp; &nbsp;
  <{button label="关闭" class="btn-secondary" isCloseDialogBtn="true"}>
</div>
</form>
</div>
<script>
var return_type = '<{$return_type}>';

var source ='<{$reship.source}>';
function sub_form(event) {
    $('add_link').fireEvent('submit',new Event(event));
}

function choosetype(obj){
   if(obj.value == '3'){
       $('refundapply').setStyle('display','block');
       $('refundapply').getElements('input,select,textarea').set('disabled',false);
   }else{
       $('refundapply').setStyle('display','none');
       $('refundapply').getElements('input,select,textarea').set('disabled',true);
   }
}
var choose_type_value = '<{$choose_type_value}>';
if (choose_type_value>0)
{
    $('choose_type').getElement('option[value='+choose_type_value+']').selected=true;
    choosetype($('choose_type'));

}

if (return_type == 'return')
{
    $('choose_type').getElement('option[value=1]').selected=true;
}else if(return_type == 'change'){
    $('choose_type').getElement('option[value=2]').selected=true;
}else if(return_type == 'refund'){
    $('choose_type').getElement('option[value=3]').selected=true;
    choosetype($('choose_type'));
}

$('add_link').store('target',{
    onComplete:function(resp){
        resp = JSON.decode(resp);
        if (resp.error)
        {
            return false;
        }
        if($('add_link').getParent('.dialog')){
            window.finderGroup['<{$finder_id}>'].refresh.delay(400,finderGroup['<{$finder_id}>']);
        }

        var choose_type = $E('#add_link select[name="choose_type"] option:selected').get('value');
        if (choose_type!=3) {
          var title = ''; var type = '';
          if (choose_type == 1) {
            title = '编辑退货单';
            type = 'return';
          }else if(choose_type==2){
            title = '编辑换货单';
            type = 'change';
          }

          var return_id = $E('#add_link input[name="return_id"]').get('value');

          /*弹出编辑窗*/
          new Request.HTML({
            url:'index.php?app=ome&ctl=admin_return&act=gotoreceipt&p[0]='+return_id+'&p[1]='+type+'&finder_id=<{$finder_id}>',
            update:$('after-apply'),
            onComplete:function(){
              var dialog = $('after-apply').getParent('.dialog').retrieve('instance');
              dialog.setTitle(title);
              dialog.setDialogWidth();
            }
          }).send();
        }else{
            if (resp.success){
                var dialog = $('after-apply').getParent('.dialog').retrieve('instance');
                dialog.close();
            }
        }

    }
});

</script>    

