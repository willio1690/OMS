<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<div class="tableform">
    <h4>
        淘宝凭证查看 
        <input type="button" id='return_message' name='return_message' value='下载淘宝凭证'>
    </h4>
<{if $refundinfo.online_memo}>
 <table width="100%" border="0" cellpadding="0" cellspacing="0" class="gridlist"><tbody><tr><td>
 
  <{foreach from=$refundinfo.online_memo item=memo}>
<{$memo.created}>&nbsp;&nbsp; <{$memo.content}><{if $memo.voucher_urls}><br><img src='<{$memo.voucher_urls}>' height='50' onclick="showimage('<{$memo.voucher_urls}>')" alt='点击查看大图' style="cursor:pointer;"><{/if}><br>
<{/foreach}>
 </td></tr></tbody></table>
 <{/if}>
 </div>

<{if $refundinfo.product_data}>
<div class="tableform">
<h4>申请商品明细</h4>
 
  <table width="100%" border="0" cellpadding="0" cellspacing="0" class="gridlist">
<tbody>
<tr><th>基础物料编码</th><th>价格</th><th>数量</th></tr>
<{foreach from=$refundinfo.product_data item=product_data}>
<tr><td><{$product_data.bn}></td><td><{$product_data.price}></td><td><{$product_data.num}></td></tr>
<{/foreach}>
</tbody>
</table>
</div>
<{/if}>
<div class="tableform"><h4>标签:<font color='red'>
<{foreach from=$refundinfo.tag_list.tag item=tag_list}>
<{$tag_list.tag_name}>
<{/foreach}></font></h4> 

<table width="100%" border="0" cellpadding="0" cellspacing="0" class="gridlist">
<tbody>
<tr><th>支付宝交易号</th><th>会员ID</th><th>卖家ID</th> <th>当前状态超时时间</th></tr>
<tr><td><{$refundinfo.alipay_no}></td><td><{$refundinfo.buyer_nick}></td><td><{$refundinfo.seller_nick}></td>
<td><{$refundinfo.current_phase_timeout|date_format:'%Y-%m-%d'}></td>
</tr>
</tbody>
</table>

</div>
<{if $refundinfo.refund_type=='return'}>
<div class="tableform">
<table width="100%" border="0" cellpadding="0" cellspacing="0" class="gridlist">
<tbody>
<tr><td><span style='font-weight:bold;color:red'>由于两边订单发货状态不一致，所以此单如果接受申请请在线上操作</span></td>
</tr>
</tbody>
</table>

</div>
<{/if}>
<script>
if ($('return_message'))
{
	$('return_message').addEvent('click',function(e){
		var url = 'index.php?app=ome&ctl=admin_return&act=refund_message&p[0]=<{$refundinfo.apply_id}>&p[1]=refund&finder_id=<{$env.get.finder_id}>&shop_type=tmall';
    new Dialog(url,{title:'淘宝凭证',width:500,height:300});
	
	});
}
function showimage(imgpath){

    var url = 'index.php?app=ome&ctl=admin_return&act=showImage&p[0]='+imgpath;
    new Dialog(url,{title:'查看凭证大图',width:500,height:300});
}
<{if $opt}>
var opt = JSON.decode('<{$opt|json_encode}>');
//卖家发起拦截
if(opt.operation.APPLY_DELIVERY_INTERCEPT_V2) {
    var oTd = new Element('td', {html: '<{button type="button" label="拦截包裹"}>'});
    oTd.getElement('button').addEvent('click', function() {
        var str = '请您在5天内自行拦截快递并完成退款，系统将告知买家正在拦截，如果超时内没有任何操作，则自动同意退款，打款给买家。';
        if(confirm(str)) {
            new Request.JSON({
                url: 'index.php?app=ome&ctl=admin_refund_apply&act=intercept',
                data: {
                    'apply_id' : '<{$refundinfo.apply_id}>',
                    'refund_version' : opt.refund_version
                },
                onComplete: function(rsp) {
                    if(rsp.rsp == 'succ') {
                        MessageBox.show('操作完成');
                    } else {
                        alert('操作失败:'+rsp.msg);
                    }
                }
            }).send();
        }
    });
    $('refund-apply-opt-btn-tr').adopt(oTd);
}
//卖家发起协商退货退款
if(opt.operation.NEGOTIATE_TO_RETURN_AND_REFUND) {
    var oTd = new Element('td', {html: '<{button type="button" label="协商退货退款"}>'});
    oTd.getElement('button').addEvent('click', function() {
        new Dialog('index.php?app=ome&ctl=admin_refund_apply&act=negotiatereturnRender', {
            title: '协商退货退款',
            ajaxoptions: {
                method: 'post',
                data: {
                    'apply_id' : '<{$refundinfo.apply_id}>',
                    'refund_version' : opt.refund_version
                }
            }
        });
    });
    $('refund-apply-opt-btn-tr').adopt(oTd);
}
if(opt.operation.SELLER_REFUSE) {
    if($E('.refuse-apply-btn')) {
        $E('.refuse-apply-btn').addClass('btn-danger');
    }
} else {
    if($E('.refuse-apply-btn')) {
        $E('.refuse-apply-btn').setStyle('display', 'none');
    }
}
if(opt.not_operation) {
    Object.each(opt.not_operation, function(item) {
        if(item.operation_text) {
            var oTd = new Element('td', {html: '<{button type="button" disabled="disabled" title="'+item.tips+'" label="'+item.operation_text+'"}>'});
            $('refund-apply-opt-btn-tr').adopt(oTd);
        }
    });
}
<{/if}>
</script>