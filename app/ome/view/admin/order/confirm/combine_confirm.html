<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<style>
#present .seemingly-orders .hightshop{
background:#4b88cf;color:#ffffff;font-weight:700;
}
#present .seemingly-orders .hightship_name{
background:#4b88cf;color:#ffffff;font-weight:700;
}
#present .seemingly-orders .hightaddress{
background:#5ab6d8;color:#ffffff;font-weight:700;
}
#present .seemingly-orders .mastOrderAddress td{
background:#9ec9fb;font-weight:700;
}
</style>

<div id="present">
    <div class="finder-detail"><table class="nosplit gridlist clear finder-detail" width="100%" cellspacing="0" cellpadding="0" border="0" >
        <thead>
            <tr>
                <th style="width:10%;nowarp:true;background:#9ec9fb;">选择</th>
                <th style="width:7%;background:#9ec9fb;">订单号</th>
                <th style="width:5%;background:#9ec9fb;">付款状态</th>
                <th style="width:9%;background:#9ec9fb;">下单至今</th>
                <th style="width:20%;background:#9ec9fb;">客服备注</th>
                <th style="width:15%;background:#9ec9fb;">客户留言</th>
                <th style="width:5%;background:#9ec9fb;">配送方式</th>
                <th style="width:5%;background:#9ec9fb;">旗标</th>
                <th style="width:5%;background:#9ec9fb;">订单金额</th>
                <th style="width:5%;background:#9ec9fb;">支付金额</th>
                <th style="width:5%;background:#9ec9fb;">配送费用</th>
                <th style="width:5%;background:#9ec9fb;">标识</th>
                <th style="width:16%;background:#9ec9fb;">操作</th>
            </tr>
        </thead>
        <col></col>
        <tbody id="orderNode">
            <{foreach from=$combineOrders item=order key=orderId}>
            <!-- 可合并订单 -->
            <{if $orderId == $order_id }>
            <{include file="admin/order/confirm/combine_order.html"}>
            <{/if}>
            <{/foreach}>

        </tbody>
    </table></div>
    <div style="padding: 5px;" id="orderCombineTxt">
        <span style="font-weight:700;font-size:14px;">可合并订单</span>   &nbsp;&nbsp;
        <span style="border:1px solid #607fbc;background-color:#829fd8;color:#ffffff;cursor:pointer;margin: 5px 5px 3px; padding: 8px;font-weight:700;font-size:12px;"   id='addressOrderTitle'>与主单收货地址一致</span>
        <span style="border:1px solid #d2d6dc; margin: 5px 5px 3px; padding: 8px;background-color:#f2f7f9;color:#000000;cursor:pointer;font-weight:700;font-size:12px;" id='memberOrderTitle'>与主单同店铺同用户订单</span>
    </div>
    <div class="finder-detail" id="orderCombineNode"><table class="nosplit gridlist clear" width="100%" cellspacing="0" cellpadding="0" border="0" >
        <thead>
            <tr>
                <th style="width:10%;nowarp:true;background:#9ec9fb;"><input type="checkbox" id="checkcombineorder"></th>
                <th style="width:7%;background:#9ec9fb;">订单号</th>
                <th style="width:5%;background:#9ec9fb;">付款状态</th>
                <th style="width:9%;background:#9ec9fb;">下单至今</th>
                <th style="width:20%;background:#9ec9fb;">客服备注</th>
                <th style="width:15%;background:#9ec9fb;">客户留言</th>
                <th style="width:5%;background:#9ec9fb;">配送方式</th>
                <th style="width:5%;background:#9ec9fb;">旗标</th>
                <th style="width:5%;background:#9ec9fb;">订单金额</th>
                <th style="width:5%;background:#9ec9fb;">支付金额</th>
                <th style="width:5%;background:#9ec9fb;">配送费用</th>
                <th style="width:5%;background:#9ec9fb;">标识</th>
                <th style="width:16%;background:#9ec9fb;">操作</th>
            </tr>
        </thead>
        <col></col>
        <tbody id="orderCombineTbody">
            <{foreach from=$combineOrders item=order key=orderId}>
            <!-- 可合并订单 -->
            <{if $order.isCombine && $orderId != $order_id}>
            <{include file="admin/order/confirm/combine_order.html"}>
            <{/if}>
            <{/foreach}>

        </tbody>
 
        <tbody class='master_order_match seemingly-orders'> 
             <tr class="mastOrderAddress"> 
                <td>疑可合订单</td>
                <td colspan="2" style="text-align:left;">
                    <{$shopInfo.name}>
                </td>
                <td>
                    <{$member.account.uname|default:'无用户'}>
                </td>
                <td colspan="3" style="text-align:left;">
                    <{$curorder.consignee.name}>&nbsp;&nbsp;<{$curorder.consignee.area|region}> <{$curorder.consignee.addr}>&nbsp;&nbsp;(<{$curorder.consignee.mobile}>)
                </td>
                <td colspan="6" style="font-weight:bold;">主单收货地址</td>
            </tr>
        </tbody>

        <{foreach from=$combineOrders item=order key=orderId}>
            <{if !$order.isCombine && $orderId != $order_id}>
                <{if ($combine_addressconf_mobile==0 && $curorder.shop_id == $order.shop_id) && ($curorder.consignee.area != $order.consignee.area || $curorder.consignee.addr != $order.consignee.addr || $curorder.consignee.name != $order.consignee.name || $curorder.consignee.mobile != $order.consignee.mobile)}>

                    <{assign var="sameMemOrder" value=true}>

                <{elseif ($combine_addressconf_mobile==1 && $curorder.shop_id == $order.shop_id) && ($curorder.consignee.area != $order.consignee.area || $curorder.consignee.addr != $order.consignee.addr || $curorder.consignee.name != $order.consignee.name )}>

                    <{assign var="sameMemOrder" value=true}>

                <{else}>           

                    <{assign var="sameAddrOrder" value=true}>

                <{/if}>
                <tbody class='seemingly-orders <{if $sameMemOrder }>memberorder<{else}>addressorder<{/if}>'>
                    <{include file="admin/order/confirm/combine_order.html"}>
                </tbody>
            <{/if}>
        <{/foreach}> 
    </table></div>
</div>

<script>
    function update(order_id){
          var finder_id = '<{$finder_id}>';
          new Request({
             url:'index.php?app=ome&ctl=admin_order&act=update_type',
             method:'get',
             onComplete:function (rs){
              console.info(rs);
                var rs = JSON.decode(rs);
                if (rs.data.edit_type == 'local')
                {
                    _open( 'index.php?app=ome&ctl=admin_order&act=view_edit&p[0]='+order_id+'&finder_id='+finder_id+'&filter=<{$filter}>');
                }else{
                    _open( 'index.php?app=ome&ctl=admin_order&act=update_iframe&p[0]='+order_id+'&finder_id='+finder_id);
                }            
             }
          }).send('p[0]='+order_id);
    }

    $E('#present .master_order_match').hide();
    var sameAddOrder = $ES('#present .addressorder');
    if ($defined(sameAddOrder) && sameAddOrder.length > 0) {
        var sameAddOrderTitle = '与主单收货地址一致 <font color="#fffd54">(共'+sameAddOrder.length+'单)</font>';
        var sameAddOrderBtn = $('addressOrderTitle');
        sameAddOrderBtn.setHTML('隐藏' + sameAddOrderTitle);
        sameAddOrderBtn.show();
        sameAddOrder.show();
        sameAddOrderBtn.addClass('active');
        sameAddOrderBtn.addEvent('click',function(){
            if (this.hasClass('active')){
                sameAddOrder.hide();
                this.removeClass('active');
                sameAddOrderBtn.setHTML('查看' + sameAddOrderTitle);
            } else {
                sameAddOrder.show();
                this.addClass('active');
                sameAddOrderBtn.setHTML('隐藏' + sameAddOrderTitle);
            }

            if ($('memberOrderTitle').hasClass('active') || $('addressOrderTitle').hasClass('active')) {
                $E('#present .master_order_match').show();
            } else {
                $E('#present .master_order_match').hide();
            };
        });
    };

    var sameMemOrder = $ES('#present .memberorder');
    if ($defined(sameMemOrder) && sameMemOrder.length > 0) {
        var sameMemOrderTitle = '与主单同店铺同用户订单 <font color="#dd1d1d">(共'+sameMemOrder.length+'单)</font>';
        var sameMemOrderBtn = $('memberOrderTitle');
        sameMemOrderBtn.setHTML('隐藏' + sameMemOrderTitle);
        sameMemOrderBtn.show();
        sameMemOrder.show();
        sameMemOrderBtn.addClass('active');
        sameMemOrderBtn.addEvent('click',function(){
            if (this.hasClass('active')){
                sameMemOrder.hide();
                this.removeClass('active');
                sameMemOrderBtn.setHTML('查看' + sameMemOrderTitle);
            } else {
                sameMemOrder.show();
                this.addClass('active');
                sameMemOrderBtn.setHTML('隐藏' + sameMemOrderTitle);
            }
            
            if ($('memberOrderTitle').hasClass('active') || $('addressOrderTitle').hasClass('active')) {
                $E('#present .master_order_match').show();
            }else{
                $E('#present .master_order_match').hide();
            };
        });

    };

    function copy_txt(name) {
         var idInput = name + '_input';
        $(name).style.display = 'none';
        $(idInput).style.display = '';
        $(name + '_ci').value = $(name).title;
    }

    function copy_finsh(name) {
        var idInput = name + '_input';
        $(name).style.display = '';
        $(idInput).style.display = 'none';
    }

    function seemingly_hight (_this) {
        var order_id = _this.value;
        var has_shopname = _this.get('has_shopname');
        var has_member_id = _this.get('has_member_id');
        var has_address = _this.get('has_address');
        var has_mobile = _this.get('has_mobile');
        if(_this.checked==true){
            has_mobile==1 ? $('highmobile'+order_id).addClass('hightshop'): '';
            has_shopname==1 ? $('hightshop_name'+order_id).addClass('hightshop'): '';
            has_member_id==1 ? $('hightship_name'+order_id).addClass('hightship_name'): '';
            has_address==1 ? $('hightaddress'+order_id).addClass('hightaddress') : '';
        }else{
            has_mobile==1 ? $('highmobile'+order_id).removeClass('hightshop'): '';
            has_shopname==1 ? $('hightshop_name'+order_id).removeClass('hightshop'): '';
            has_member_id==1 ? $('hightship_name'+order_id).removeClass('hightship_name') : '';
            has_address==1 ? $('hightaddress'+order_id).removeClass('hightaddress') : '';
        }
    }
    if($('orderCombineNode') && !$('orderCombineNode').getElements('INPUT[name="orderIds[]"]').length) {
        $('orderCombineNode').style.display = 'none';
        $('orderCombineTxt').style.display = 'none';
    }
    $('checkcombineorder').addEvent('click', function() {
        var oCheck = this.checked;
        $$('.combineorder').each(function(item) {
            if(!item.getElement('input[type=checkbox]')) {
                return;
            }
            if(oCheck) {
                item.getElement('input[type=checkbox]').checked=true;
            } else {
                item.getElement('input[type=checkbox]').checked=false;
            }
        });
        reWriteProductNode();
    });
</script>