<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<style>
    .processBarBg {
        border: 1px solid #999999;
        width: 98%;
        margin: 5px;
        height: 25px;
        line-height: 25px;
        padding: 1px;
        background: #EEEEEE;
    }
    .processBar {
        background: #3366cc;
        width: 0px;
        padding-bottom: 1px;
        overflow: hidden;
    }
</style>
<div class="division">
    <table class="tableform">
        <tbody>
        <tr>
            <th>店铺:</th>
            <td><input type="hidden" name="shop_id" id="shop_id" value="<{$shopInfo.shop_id}>" /><{$shopInfo.name}></td>
        </tr>
        <tr style="display:none;">
            <th>商品状态:</th>
            <td>
                <select name="goods_type" id="goods_type">
                    <{foreach from=$goods_type item=item}>
                    <option value="<{$item.key}>"><{$item.value}></option>
                    <{/foreach}>
                </select>&nbsp;&nbsp;<{help}>*默认拉取全部商品，有的平台不支持按上架、下架状态拉取，例如：得物平台。<{/help}>
            </td>
        </tr>
        <tr style="display:none;">
            <th>开始时间:</th>
            <td><{input type='date' vtype='date' name='start_time' id="start_time" value=$start_time}>&nbsp;&nbsp;<{help}>*结束时间不需要选择，默认为当前时间（注：得物平台不支持按时间范围拉取商品）。<{/help}></td>
        </tr>
        <tr>
            <th>出价类型:</th>
            <td>
                <select name="bidding_type" id="bidding_type">
                    <option value="normal">普通现货</option>
                    <option value="brand">品牌专供</option>
                    <option value="ppzf">品牌直发</option>
                    <option value="7">极速现货</option>
                </select>&nbsp;&nbsp;<{help}>*出价类型只适用于得物平台。注意：拉取出价时会过滤掉merchant_sku_code字段为空的数据,所以实际保存个数可能与界面获取个数不一致。<{/help}>
            </td>
        </tr>
        </tbody>
    </table>
</div>
<div class="division">
    <h4>当前共<span id="mtotal"></span>个商品</h4>
    <div class="division" style="display:none;" id="information">
    已经拉取 <span id="iTotal" style="color:#083E96"></span> 个商品，<br/>
        其中 <span id="iFail" style="color:#083E96"></span> 个商品添加失败，<br/>
    </div>
    <div id="processBarBg" class="processBarBg">
        <div id="processBar" class="processBar">
            &nbsp;
        </div>
    </div>
    <div class="table-action">
        <{button label="开始" class="btn-primary" name="Start" id="btn-run"}>
        <{button label="关闭" class="btn-secondary" isCloseDialogBtn="true" }>
    </div>
    <div id="showError"></div>
</div>

<{if $notice}><div class="notice"><{$notice}></div><{/if}>

<script>
var finder_id = "<{$env.get.finder_id}>";
(function(){
    $('btn-run').addEvent('click', function(){
        doRun();
    });
    
    var doTotal, doFail, total, shopId, goodsType, startTime;
    
    function doRun()
    {
        //禁用开始按钮
        doTotal = total = doFail = addForeignError = addForeignSucc = 0;
        displayProcessInfo();
        $('information').style.display ='';
        $('btn-run').disabled = true;
        $('btn-run').set('html', '<span><span>数据处理中，请稍候！</span></span>');
        shopId = $('shop_id').value;
        goodsType = $('goods_type').value;
        startTime = $('start_time').value;
        biddingType = $('bidding_type').value;
        
        doAjaxProcess('');
    }
    
    /**
     * 执行一次AJAX调用
     */
    function doAjaxProcess(nextPage) {
        new Request({url:'index.php?app=inventorydepth&ctl=shop&act=ajaxDownloadAllGoods',
            method:'post',
            data: {
                nextPage: nextPage,
                shopId: shopId,
                goodsType: goodsType,
                startTime: startTime,
                biddingType: biddingType,
            },
            onComplete:function(result){
                if(!result) {
                    $('showError').setHTML('可能超时了，请重试');
                    return;
                }
                var ret = JSON.decode(result);
                if(ret['err_msg']) {
                    $('showError').setHTML(ret['err_msg']);
                    // return;
                }
                var nextPage = ret['next_page'];
                
                total = ret['total'];
                doTotal += ret['itotal'];
                doFail += ret['ifail'];
                displayProcessInfo();
                
                if(nextPage > 0) {
                    $('processBar').setStyle('width', (doTotal*100/(total)) + '%');
                    doAjaxProcess(nextPage);
                } else {
                    $('processBar').setStyle('width', '100%');
                    
                    // 判断是否弹框
                    var dailogEl = $('btn-run').getParent('.dialog')
                    if ($defined(dailogEl)) {
                        var dailog = dailogEl.retrieve('instance');

                        dailog.close.delay(5000,dailog);
                        
                        if(finder_id){
                            finderGroup[finder_id].refresh.delay(3000,finderGroup[finder_id]);
                        }
                        
                    }
                }
            }
        }).send();
    }

    /**
     * 显示信息进度
     */
    function displayProcessInfo()
    {
        $('iTotal').set('html', doTotal);
        $('iFail').set('html', doFail);
        $('mtotal').set('html', total);
        
        // $('ForeignSucc').set('html', addForeignSucc);
        // $('ForeignError').set('html', addForeignError);
    }
}());
</script>