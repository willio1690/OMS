<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<{input type="checkbox" name="checkAll" id="checkAll"}>全选
<input type='hidden' id='sequence'/>
<div id='region-treelist-loading'></div>
<div id='region-treelist' class='x-tree-list'></div>
<script>
    Ex_Loader('<{$env.BASE_URL}>/app/eccommon/statics/js/treelist.js',function(){
        var RegionList=TreeList;

        var selected_area = JSON.decode('<{$selected_area}>');
        var parent_path = JSON.decode('<{$parent_path}>');

        RegionList=new Class({
            Extends:TreeList,
            createNode:function(data,ext){
                var options=this.options;
                var nc=options.nodeClass;
                nc.icon = '';
                var node_handle=new Element('span',{'class':nc.handle})
                    .set({'pid':data['PID'],
                        'nid':data['NID'],
                        'hasc':data['HASC']
                    })
                    .setHTML('&nbsp;');
                var node_line=new Element('span',{'class':nc.nl}).setHTML('&nbsp;');

                var node_checkbox=new Element('input',{
                    type:'checkbox',
                    name:"address[]",
                    value:data['NID'],
                    pid:data['PID'],
                    checked:Object.contains(selected_area, data['NID']) ? true : false
                });

                var node_icon=new Element('span',{'class':nc.icon}).setHTML('&nbsp;');
                var node_name=new Element('span',{'class':nc.name}).setText(data['CNAME']);

                var node=new Element('span',{'class':nc.clazz})
                    .adopt([node_handle,node_line,node_checkbox,node_icon,node_name]);
                if(!!data['HASC'].toInt()){
                    var _this=this;
                    node_handle.addClass(nc.close);
                    node_checkbox.set('value',node_checkbox.get('value'));
                    node_handle.addEvent('click',function(e){
                        var node=this.getParent('.'+nc.clazz);
                        if(this.hasClass(nc.close)){
                            if(!node.getNext()||node.getNext().getTag()!=='div'){
                                var ncontainer=new Element('div',{'class':nc.cbox}).injectAfter(node);
                                _this.loadNodes(this.get('nid'),ncontainer);
                                this.addClass(nc.loading);
                                node_checkbox.set('value',node_checkbox.get('value').toInt());

                            }else{
                                if(node.getNext()&&node.getNext().getTag()=='div'){
                                    node.getNext().show();
                                }
                            }
                            this.removeClass(nc.close);
                        }else{
                            if(node.getNext()&&node.getNext().getTag()=='div'){
                                node.getNext().hide();
                                this.addClass(nc.close);
                            }
                        }
                    });
                }
                var checkPNode=function(cnode,checked){
                    var pnode=cnode.getParent().getPrevious();
                    while(pnode.hasClass(nc.hasc)){
                        pnode.getElement('input[type=checkbox]').set('checked',checked);
                        pnode=pnode.getParent().getPrevious();
                    }
                };

                $('checkAll').addEvent('click',function(){
                    return node_checkbox.set('checked',this.checked?true:false);
                });

                node_checkbox.addEvent('click',function(rc){

                    var node=this.getParent('.'+nc.clazz);
                    var nodeNext=node.getNext();
                    var nodebox=node.getParent();
                    if(nodeNext&&nodeNext.getTag()=='div'){
                        $ES('input[type=checkbox]',nodeNext).set('checked',this.checked==true?true:false);
                    }
                    if(this.checked==false) {
                        var nPid = this.getAttribute('pid');
                        var oInput = $E('input[type="checkbox"][name="address[]"][value="'+nPid+'"]')
                        if(oInput){
                            oInput.set('checked', false);
                            var nPid = oInput.getAttribute('pid');
                            var oInput = $E('input[type="checkbox"][name="address[]"][value="'+nPid+'"]')
                            if(oInput){
                                oInput.set('checked', false);
                            }
                        }
                        $('checkAll').set('checked', false);
                    }
                });

                //编辑时展开
                if(Object.contains(parent_path, data['NID'])){
                    node_checkbox.store('check',true);
                    node_checkbox.store('open',node_handle);
                }

                return node;
            },addNode:function(node,container){
                if(!container)
                    $(node).inject(this.container);
                else
                    $(node).inject(container);

                var ckbox=node.getElement('input[type=checkbox]');
                if(ckbox&&ckbox.retrieve('check')){
                    ckbox.set('checked',false);
                    if(Object.contains(selected_area, ckbox.value)){
                        ckbox.set('checked',true);
                    }
                    ckbox.retrieve('open',{fireEvent:function(){}}).fireEvent('click',200);
                }
            }
        });

        new RegionList({
            remoteURL:'index.php?app=eccommon&ctl=regions&act=getRegionById&{param}={value}',
            remoteParamKey:'p[0]',
            container:'region-treelist',
            checkboxName:'region',
            showStep:1,
            dataMap:{
                PID:'p_region_id',
                NID:'region_id',
                CNAME:'local_name',
                HASC:'child_count'
            }
        });
    });
</script>

