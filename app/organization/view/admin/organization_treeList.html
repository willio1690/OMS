<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<form action="" id="catEditor" method="post" target="">
  <table cellspacing="0" cellpadding="0" class="gridlist">
    <col class="Colauto"></col>
    <col class="Coloption_1b"></col>
    <col class="Coloption_1b"></col>
    <col></col>
    <thead>
      <th><{t}>组织名称<{/t}></th>
      <th><{t}>状态<{/t}></th>
      <th><{t}>操作<{/t}></th>
      <th></th>
    </thead>
    <tbody>
      <{if $organization}> 
      <{foreach from=$organization item=item key=iLoop name="item"}>
      <tr parentid="<{$item.org_id}>" class="provice-bg">
        <td style="text-align:left; width:320px;">
          <div style="padding-left:<{$item.step*25}>px">
            <{if $item.child_count>0}>
            <span class="imgTree" onclick="clickTree(this);" id="org_<{$item.org_id}>" data-parent='true' data-orgid="<{$item.org_id}>"> &nbsp;&nbsp; </span>
            <{else}>
            <span class="imgTree tree_open"> &nbsp;&nbsp; </span>
            <{/if}>
            <span style="font-weight:700; color:#000; text-decoration:none;padding-right:15px;" ><{$item.org_name}></span>
          </div>
        </th>
        <{if $item.status == 2}>
         <td style="width:60px;"><span>停用</span></Td>
        <{/if}>
        <{if $item.status == 1}>
        <td style="width:60px;"><span>启用</span></Td>
        <{/if}>
        <td style="width:350px">
            <{if $item.status == 2}>
                <a href="javascript:W.page('index.php?app=organization&ctl=admin_management&act=doActiveGropItem&org_id=<{$item.org_id}>', $extend({method: 'get'}, JSON.decode({})), this);setTimeout('location.reload()',500);void(0);" target="">启用</a>
            <{/if}>
            <{if $item.status == 1}>
                <a href="javascript:if(confirm('确认停用该组织？')){W.page('index.php?app=organization&ctl=admin_management&act=doUnactiveGropItem&org_id=<{$item.org_id}>', $extend({method: 'get'}, JSON.decode({})), this);setTimeout('location.reload()',500);}void(0);" target="">停用</a>
                &nbsp;|&nbsp;<a class="i" href='index.php?app=organization&ctl=admin_management&act=addChildGropItem&org_id=<{$item.org_id}>' target="dialog::{title:'<{t}>添加下级组织架构 <{/t}>',width:800,height:300}">添加下级</a>
            <{/if}>
            &nbsp;|&nbsp;<a class="i" href='index.php?app=organization&ctl=admin_management&act=editGropItem&org_id=<{$item.org_id}>&from_page_act=org_show' target="dialog::{title:'<{t}>组织架构 <{/t}>',width:800,height:300}">编辑</a>
            &nbsp;|&nbsp;<a href="javascript:if(confirm('确认删除该组织？')){W.page('index.php?app=organization&ctl=admin_management&act=doDelGropItem&org_id=<{$item.org_id}>', $extend({method: 'get'}, JSON.decode({})), this);setTimeout('location.reload()',500);}void(0);" target="">删除</a>
            
            <{if $item.child_count>0}>
            &nbsp;|&nbsp;<a href="javascript:void(0);" id="show_all_but_<{$item.org_id}>" data-orgid="<{$item.org_id}>" onclick="spreadAll(this)">展开全部</a>
            <{/if}>
        </td>
        <td></td>
      </tr>
      <{/foreach}>
      <{/if}>
    </tbody>
  </table>
</form>

<script>
function clickTree(el){
    var el=$(el), obj = el.getParent('[parentid]');
    
    var org_id = el.get("data-orgid");
    
    var is_parent = false;
    if(el.get("data-parent"))
    {
        is_parent = (el.get("data-parent") == 'true' ? true : false);
    }
    
    if(!el.hasClass("tree_open")){
        if(!obj.getNext() || !obj.getNext().get('readstatus')){
            var tr=new Element('tr[readstatus=1]').injectAfter(obj).setHTML('<td colspan="5" style="border:0;padding:0;"></td>');
            W.page('index.php?app=organization&ctl=admin_management&act=getChildNode',{update:tr.firstChild,method:'post',data:'orgId='+org_id});
        }
        obj.getNext().show();
        el.addClass("tree_open");
        
        if(is_parent)
        {
            $("show_all_but_"+ org_id).addClass('show_tree');
            $("show_all_but_"+ org_id).set('html', '隐藏全部');
        }
    }else{
        obj.getNext().hide();
        el.removeClass("tree_open");
        
        if(is_parent)
        {
            $("show_all_but_"+ org_id).removeClass('show_tree');
            $("show_all_but_"+ org_id).set('html', '展开全部');
        }
    }
}
function spreadAll(el)
{
    var el=$(el), obj = el.getParent('[parentid]');
    
    var org_id = el.get("data-orgid");
    
    if(!el.hasClass("show_tree")){
        if(!obj.getNext() || !obj.getNext().get('readstatus')){
            var tr=new Element('tr[readstatus=1]').injectAfter(obj).setHTML('<td colspan="5" style="border:0;padding:0;"></td>');
            W.page('index.php?app=organization&ctl=admin_management&act=getAllChildNode',{update:tr.firstChild,method:'post',data:'orgId='+org_id});
        }
        obj.getNext().show();
        
        el.setHTML('隐藏全部');
        el.addClass("show_tree");
        
        $("org_"+ org_id).addClass('tree_open');
    }else{
        obj.getNext().remove();
        
        el.removeClass("show_tree");
        el.setHTML('展开全部');
        
        $("org_"+ org_id).removeClass('tree_open');
    }
}
</script>
