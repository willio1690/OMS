<!--
  Copyright © ShopeX （http://www.shopex.cn）. All rights reserved.
  See LICENSE file for license details.
-->

<{capture name="header"}>
<{css app="ome" src="ome.css"}>
<{css app="ome" src="style.css"}>
<{script src="coms/autocompleter.js" app="desktop"}>
<{script src="coms/pager.js" app="desktop"}>
<{/capture}>
<style>
    .notice-inline.error  {background-image:none;margin-left:25px}
</style>
<form method="post" id="fm1" action="index.php?app=console&ctl=admin_purchase&act=doSaveReplenishment">
    <div class="tableform">
        <h3>新建采购补货订单</h3>
        <div class="division">
            <h5>基本信息</h5>
            <table border="0" cellspacing="0" cellpadding="0" class="gridlist">
                <thead>
                <tr>
                    <td width="10%" align="right" nowrap="nowrap">
                        采购单名称：
                    </td>
                    <td >
                        <span id="exigence" style="color:red; display:none">！</span>
                        <input type="text" size="32"  id="purchase_name" name="purchase_name" value="<{$cur_date}>" />
                        <input type="checkbox" name="emergency"  onchange="chgexigence(this);" value="true" />紧急采购：
                    </td>
                    <td width="10%" align="right" >
                        关联原采购单：
                    </td>
                    <td>
                        <{$po_info.name}>（<{$po_info.po_bn}>）
                    </td>
                </tr>

                <tr>
                    <td align="right">供应商：</td>
                    <td width="40%"><{$supplier.name}></td>
                    <td width="10%" align="right">采购方式：</td>
                    <td>
                        <{if $po_info.po_type=='cash'}>现购<{/if}>
                        <{if $po_info.po_type=='credit'}>赊购<{/if}>
                        <input type="hidden" name="type" value="<{$po_info.po_type}>"   />

                    </td>
                </tr>
                <tr>
                    <td align="right">到货仓库：</td>
                    <td>
                        <{$branch_info.name}>
                        <input type="hidden" name="branch" value="<{$branch_info.branch_id}>" />

                    </td>
                    <td align="right" nowrap="nowrap" title="一次性物流费用">物流费用：</td>
                    <td><input type="text" vtype="number" name="d_cost" size="6"/>
                        元</td>
                </tr>
                <tr>
                    <td align="right">
                        <span class="endd" <{if $po_info.po_type=='cash'}>style="display:none"<{/if}> >预付款：</span>
                    </td>
                    <td>
                        <span class="endd" <{if $po_info.po_type=='cash'}>style="display:none"<{/if}>><input type="hidden"  value="<{$po_info.deposit_balance}>" name="price" size="6"/><{$po_info.deposit_balance}> 元</span>
                    </td>
                    <td align="right" nowrap="nowrap">
                        预计到货天数：
                    </td>
                    <td>
                        <input type="hidden" id="arrive" name="arrive" value="" />
                        <input class='x-input' type="text" size="2" id="arrive_days" name="arrive_days"  onchange="pushDate(this);" maxlength="3" /> 天　
                        <b id="pushdate"></b>
                    </td>

                </tr>
                </thead>
            </table>
            <h5 style="margin-top:10px;">采购商品</h5>

            <{button label="基础物料库频道" id="purchase-find-btn" }>

            <table class="gridlist" id="purchase_table"  style="margin:4px 0;">
                <thead>
                <tr>
                    <th><input type="checkbox" class='selectall' onclick="this.blur()"></th>
                    <th>物料编码</th>
                    <th style="width:240px;">物料名称</th>
                    <th>物料规格</th>
                    <th>条形码</th>
                    <th>采购进价</th>
                    <th>数量</th>
                    <th>单价</th>
                    <th>合计</th>
                    <th style="width:30px;">删除</th>
                </tr>
                </thead>
                <tbody id="dataNode">
                <tr>
                    <td colspan="10" style="padding:0;"><div class="note" style="margin:0;"> 暂无采购货品信息 </div></td>
                </tr>
                </tbody>
            </table>
            <div align="right">
                购买总量: <span id="buy_count">0</span>
                总金额: <span id="buy_amount">0</span> &nbsp;
                <{button label="删除选中" id="purchase-del-btn"}> &nbsp;
                <{button type="button" id="purchase-delall-btn" label="全部删除" }>
            </div>
        </div>
        <table width="100%" border="0" cellpadding="0" cellspacing="0" style="margin-top:10px;">
            <{if $po_info.memo}>
            <tr>
                <td width="10%" align="right">关联采购单备注：</td>
                <td align="left"><{foreach from=$po_info.memo item=items}>
                    <b><{$items.op_content|escape:"HTML"}></b>
                    <{$items.op_time}> by <{$items.op_name}><br/>
                    <{/foreach}></td>
            </tr>
            <{/if}>
            <tr>
                <td width="10%" align="right">备注:</td>
                <td align="left"><textarea id="memo" maxth="255" rows="3" cols="80%" name="memo" type="textarea"></textarea></td>
            </tr>
            <tr>
                <td align="right">经办人:</td>
                <td align="left"><input name="operator" type="text" value="<{$po_info.operator}>" size="15" vtype="required"/></td>
            </tr>
        </table>
        <div id="cc" class="noprint table-action">
            <{button type="button" id="purchase-save-btn" label="保 存"}> &nbsp;
            <{button type="button" class="btn-secondary" id="return-btn" label="关 闭" onclick="javascript:void(window.close());"}>
            <{button type="button" class="btn-secondary" id="return-btn" label="返回上一级" onclick="javascript:history.go(-1);"}>
        </div>
    </div>
    <input type="hidden" name="origin_po_id" value="<{$po_info.po_id}>"/>
</form>
<script>
    var pag;
    var _next_key = next_key =  product_id = last_key = null;
    var callurl='index.php?app=console&ctl=admin_purchase&act=getOriginalPurchaseItems&po_id='+<{$po_info.po_id}>,store=[],rows;
    var init_goods_data = '<{$po_items}>';
    function emptyData(){
        var noData='<tr>'+
            '<td colspan="10" style="padding:0;"><div class="note" style="margin:0;"> 暂无采购货品信息 </div></td>'+
            '</tr>';
        $('dataNode').set('html',noData);
    }

    var tpl='<tr key="{product_id}" id="product_{product_id}" title="点击选取/反选此条记录">'+
        '<td><input type="checkbox" class="product_select"></td>  <td>{bn}</td><td class="product-name" visibility="{visibility}">{name}</td><td>{spec_info}</td><td>{barcode}</td><td>{purchasing_price}</td>'+
        '  <td><input type="text" value="{num}" key="num" max="{num}" tname="at[_PRIMARY_]" size="6"></td>'+
        '  <td><input type="text" vtype="number&amp;&amp;required" disabled  tname="pr[_PRIMARY_]" key="price" value="{price}" size="8">元</td>'+
        '  <td class="count">{count}</td>'+
        '  <td><{img src="bundle/delecate.gif" app="desktop" key="state" class="pointer btn-delete-item"}></td>'+
        '</tr>';

    function chgexigence(o){
        o.checked?$("exigence").show():$("exigence").hide();
    }
    function pushDate(o){
        if(o.value!==""){
            if(/^\d*$/.test(o.value)){
                if (o.getNext('.error')) o.getNext('.error').dispose();
                var ftime = new Date(Date.parse(new Date())+86400000 * o.value.toInt());
                var realtime = ftime.getFullYear()+'-'+(ftime.getMonth()+1)+'-'+ftime.getDate()+' '+ftime.toLocaleTimeString();
                $("pushdate").set("text",realtime);
                //$("arrive").set("value", new Date(new Date.parse(new Date())+86400000 * o.value)) ;
            }
            else o.value="";
        }
        else $("pushdate").empty();
    }


    init_goods_data = JSON.decode(init_goods_data);
    init(init_goods_data);

    function createProduct(data){
        pag=new PageData(tpl,data,{'updateMain':$('dataNode'),'pageNum':10000,
            'format': function(d) {
                d.count = (d.num * d.price).toFixed(3);
                d['price'] = (d.price * 1).toFixed(3);
            },
            'onShow':function(){
                var _this=this;
                /*$$('#dataNode input[type]').addEvent('change',function(e){
                    var pid=this.getParent('tr').get('key'),value=this.value;
                    _this.editData(pid,[this.get('key'),value]);
                });*/
                $$('#dataNode input[tname$="[_PRIMARY_]"]').each(function(item){
                    item.store('initval',item.value).addEvent('change',function(e){
                        var patten,
                            parent = this.getParent('tr'),
                            pid= parent.get('key'),
                            value= this.value,
                            max = this.get('max').toInt()
                        if(value > max){
                            value = max;
                            MessageBox.error(_this.selectData(pid).name+'\n\r最大数量不能超过 '+max);
                            this.set('value',max);
                        }
                           var diffval = this.retrieve('initval') - value;

                        if (/^at\[/.test(this.get('tname'))){
                            patten = /^[1-9]\d*$/;
                        }else{
                            patten = /^\d+(\.*)\d*$/;
                        }


                        if(!patten.test(value)){
                            this.focus();
                            this.select();
                            return MessageBox.error('输入格式有误！');
                        }

                        this.store('initval', value);
                        _this.editData(pid,[this.get('key'),value]);

                        var count = parent.getElement('td.count'),
                            num = _this.selectData(pid).num.toInt(),
                            pr = (_this.selectData(pid).price.toFloat() * 1).toFixed(3),
                            sums = (num * pr).toFixed(3);



                        if(this.get('key') == 'price') {
                            this.set('value',pr);
                        }
                        count.set('text',sums);
                        _this.editData(pid,['count',sums]);
                        if (/^at\[/.test(this.get('tname'))){

                            $('buy_count').set('text', $('buy_count').get('text') - diffval);
                            $('buy_amount').set('text', ($('buy_amount').get('text') - diffval * pr).toFixed(3));
                        }else{
                            $('buy_amount').set('text', ($('buy_amount').get('text') - diffval * num).toFixed(3));
                        }
                    });
                });
                /*var state=this.curdata.every(function(d){return d['state']=='checked';});
                $('purchase-delall-btn').checked=!state?false:true;
                attachEsayCheck($('dataNode'),'input[type=checkbox]');*/
                $$('#dataNode tr').each(function(item,i){
                    item.addEvent('click',function(e){
                        //e.stop();
                        if(_next_key){
                            $E('#product_'+_next_key).set('style','');
                            delete _next_key;//马上删除这个临时变量
                        }
                        this.toggleClass('selected');
                        _this.selectData(this.get('key')).selected = _this.selectData(this.get('key')).selected && _this.selectData(this.get('key')).selected === true ? false : true;

                        var selectflag = _this.selectData(this.get('key')).selected;
                        var selectproduct = item.getElement('.product_select');
                        if (selectflag)
                        {
                            selectproduct.set('checked','checked');
                        }else{
                            selectproduct.set('checked','');
                        }
                    });
                    item.getElement('.btn-delete-item').addEvent('click',function(e){
                        e.stop();
                        product_id = 'product_'+item.get('key');
                        _next_key = $$('#'+product_id+'+tr').get('key');

                        if(_this.selectData(item.get('key')) && confirm('确定要删除 '+ _this.selectData(item.get('key'))['name'] +' 吗？')){
                            compute(item);
                            _this.delData(item.get('key'));

                            if(isNaN(_next_key) == false){
                                next_key = 'product_'+_next_key;
                                $E('#'+next_key).set('style','background:none repeat scroll 0 0 #6699FF;color:#FFFFCC');
                            }else{
                                _next_key = null;
                            }
                            product_id =  next_key = null;

                        }
                        if(!$E('#dataNode tr')) emptyData();
                    });
                    item.getElement('input[tname^=at]').addEvent('enter',function(e){
                        $E('#pfba input').focus();
                    });
                });

                //var len = this.data.length ? (this.data.length > this.options.pageNum ? (this.options.current == this.getTotal() ? this.data.length-this.options.pageNum*(this.options.current-1) : this.options.pageNum) : this.data.length) : 0;
                if(this.data.length) {
                    $E('#dataNode input[key^=num]').focus();

                }

                (function(){
                    var sum = 0, amounts = 0;
                    _this.data.each(function(d,i){
                        sum += _this.selectData(d['product_id']).num.toInt();
                    });
                    $('buy_count').set('text',sum);

                    $$('#dataNode td.count').each(function(item,i){
                        amounts += parseFloat(item.get('text'));
                    });
                    $('buy_amount').set('text',amounts.toFixed(3));
                }).delay(100);

                $ES('.product-name').each(function(item){
                    if (item.get('visibility')=='false')
                    {
                        item.setStyle('color','#808080');
                    }
                });
                $ES('.product-name').removeEvent('mouseover').addEvent('mouseover',function(e){
                    if (this.get('visibility')=='false')
                    {
                        var e  = new Event(e), el = e.target;
                        visiTips.attach(el);
                        el.addEvent('mouseleave',function(){
                            this.removeClass('active');
                        });
                        el.fireEvent('mouseenter',e);
                    }
                });
            }
        });
    }


    $('purchase-find-btn').addEvent('click',function(e){
        var url='index.php?app=desktop&act=alertpages&goto='+encodeURIComponent('index.php?app=console&ctl=admin_purchase&act=findMaterial&po_id='+<{$po_info.po_id}>);
        Ex_Loader('modedialog',function() {
            new finderDialog(url,{params:{url:callurl,name:'product_id[]'},width:1000,height:660,
                onCallback:function(rs){
                    if(!rs)return;
                    rs=JSON.decode(rs);
                    console.log(rs)
                    init(rs);
                }});
        });
    });

    function init(rs){
        var tmparr=findProduct(rs,'product_id');
        store.unshift.apply(store,tmparr);
        createProduct(store);
    }
    function findProduct(arr,PRIMARY){
        if(!store.length)return arr;
        store.each(function(a){
            arr.each(function(b){
                if(a[PRIMARY]==b[PRIMARY])arr.erase(b);
            });
        });
        return arr;
    }


    $E('.selectall').addEvent('click',function(e){

        if (this.checked)
        {
            $ES('.product_select').set('checked','checked');
            $$('.product_select').each(function(item){
                protr = item.getParent('tr');
                product_id = protr.get('key');
                protr.addClass('selected');
                pag.selectData(product_id).selected=true;

            });
        }else{
            $ES('.product_select').set('checked','');
            $$('.product_select').each(function(item){
                protr = item.getParent('tr');
                product_id = protr.get('key');
                protr.removeClass('selected');
                pag.selectData(product_id).selected=false;

            });
        }



    });

    function compute(e){
        var num = e.getElement('input[tname="at[_PRIMARY_]"]').value.toInt();
        var pr = e.getElement('input[tname="pr[_PRIMARY_]"]').value.toFloat();
        var sum = num * pr;
        $('buy_count').set('text',$('buy_count').get('text') - num);
        $('buy_amount').set('text',($('buy_amount').get('text') - sum).toFixed(3));
    }

    $('purchase-del-btn').addEvent('click',function(e){
        if(!pag||!pag.data)return;
        var delarr=[];
        pag.data.each(function(d,i){
            if(pag.selectData(d['product_id']).selected && pag.selectData(d['product_id']).selected === true) delarr.push(d['product_id']);
        });
        //获取批量删除中的最后一个节点
        last_key =  	$$('.selected').getLast();
        last_key = last_key.get('key');

        if(delarr.length){
            if(confirm('确认删除选定的采购商品吗？')){
                var nums=0,prices=0,sums=0;
                delarr.each(function(id,i){
                    nums += pag.selectData(id).num.toInt();
                    prices += pag.selectData(id).price.toFloat();
                    sums += pag.selectData(id).num.toInt() * pag.selectData(id).price.toFloat();
                });
                product_id = 'product_'+last_key;
                //找到本次批量删除最后一条记录下面的那条记录
                _next_key = $$('#'+product_id+'+tr').get('key');

                $('buy_count').set('text',$('buy_count').get('text') - nums);
                $('buy_amount').set('text',($('buy_amount').get('text') - sums).toFixed(3));
                delProduct(pag,delarr);

                if(isNaN(_next_key) == false){
                    next_key = 'product_'+_next_key;
                    //对本次批量删除最后一条记录下面的那条记录，颜色加深提示
                    $E('#'+next_key).set('style','background:none repeat scroll 0 0 #6699FF;color:#FFFFCC');
                }else{
                    _next_key = null;
                }
                product_id = next_key=last_key = null;

            }
            if(!$E('#dataNode tr')) emptyData();
        }
        else MessageBox.error("请先选择欲删除的采购商品！");
    });

    function delProduct(obj,arr){
        arr.each(function(d){obj.delData(d);});
    }

    $('purchase-delall-btn').addEvent('click',function(e){
        if(!pag||!pag.data)return;
        var delarr=[];
        pag.data.each(function(d){
            delarr.push(d['product_id']);
        });
        if(delarr.length && confirm('确认删除全部采购商品吗？')){
            delProduct(pag,delarr);
            $('buy_count').set('text',0);
            $('buy_amount').set('text',0);
            emptyData();
        }
    });

    $('purchase-save-btn').addEvent('click',function(e){
        var _this=this;
        var form=this.getParent('form');
        if(pag){
            var data=pag.toHideInput($('dataNode').getElement('tr'));
            form.store('target',{extraData:data,
                onRequest:function(){
                    _this.disabled=true;
                },
                onComplete:function(jsontext){
                    try{
                        var json = JSON.decode(jsontext);
                        if (typeof(json.error)!='undefined'){
                            _this.disabled=false;
                        }else{
                            _this.disabled=true;
                            if(opener.finderGroup['<{$env.get.finder_id}>']) opener.finderGroup['<{$env.get.finder_id}>'].refresh.delay(100,opener.finderGroup['<{$env.get.finder_id}>']);
                            setTimeout('window.close()',200);
                        }
                    }catch(e){}
                }
            });
        }
        form.fireEvent('submit',e);
    });
</script>